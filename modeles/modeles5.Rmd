---
title: "Fiche de modélisations n°5"
subtitle : "Analyses factorielles de l'espace de la pauvreté"
author: |
    | Kim Antunez
automaticcontents: true
output:
  html_document:
    theme: cosmo
    css: style.css
    toc: true
    self_contained: true
    number_sections: true
    fig_width: 10
    fig_height: 5
    fig_caption: true
---

```{r setup, echo=FALSE, cache=FALSE}
library(knitr)
#library(rmdformats)

## Global options
#options(max.print="75")
opts_chunk$set(echo=TRUE,
	             cache=FALSE,
               prompt=FALSE,
               tidy=FALSE,
               comment=NA,
               message=FALSE,
               warning=FALSE
               )
options(knitr.kable.NA = '')
#opts_knit$set(width=75)
```


# Objectif

L'objectif de cette cinquième série de modèles est de commencer à approcher la notion d'espace social grâce à des analyses factorielles (ACM).

# Analyses


::: {.encadre width="100%"}

L'espace social des pauvretés **monétaire**, **institutionnelle** et **subjective** des données du Baromètre se structure en deux principaux axes avec un **effet Guttmann** très clair qui signifie simplement une forte liaison entre les différentes réponses de l'enquête. En quelques sortes, toutes les modalités sont prises par les mêmes individus typiques à droite et à gauche. 

Cet effet oppose traditionnellement deux axes avec un premier axe de niveau et un second qui oppose les situations médianes et extrêmes : 


|       | Gauche / Bas                           | Droite / Haut                                 |
|-------|----------------------------------------|-----------------------------------------------|
| **Axe 1** | Richesse  (objective et ressentie) | Pauvreté (objective et ressentie)       |
| **Axe 2** (artificiel) |   Situation médiane en termes de pauvreté  | Situation extrême

On voit nettement que le **sentiment de pauvreté se situe à droite** et le **sentiment de risque de pauvreté se situe en bas**, arguments qui permettent de conforter l'interprétation faite de ces axes. Finalement, c'est le bas de l'effet Guttmann qu'il est souvent intéressant d'analyser, c'est-à-dire ici le risque de pauvreté future qui concernent les gens avec niveaux de vie intermédiaires, situés entre richesse et pauvreté.

Voir les résultats statistiques plus bas.

:::

# Code et résultats

```{r}
#chargement des packages
library(knitr)
library(dplyr) #manipuler les bases de données
library(FactoMineR) #pour les analyses factorielles
library(explor) #contient FactoMineR
library(RColorBrewer) #palettes de couleur
library(fastcluster) #pour la CAH
library(ade4) #pour la fonction s5 de plot des classes de CAH
library(poLCA) #pour les Latent Categorical Variables (pour utiliser les graphs à batons)
library(ggplot2) #pour les graphiques statiques
library(ggrepel) #pour les étiquettes ggplot2

```

```{r, echo=FALSE}
bdd <- readRDS("../data/2019/barometre2000_2019_diff.rds") %>% 
  filter(annee%in%2015:2019) #NEW : 2015 à 2019

revenus_a_imputer <- bdd %>%
mutate(sdrevcl = ifelse(sdrevcl==999999999,NA,sdrevcl)) %>%
group_by(sdrevtr) %>% 
summarise(sdrevcl = mean(sdrevcl,na.rm=TRUE))

bdd <- bdd %>%   mutate(
    sdrevcl_imput_moy = case_when(
      sdrevcl!=999999999 ~ sdrevcl,
      sdrevcl==999999999 & sdrevtr==1 ~ revenus_a_imputer$sdrevcl[1],
      sdrevcl==999999999 & sdrevtr==2 ~ revenus_a_imputer$sdrevcl[2],
      sdrevcl==999999999 & sdrevtr==3 ~ revenus_a_imputer$sdrevcl[3],
      sdrevcl==999999999 & sdrevtr==4 ~ revenus_a_imputer$sdrevcl[4],
      sdrevcl==999999999 & sdrevtr==5 ~ revenus_a_imputer$sdrevcl[5],
      sdrevcl==999999999 & sdrevtr==6 ~ revenus_a_imputer$sdrevcl[6],
      sdrevcl==999999999 & sdrevtr==7 ~ revenus_a_imputer$sdrevcl[7]
             )
  )

bdd <- bdd %>% 
   mutate(seuil_pauvrete = do.call(c,lapply(annee,function(annee_selec){
0.6*median(bdd[bdd$annee==annee_selec,"sdrevcl_imput_moy"]/bdd[bdd$annee==annee_selec,"sduc"],
           na.rm=TRUE)
}
))) %>% 
  mutate(subj_inf_mini_decla = factor(
     sdrevcl_imput_moy - ifelse(pe16==999999999,NA,pe16) <0,
     levels=c(TRUE,FALSE),
     labels=paste0("-",c("Rev. inf. au minimum décla.","Rev. sup. au minimum décla.")))
     ) %>% 
  mutate(subj_pauvrete = 
           ifelse(pe3==3, TRUE,ifelse(pe3==4,NA,FALSE))) %>% 
  mutate(subj_risque_pauvrete = 
           ifelse(pe3==1, TRUE,ifelse(pe3==4,NA,FALSE))) %>% 
   mutate(subj_pauvrete_et_risque = 
           factor(
           ifelse(pe3==4, NA, ifelse(pe3==1,2,ifelse(pe3==2,1,3))),
           labels=c("Non pauvre","Risque pauvreté futur", "Déjà pauvre"))
         ) %>% 
  mutate(subj_besoin_aide_etat =
           ifelse(pe15==2, TRUE,ifelse(pe15==4,NA,FALSE))) %>%
  mutate(obj_pauvrete= sdrevcl_imput_moy/sduc<seuil_pauvrete)

bdd <- bdd %>% 
  mutate(
    prof_exercee_ou_derniere = case_when(
      sdpcs7%in%c(1,2) ~ "Agriculteurs, artisans et commerçants",
      sdpcs7%in%c(3) ~ "Cadre supérieur, profession libérale",
      sdpcs7%in%c(4) ~ "Profession intermédiaire",
      sdpcs7%in%c(5) ~ "Employé",
      sdpcs7%in%c(6) ~ "Ouvrier",
      sdpcs7%in%c(7) ~ "Autres (n'ayant jamais travaillé)"
    )
  ) %>% 
  mutate(
    activite_actuelle = case_when(
      sdsitua==4 ~ "Chômeur",
      sdsitua==6 ~ "Retraité",
      (sdsitua==1 & sdstatemp!=1) | sdsitua%in%c(2,3) ~
        "Emploi précaire/temps partiel",
      TRUE #sdsitua%in%c(5,7) | (sdsitua==1 & sdstatemp==1) incomplet
      ~
        "Autres (CDI à temps plein, étudiants en formations et personnes n'ayant jamais travaillé)"
    )
  )%>% 
  mutate(
    PCS_recode = case_when(
      prof_exercee_ou_derniere%in%c("Employé","Ouvrier") & activite_actuelle=="Emploi précaire/temps partiel" ~
        "Employés et ouvriers\nprécaires ou\ntemps partiels",
      prof_exercee_ou_derniere%in%c("Employé","Ouvrier") & activite_actuelle=="Retraité" ~
        "Employés et ouvriers\nà la retraite", #sdsitua==6
      prof_exercee_ou_derniere%in%c("Employé","Ouvrier") & activite_actuelle=="Chômeur"  ~
        "Employés et ouvriers\nau chômage",
      sdsitua==1 & !(prof_exercee_ou_derniere%in%c("Employé","Ouvrier") & activite_actuelle=="Emploi précaire/temps partiel") ~ "En emploi à temps plein",
      sdsitua%in%c(7)  ~ "Sans activité\nprofessionnelle",
      TRUE                      ~  "Autres"
    )
  ) %>% 
  mutate(
    sitfam = case_when(
      sdsitfam==2 ~ "Membre du couple",
      sdsitfam==1 ~ "Vie seule",
      sdsitfam==3 ~ "Famille monoparentale",
      sdsitfam%in%c(4,5,6,7) ~ "Autre situation (enfant de la famille,\nami ou parent hébergé, colocataire)" 
      #pas précisé si prise compte de 7 mais très peu d'individus
    )
  ) %>% 
  mutate(
    crois_pauvrete_obj_subj = case_when(
      !subj_pauvrete & !obj_pauvrete & !is.na(subj_pauvrete) & !is.na(obj_pauvrete)  ~
        "Au-dessus du seuil\net ne se sent pas pauvre",
      !subj_pauvrete & obj_pauvrete & !is.na(subj_pauvrete) & !is.na(obj_pauvrete) ~
        "Sous le seuil\nmais ne se sent pas pauvre",
      subj_pauvrete & !obj_pauvrete & !is.na(subj_pauvrete) & !is.na(obj_pauvrete) ~
        "Au-dessus du seuil\nmais se sent pauvre",
      subj_pauvrete & obj_pauvrete & !is.na(subj_pauvrete) & !is.na(obj_pauvrete)~
        "Pauvreté monétaire\net ressentie"
    )
  ) %>% 
#sdres_3 : RSA, sdres_4 : chômage, sdres_10 : handicap dépdce.
  mutate(
    assistance = case_when(
      sdres_3==1 | sdres_4==1 | sdres_10==1 ~ TRUE,
      sdres_3==2 & sdres_4==2 & sdres_10==2 ~ FALSE,
      TRUE ~ NA
      )
  ) %>% 
  mutate(
    pessimisme = case_when(
      og3_1%in%c(1,2) ~ FALSE,
      og3_1%in%c(3,4) ~ TRUE,
      og3_1%in%c(5) ~ NA
      )
  ) %>% 
  mutate(
    declassement = case_when(
      #og2_ab%in%c(1,2) | og2_cd%in%c(4,5)  ~ TRUE,
      #og2_ab%in%c(3,4,5) | og2_cd%in%c(1,2,3) ~ FALSE,
      #og2_ab%in%c(6) | og2_cd%in%c(6) ~ NA
      og2%in%c(1,2) ~ TRUE,
      og2%in%c(3,4,5) ~ FALSE,
      og2%in%c(6) ~ NA
      )
  )  %>% 
  mutate(
    proprietaire = case_when(
      lo1==1 ~ TRUE,
      lo1%in%c(2,3,4) ~ FALSE,
      lo1==5 ~ NA
      )
  ) %>% 
  mutate(
    retraite = case_when(
      sdsitua==6 ~ TRUE,
       TRUE ~ FALSE
    )
  )


```


```{r, echo=FALSE}
bdd_logit <- bdd %>% 
   mutate(nivie = sdrevcl_imput_moy/sduc) %>% 
  mutate(quantile_nivie = factor(
    cut(sdrevcl_imput_moy/sduc, include.lowest=TRUE,
        breaks=quantile(sdrevcl_imput_moy/sduc,
                        probs=seq(0,1,0.2),na.rm=TRUE),
        labels=1:5),
    levels=c(2,1,3,4,5),
    labels=paste0("-Quintile ",c(2,1,3,4,5)))
  ) %>% 
  mutate(
    statact = factor(case_when(
      sdsitua==1 & sdstatemp%in%c(1)   ~ 1,
      sdsitua%in%c(2,3) | (sdsitua==1 & sdstatemp%in%c(NA,2,3,4,5)) ~ 2,
      sdsitua==4 ~ 3,
      sdsitua==5 ~ 4,
      sdsitua==6 ~ 5,
      sdsitua==7 ~ 6,
      TRUE ~ NA_real_
    ),
    levels=1:6,
    labels=paste0("-",
                  c("CDI temps plein",
                    "Emploi précaire ou à temps partiel",
                    "Recherche d’emploi",
                    "Étudiant",
                    "Retraité",
                    "Aucune activité professionnelle"))
    )) %>%
  # fastDummies::dummy_cols(select_columns = 'prof') %>% 
  mutate(
    diplome = factor(case_when(
      sddipl%in%c(1,2,3,4) ~ 1,
      sddipl%in%c(5,6) ~ 2,
      sddipl%in%c(7) ~ 3,
      sddipl%in%c(8) ~ 4,
      TRUE ~ NA_real_
    ),
    levels=c(2,1,3,4),
    labels=paste0("-",c("Baccalauréat","CAP, BEP ou moins","Bac + 2","Bac + 3 ou plus"))
    )) %>% 
  mutate(aide_log = factor(
    ifelse(sdres_9!=3,sdres_9,NA),
    levels=c(2,1),
    labels=paste0("-",c("Pas d'aide au logement","Aide au logement reçue"))
  )) %>% 
  mutate(aide_rsa = factor(
    ifelse(sdres_3!=3,sdres_3,NA),
    levels=c(2,1),
    labels=paste0("-",c("Pas de RSA","RSA reçu"))
  )) %>% 
  mutate(aide_handi = factor(
    ifelse(sdres_10!=3,sdres_10,NA),
    levels=c(2,1),
    labels=paste0("-",c("Pas d'alloc. hand./invalid./dépend.",
                        "Alloc. hand./invalid./dépend. reçu"))
  )) %>% 
  mutate(sexe = factor(
    ifelse(sdsexe!=3,sdsexe,NA),
    levels=c(2,1),
    labels=paste0("-",c("Femme","Homme"))
  )) %>% 
  mutate(age_tranche = factor(
    cut(sdage,
        breaks=c(18,30,40,50,60,70,120),
        include.lowest=TRUE,
        labels=1:6),
    levels=c(2,1,3,4,5,6),
    labels=paste0("-",c("30 à 39 ans","18 à 29 ans","40 à 49 ans",
                        "50 à 59 ans","60 à 69 ans", "70 ans et plus")))
  ) %>% 
  mutate(
    vie_fam = factor(case_when(
      sdsitfam==1 ~ 1,
      #sdsitfam==2 & sdnbenf==0 ~ 2,
      #sdsitfam==2 & sdnbenf!=0 ~ 3,
      sdsitfam==2 & sdnbenf==1 ~ 2,
      sdsitfam==2 & sdnbenf!=1 ~ 3,
      sdsitfam==3 ~ 4,
      sdsitfam==4 ~ 5,
      sdsitfam%in%c(5,6,7) ~ 6,
      TRUE ~ NA_real_
    ),
    levels=c(2,1,3,4,5,6),
    labels=paste0("-",
                  c("Membre du couple (pas d’enfants à charge)","Vit seul",
                    "Membre du couple (enfants à charge)", "Chef famille monoparentale",
                    "Enfant","Autre situation familiale"))
    )) %>% 
  mutate(
    statut_occup0 = factor(case_when(
      lo1%in%c(2,3,4)  ~ 1,
      lo1==1 ~ 2,
      lo1==5 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Locataire ou hébergé","Propriétaire ")) 
    )) %>% 
  mutate(
    statut_occup = factor(case_when(
      lo1%in%c(3,4)  ~ 1,
      lo1==2  ~ 2,
      lo1==1 ~ 3,
      lo1==5 ~ NA_real_
   ),
    levels=c(1,2,3),
    labels=paste0("-",
                  c("Locataire privé / hébergé",
                    "Locataire HLM","Propriétaire")) 
    )) %>% 
  mutate(annee_fac = factor(annee,labels=paste0("-",2015:2019))) %>% 
  mutate(annee_fac_paires = factor(ifelse(annee%in%c(2016,2018),annee,NA),labels=paste0("-",c(2016,2018)))) %>% 
  mutate(pauvrete_mon_rel= factor(
    ifelse(sdrevcl_imput_moy/sduc<seuil_pauvrete,3,
                                  ifelse(sdrevcl_imput_moy/sduc>=1.2*seuil_pauvrete,1,
                                         ifelse(sdrevcl_imput_moy/sduc<1.2*seuil_pauvrete &
                                                  sdrevcl_imput_moy/sduc>=seuil_pauvrete ,
                                                2,NA)
                                  )),
    levels=c(1,2,3),
    labels=paste0("-",c("Revenus > 20 pourcents seuil pauvreté",
                        "Entre le seuil et 20 pourcents au dessus",
                        "Pauvreté monétaire"))
  )
  )

#NEW depuis fiche 3
 bdd_logit <- bdd_logit %>% #chômeur indemnise 
  mutate(
    conn_choindemnise = factor(case_when(
      sdproxim_1%in%c(1,4)  ~ 1,
      sdproxim_1%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_1==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de chômeur indemnisé",
                    "Connait un chômeur indemnisé")) 
    )) %>% 
  mutate(
    est_choindemnise = factor(case_when(
      sdproxim_1%in%c(4,6,7,8)  ~ 2,
      sdproxim_1%in%c(1,2,3,5)  ~ 1,
      sdproxim_1==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas chômeur indemnisé",
                    "est chômeur indemnisé")) 
    )) %>%
  mutate(
    conn_chononindemnise = factor(case_when(
      sdproxim_2%in%c(1,4)  ~ 1,
      sdproxim_2%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_2==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de chômeur non indemnisé",
                    "Connait un chômeur non indemnisé")) 
    )) %>% 
  mutate(
    est_chononindemnise = factor(case_when(
      sdproxim_2%in%c(4,6,7,8)  ~ 2,
      sdproxim_2%in%c(1,2,3,5)  ~ 1,
      sdproxim_2==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas chômeur non indemnisé",
                    "est chômeur non indemnisé")) 
    )) %>% #SDF
  mutate(
    conn_sdf = factor(case_when(
      sdproxim_3%in%c(1,4)  ~ 1,
      sdproxim_3%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_3==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de SDF",
                    "Connait un SDF")) 
    )) %>% 
  mutate(
    est_sdf = factor(case_when(
      sdproxim_3%in%c(4,6,7,8)  ~ 2,
      sdproxim_3%in%c(1,2,3,5)  ~ 1,
      sdproxim_3==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas SDF",
                    "est SDF")) 
    )) %>% #personne élevant seul ses enfants avec moins du SMIC 
  mutate(
    conn_eleveseulsmic = factor(case_when(
      sdproxim_4%in%c(1,4)  ~ 1,
      sdproxim_4%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_4==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de personne élevant seul ses enfants avec moins du SMIC",
                    "Connait une personne élevant seul ses enfants avec moins du SMIC")) 
    )) %>% 
  mutate(
    est_eleveseulsmic = factor(case_when(
      sdproxim_4%in%c(4,6,7,8)  ~ 2,
      sdproxim_4%in%c(1,2,3,5)  ~ 1,
      sdproxim_4==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas personne élevant seul ses enfants avec moins du SMIC",
                    "est personne élevant seul ses enfants avec moins du SMIC")) 
    )) %>% #pensionné invalide indicapé ne pouvant pas travailler 
  mutate(
    conn_pensionhandi = factor(case_when(
      sdproxim_5%in%c(1,4)  ~ 1,
      sdproxim_5%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_5==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de pensionné invalide indicapé ne pouvant pas travailler",
                    "Connait un pensionné invalide indicapé ne pouvant pas travailler")) 
    )) %>% 
  mutate(
    est_pensionhandi = factor(case_when(
      sdproxim_5%in%c(4,6,7,8)  ~ 2,
      sdproxim_5%in%c(1,2,3,5)  ~ 1,
      sdproxim_5==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas pensionné invalide indicapé ne pouvant pas travailler",
                    "est pensionné invalide indicapé ne pouvant pas travailler")) 
    )) %>% #personne en emploi précaire 
  mutate(
    conn_emploiprecaire = factor(case_when(
      sdproxim_6%in%c(1,4)  ~ 1,
      sdproxim_6%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_6==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de personne en emploi précaire",
                    "Connait une personne en emploi précaire")) 
    )) %>% 
  mutate(
    est_emploiprecaire = factor(case_when(
      sdproxim_6%in%c(4,6,7,8)  ~ 2,
      sdproxim_6%in%c(1,2,3,5)  ~ 1,
      sdproxim_6==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas personne en emploi précaire",
                    "est personne en emploi précaire")) 
    )) %>% #personne au RSA 
  mutate(
    conn_rsa = factor(case_when(
      sdproxim_7%in%c(1,4)  ~ 1,
      sdproxim_7%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_7==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de personne au RSA",
                    "Connait une personne au RSA")) 
    )) %>% 
  mutate(
    est_rsa = factor(case_when(
      sdproxim_7%in%c(4,6,7,8)  ~ 2,
      sdproxim_7%in%c(1,2,3,5)  ~ 1,
      sdproxim_7==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas personne au RSA",
                    "est personne au RSA")) 
    )) %>% #personne handicapée de moins de 60 ans
  mutate(
    conn_handijeune = factor(case_when(
      sdproxim_8%in%c(1,4)  ~ 1,
      sdproxim_8%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_8==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de personne handicapée de moins de 60 ans",
                    "Connait une personne handicapée de moins de 60 ans")) 
    )) %>% 
  mutate(
    est_handijeune = factor(case_when(
      sdproxim_8%in%c(4,6,7,8)  ~ 2,
      sdproxim_8%in%c(1,2,3,5)  ~ 1,
      sdproxim_8==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas personne handicapée de moins de 60 ans",
                    "est personne handicapée de moins de 60 ans")) 
    )) %>% #personne âgée dépendante
  mutate(
    conn_dependant = factor(case_when(
      sdproxim_9%in%c(1,4)  ~ 1,
      sdproxim_9%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_9==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de personne âgée dépendante",
                    "Connait une personne âgée dépendante")) 
    )) %>% 
  mutate(
    est_dependant = factor(case_when(
      sdproxim_9%in%c(4,6,7,8)  ~ 2,
      sdproxim_9%in%c(1,2,3,5)  ~ 1,
      sdproxim_9==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas personne âgée dépendante",
                    "est personne âgée dépendante")) 
    )) %>% 
  mutate(
    revenus_salaires = factor(case_when(
      sdres_1%in%c(2)  ~ 1,
      sdres_1%in%c(1)  ~ 2,
      sdres_1==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de revenus de salaires",
                    "Revenus de salaires")) 
    )) %>% 
  mutate(
    revenus_independant = factor(case_when(
      sdres_2%in%c(2)  ~ 1,
      sdres_2%in%c(1)  ~ 2,
      sdres_2==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de revenus d'activité indépendante",
                    "Revenus d'activité indépendante")) 
    )) %>%
  mutate(
    presta_hlm = factor(case_when(
      lo1%in%c(1,3,4) ~ 1,
      lo1==2  ~ 2,
      lo1==5 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Locataire privé / hébergé, Propriétaire","Locataire HLM")) 
    )) %>%  
  mutate(
    presta_rsa = factor(case_when(
      sdres_3%in%c(2)  ~ 1,
      sdres_3%in%c(1)  ~ 2,
      sdres_3==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de RSA",
                    "RSA")) 
    )) %>% 
  mutate(
    presta_chomage = factor(case_when(
      sdres_4%in%c(2)  ~ 1,
      sdres_4%in%c(1)  ~ 2,
      sdres_4==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas d'allocation chômage",
                    "Allocation chômage")) 
    )) %>% 
  mutate(
    revenus_retraite = factor(case_when(
      sdres_5%in%c(2)  ~ 1,
      sdres_5%in%c(1)  ~ 2,
      sdres_5==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de revenus de retraite",
                    "Revenus de retraite")) 
    )) %>%
  mutate(
    revenus_financiers = factor(case_when(
      sdres_6%in%c(2)  ~ 1,
      sdres_6%in%c(1)  ~ 2,
      sdres_6==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de revenus d'actifs financiers",
                    "Revenus d'actifs financiers")) 
    )) %>% 
  mutate(
    revenus_locatifs = factor(case_when(
      sdres_7%in%c(2)  ~ 1,
      sdres_7%in%c(1)  ~ 2,
      sdres_7==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de revenus de locations",
                    "Revenus de locations")) 
    )) %>% 
  mutate(
    presta_fam = factor(case_when(
      sdres_8%in%c(2)  ~ 1,
      sdres_8%in%c(1)  ~ 2,
      sdres_8==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de prestations familiales",
                    "Prestations familiales")) 
    )) %>% 
  mutate(
    presta_apl = factor(case_when(
      sdres_9%in%c(2)  ~ 1,
      sdres_9%in%c(1)  ~ 2,
      sdres_9==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas d'APL",
                    "APL")) 
    )) %>% 
  mutate(
    presta_handi = factor(case_when(
      sdres_10%in%c(2)  ~ 1,
      sdres_10%in%c(1)  ~ 2,
      sdres_10==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas d'AAH, APA, PCH (handicap)",
                    "AAH, APA, PCH (handicap)")) 
    )) %>% 
  mutate(
    presta_etudes = factor(case_when(
      sdres_11%in%c(2)  ~ 1,
      sdres_11%in%c(1)  ~ 2,
      sdres_11==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de bourse d'étude",
                    "Bourse d'étude")) 
    )) %>% 
  mutate(
    presta_pensionalim = factor(case_when(
      sdres_12%in%c(2)  ~ 1,
      sdres_12%in%c(1)  ~ 2,
      sdres_12==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de pension alimentaire",
                    "pension alimentaire")) 
    )) %>% 
  mutate(
    statut_activite = factor(case_when(
      sdstat==2 & (sdsitua==1 & sdstatemp==1) ~ 1,
      sdstat==2 & !(sdsitua==1 & sdstatemp==1) ~ 2,
      sdstat==1 & (sdsitua==1 & sdstatemp==1) ~ 3,
      sdstat==1 & !(sdsitua==1 & sdstatemp==1) ~ 4,
      sdstat==3 ~ 5,
      sdstat==4 ~ 6,
      sdstat==5 ~ 7,
      sdstat==6 ~ 8,
      sdstat==7 ~ 9,
      sdstat==8 ~ NA_real_
   ),
    levels=1:9,
    labels=paste0("-",
                  c("Salarié du secteur privé (en CDI à temps plein)",
"Salarié du secteur privé (précaire ou à temps partiel)",
"Salarié du secteur public (en CDI à temps plein)",
"Salarié du secteur public (précaire ou à temps partiel)",
"Indépendant sans salarié",
"Employeur",
"Chômeur",
"Inactif",
"Autre statut d'activité")
) 
    )) %>% 
  mutate(prof = factor(
    sdpcs7,
    levels=c(4,1,2,3,5,6,7),
    labels=paste0("-",c("Profession intermédiaire","Agriculteur",
                        "Artisan commerçant","Cadre supérieur, profession libérale",
                        "Employé","Ouvrier","Autre inactif"))
  ))  %>% 
  mutate(prof_statut_act = factor(
    sdpcs10,
    levels=c(4,1,2,3,5,6,7,8,9,10),
    labels=paste0("-",c("Profession intermédiaire","Agriculteur",
                        "Artisan commerçant","Cadre supérieur, profession libérale",
                        "Employé","Ouvrier","Chômeur",
                        "Retraité","Au foyer","Autre inactif"))
  )) %>%
  mutate(
    statut_activite_resp = factor(case_when(
      sdprstat==2 & (sdprsitua==1) ~ 1,
      sdprstat==2 & !(sdprsitua==1) ~ 2,
      sdprstat==1 & (sdprsitua==1) ~ 3,
      sdprstat==1 & !(sdprsitua==1) ~ 4,
      sdprstat==3 ~ 5,
      sdprstat==4 ~ 6,
      sdprstat==5 ~ 7,
      sdprstat==6 ~ 8,
      sdprstat==7 ~ 9,
      sdprstat==8 ~ NA_real_
   ),
    levels=1:9,
    labels=paste0("-Pers. réf. ",
                  c("Salarié du secteur privé (à temps plein)",
"Salarié du secteur privé (à temps partiel)",
"Salarié du secteur public (à temps plein)",
"Salarié du secteur public (à temps partiel)",
"Indépendant sans salarié",
"Employeur",
"Chômeur",
"Inactif",
"Autre statut d'activité")
) 
    )) %>% 
  mutate(prof_resp = factor(
    sdprpcs7,
    levels=c(4,1,2,3,5,6,7),
    labels=paste0("-Pers. réf. ",c("Profession intermédiaire","Agriculteur",
                        "Artisan commerçant","Cadre supérieur, profession libérale",
                        "Employé","Ouvrier","Autre inactif"))
  )) %>% 
  mutate(prof_statut_act_resp = factor(
    sdprpcs10,
    levels=c(4,1,2,3,5,6,7,8,9,10),
    labels=paste0("-Pers. réf. ",c("Profession intermédiaire","Agriculteur",
                        "Artisan commerçant","Cadre supérieur, profession libérale",
                        "Employé","Ouvrier","Chômeur",
                        "Retraité","Au foyer","Autre inactif"))
  ))
 

bdd_logit_2015_2017 <- bdd_logit %>% filter(annee<2018) 
bdd_logit_2018_2019 <- bdd_logit %>% filter(annee>=2018)

```


```{r, echo=FALSE}
afficher_tableau <- function(tab){
  
  options <- list(lengthMenu = c(10,20,50,100),
                        pageLength = 20, orderClasses = TRUE,
                        autoWidth = FALSE, searching = TRUE)
  
  order_option <- function(table, name, order="desc") {
    index <- which(names(table) == name) - 1
    list(order = list(list(index, order)))
  }
  
  dt <- DT::datatable(tab,
                      options = c(options, order_option(tab, "Coord")),
                      rownames = FALSE)
  indices_3 <- which(names(tab) %in% c("Coord", "Cos2", "V.test", "eta2", "P.value"))
  indices_2 <- which(names(tab) %in% c("Contrib"))
  if (length(indices_3) > 0) {
    dt <- dt %>%
      DT::formatRound(indices_3, digits = 3)
  }
  if (length(indices_2) > 0) {
    dt <- dt %>%
      DT::formatRound(indices_2, digits = 2)
  }
  return(dt)
}
```


## Pauvreté monétaire, institutionnelle et subjective

### Variables actives


```{r, echo=FALSE}
#actives_autres <- c("quantile_nivie", "presta_rsa","presta_chomage","presta_apl")
#actives_autres <- c("quantile_nivie","revenus_locatifs","revenus_financiers","presta_rsa","presta_chomage","presta_apl")
# Non car sinon actifs versus non actifs
#actives_autres <- c("quantile_nivie", "revenus_salaires","revenus_independant","revenus_retraite","revenus_financiers","revenus_locatifs","presta_rsa","presta_chomage","presta_apl","presta_handi","presta_etudes", "presta_hlm")
```

```{r}
actives_autres <- c("quantile_nivie","revenus_financiers","revenus_locatifs","presta_rsa","presta_chomage","presta_apl","presta_handi","presta_etudes", "presta_hlm")
actives_subj <- c("subj_pauvrete_et_risque", "subj_inf_mini_decla")
actives <- c(actives_subj,actives_autres)
passives <- c("statut_occup", "diplome", "conn_rsa","annee_fac", "prof_statut_act", "age_tranche","vie_fam"#,"presta_handi",
              )
actives_subj <- c("subj_pauvrete_et_risque", "subj_inf_mini_decla")
actives <- c(actives_subj,actives_autres)
passives <- c("revenus_financiers","revenus_locatifs","presta_handi","statut_occup", "diplome", "conn_rsa","annee_fac", "prof_statut_act", "age_tranche","vie_fam")

bdd_acm <- bdd_logit %>% 
  dplyr::select(c(all_of(actives),all_of(passives))) %>% 
  tidyr::drop_na()
res.mca <- MCA(bdd_acm,
               quali.sup=(length(actives)+1):(ncol(bdd_acm)),
               graph=FALSE) 
#explor(res.mca)
saveRDS(res.mca,"../data/res.mca.RDS")
res <- explor::prepare_results(res.mca)

```

Les trois premiers axes de l'ACM (qui conservent respectivement **19,9 %**, **9,7 %** et **7,3 %** de l'inertie) sont les suivants. Le saut d'inertie entre les axes 2 et 3 est faible et les résultats de l'axe 3 nous invitent à **structurer l'espace uniquement selon les deux premières dimensions**.
- Le **premier axe** (horizontal figure 1) oppose clairement à droite les personnes pauvres monétairement (premier quintile de niveau de vie), institutionnellement (RSA en particulier, APL, bourses d’études, locataie HLM) et subjectivement (sentiment de pauvreté et revenu inférieur au minimum déclaré et « déjà pauvre ») et à gauche les personnes plus riches (Q5 non pauvre, non inférieur au minimum déclaré, actifs financiers et de location).

- Le **deuxième axe** (vertical) peut paraître étrange à interpréter. Avec les Q1 et Q5 qui sont au même niveau en haut et s'opposent aux Q2, Q3 et Q4 en bas. C’est en fait un résultat très classique en ACM, un effet Guttmann qui oppose les situations extrêmes en termes de richesse (Q5, Actifs financiers et de locations) ou de pauvreté (Q1, « Déjà pauvre », APL, RSA, bourses d’études) en haut de l'axe à des personnes pouvant éventuellement basculer dans la pauvreté en bas (Q2, Q3, risque ressenti de pauvreté dans 5 ans, au chômage).

```{r}
xlim <- c(-2, 2)
ylim <- c(-1, 2)

explor::MCA_var_plot(res, xax = 1, yax = 2, var_sup = TRUE, var_sup_choice = NULL,
    var_lab_min_contrib = 0, col_var = "Variable", symbol_var = "Type", size_var = NULL,
    size_range = c(10, 300), labels_size = 10, point_size = 56, transitions = TRUE,
    labels_positions = NULL, labels_prepend_var = FALSE, xlim = xlim,
    ylim = ylim)
```

Axe 1

```{r, echo=FALSE}
res$vars %>% 
  filter(Type == "Active", Axis == 1) %>% 
  dplyr::select(Variable,Level,Count,Coord,Contrib,Cos2) %>% 
  data.frame() %>% 
  afficher_tableau()
```

Axe 2

```{r, echo=FALSE}
res$vars %>% 
  filter(Type == "Active", Axis == 2) %>% 
  dplyr::select(Variable,Level,Count,Coord,Contrib,Cos2) %>% 
  data.frame() %>% 
  afficher_tableau()
```

Axe 3

```{r, echo=FALSE}
res$vars %>% 
  filter(Type == "Active", Axis == 3) %>% 
  dplyr::select(Variable,Level,Count,Coord,Contrib,Cos2) %>% 
  data.frame() %>% 
  afficher_tableau()
```

Axe 4

```{r, echo=FALSE}
res$vars %>% 
  filter(Type == "Active", Axis == 4) %>% 
  dplyr::select(Variable,Level,Count,Coord,Contrib,Cos2) %>% 
  data.frame() %>% 
  afficher_tableau()
```


Ci-dessous quelques nuages des +13 000 individus colorés selon certaines variables catégorielles actives. On voit sur ce nuage uniquement quelques centaines d'individus car nombre d'entre eux se ressemblent selon les variables actives (variables avec peu de modalités, donc souvent mêmes combinaisons de modalités répondues). 

- Pour les quintiles de niveau de vie, rien de plus à ajouter que ce qui a été dit au-dessus, avec un positionnement en "cuvette".
- Pour les revenus d’actifs et de location, un positionnement sur la diagonale du haut à gauche vers le bas au milieu. Opposition entre situation médiane et très riche. 
- Pour le RSA, l'opposition se fait entre haut à droite et reste de l'ACM (opposition des très pauvres aux autres). 
- Même remarque pour APL, avec une distinction moins nette que pour le RSA (se rapproche du centre de l’ACM). Idem pour location de HLM et bourses d’études.
- Pour les allocations chômage et la prestation handicap, la localisation est plutôt au centre du nuage, décalé légèrement sur la droite (pauvreté) ce qui veut dire que ces prestations peuvent concerner des personnes qui sont à la limite entre pauvreté et richesse.
- L'indicateur `subj_pauvrete_et_risque` qui rassemble sentiment de pauvreté (indiquer se sentir pauvre, à droite) et risque de pauvreté (indiquer ne pas se sentir pauvre mais penser risquer l'être dans les 5 prochaines années, en bas) a un positionnement en triangle qui illustre l'importance fondamentale que cette variable a dans la constitution des deux premiers axes
- L'indicateur du niveau de vie inférieur à un niveau de vie minimum pour vivre déclaré s’oppose sur les deux diagonales de manière symétrique. Il semble donc bien résumer l’opposition entre richesse et pauvreté selon cette typologie. 


```{r, echo=FALSE, eval=FALSE}
explor::MCA_ind_plot(res, xax = 1, yax = 2, ind_sup = FALSE, lab_var = NULL,
                     ind_lab_min_contrib = 0, col_var = "quantile_nivie", labels_size = 9, point_opacity = 1,
                     opacity_var = NULL, point_size = 33, ellipses = TRUE, transitions = FALSE,
                     labels_positions = NULL, xlim = xlim, ylim = ylim)

explor::MCA_ind_plot(res, xax = 1, yax = 2, ind_sup = FALSE, lab_var = NULL,
                     ind_lab_min_contrib = 0, col_var = "revenus_financiers", labels_size = 9, point_opacity = 1,
                     opacity_var = NULL, point_size = 33, ellipses = TRUE, transitions = FALSE,
                     labels_positions = NULL, xlim = xlim, ylim = ylim)

explor::MCA_ind_plot(res, xax = 1, yax = 2, ind_sup = FALSE, lab_var = NULL,
                     ind_lab_min_contrib = 0, col_var = "revenus_locatifs", labels_size = 9, point_opacity = 1,
                     opacity_var = NULL, point_size = 33, ellipses = TRUE, transitions = FALSE,
                     labels_positions = NULL, xlim = xlim, ylim = ylim)
explor::MCA_ind_plot(res, xax = 1, yax = 2, ind_sup = FALSE, lab_var = NULL,
                     ind_lab_min_contrib = 0, col_var = "presta_rsa", labels_size = 9, point_opacity = 1,
                     opacity_var = NULL, point_size = 33, ellipses = TRUE, transitions = FALSE,
                     labels_positions = NULL, xlim = xlim, ylim = ylim)

explor::MCA_ind_plot(res, xax = 1, yax = 2, ind_sup = FALSE, lab_var = NULL,
                     ind_lab_min_contrib = 0, col_var = "presta_apl", labels_size = 9, point_opacity = 1,
                     opacity_var = NULL, point_size = 33, ellipses = TRUE, transitions = FALSE,
                     labels_positions = NULL, xlim = xlim, ylim = ylim)

explor::MCA_ind_plot(res, xax = 1, yax = 2, ind_sup = FALSE, lab_var = NULL,
                     ind_lab_min_contrib = 0, col_var = "presta_hlm", labels_size = 9, point_opacity = 1,
                     opacity_var = NULL, point_size = 33, ellipses = TRUE, transitions = FALSE,
                     labels_positions = NULL, xlim = xlim, ylim = ylim)



explor::MCA_ind_plot(res, xax = 1, yax = 2, ind_sup = FALSE, lab_var = NULL,
                     ind_lab_min_contrib = 0, col_var = "presta_etudes", labels_size = 9, point_opacity = 1,
                     opacity_var = NULL, point_size = 33, ellipses = TRUE, transitions = FALSE,
                     labels_positions = NULL, xlim = xlim, ylim = ylim)



explor::MCA_ind_plot(res, xax = 1, yax = 2, ind_sup = FALSE, lab_var = NULL,
                     ind_lab_min_contrib = 0, col_var = "presta_chomage", labels_size = 9, point_opacity = 1,
                     opacity_var = NULL, point_size = 33, ellipses = TRUE, transitions = FALSE,
                     labels_positions = NULL, xlim = xlim, ylim = ylim)

explor::MCA_ind_plot(res, xax = 1, yax = 2, ind_sup = FALSE, lab_var = NULL,
                     ind_lab_min_contrib = 0, col_var = "presta_handi", labels_size = 9, point_opacity = 1,
                     opacity_var = NULL, point_size = 33, ellipses = TRUE, transitions = FALSE,
                     labels_positions = NULL, xlim = xlim, ylim = ylim)


explor::MCA_ind_plot(res, xax = 1, yax = 2, ind_sup = FALSE, lab_var = NULL,
                     ind_lab_min_contrib = 0, col_var = "subj_pauvrete_et_risque", labels_size = 9, point_opacity = 1,
                     opacity_var = NULL, point_size = 33, ellipses = TRUE, transitions = FALSE,
                     labels_positions = NULL, xlim = xlim, ylim = ylim)



explor::MCA_ind_plot(res, xax = 1, yax = 2, ind_sup = FALSE, lab_var = NULL,
                     ind_lab_min_contrib = 0, col_var = "subj_inf_mini_decla", labels_size = 9, point_opacity = 1,
                     opacity_var = NULL, point_size = 33, ellipses = TRUE, transitions = FALSE,
                     labels_positions = NULL, xlim = xlim, ylim = ylim)

 
```

### Distinction avant/après 2018

Aucune distinction de la structure avant après 2018. Même effet Guttman.

2015-2017

```{r}
bdd_acm_2015_2017 <- bdd_logit_2015_2017 %>% 
  dplyr::select(c(all_of(actives),all_of(passives))) %>% 
  tidyr::drop_na()
res.mca_2015_2017 <- MCA(bdd_acm_2015_2017,
               quali.sup=(length(actives)+1):(ncol(bdd_acm_2015_2017)),
               graph=FALSE) 
res_2015_2017 <- explor::prepare_results(res.mca_2015_2017)

explor::MCA_var_plot(res_2015_2017, xax = 1, yax = 2, var_sup = TRUE, var_sup_choice = NULL,
    var_lab_min_contrib = 0, col_var = "Variable", symbol_var = "Type", size_var = NULL,
    size_range = c(10, 300), labels_size = 10, point_size = 56, transitions = TRUE,
    labels_positions = NULL, labels_prepend_var = FALSE, xlim = xlim,
    ylim = ylim)
```


2018-2019

```{r}
bdd_acm_2018_2019 <- bdd_logit_2018_2019 %>% 
  dplyr::select(c(all_of(actives),all_of(passives))) %>% 
  tidyr::drop_na()
res.mca_2018_2019 <- MCA(bdd_acm_2018_2019,
               quali.sup=(length(actives)+1):(ncol(bdd_acm_2018_2019)),
               graph=FALSE) 
res_2018_2019 <- explor::prepare_results(res.mca_2018_2019)

explor::MCA_var_plot(res_2018_2019, xax = 1, yax = 2, var_sup = TRUE, var_sup_choice = NULL,
    var_lab_min_contrib = 0, col_var = "Variable", symbol_var = "Type", size_var = NULL,
    size_range = c(10, 300), labels_size = 10, point_size = 56, transitions = TRUE,
    labels_positions = NULL, labels_prepend_var = FALSE, xlim = xlim,
    ylim = ylim)
```

### Variables supplémentaires

Axe 1

```{r, echo=FALSE}
res$vars %>% 
  filter(grepl("Supplementary", Type), Axis == 1) %>%
  mutate(Level = ifelse(Class == "Quantitative", "-", Level)) %>% 
  dplyr::select(Variable, Level, Count,Coord,Contrib,Cos2,V.test,P.value) %>% 
  data.frame %>% 
  afficher_tableau()
```

Axe 2

```{r, echo=FALSE}
res$vars %>% 
  filter(grepl("Supplementary", Type), Axis == 2) %>%
  mutate(Level = ifelse(Class == "Quantitative", "-", Level)) %>% 
  dplyr::select(Variable, Level, Count,Coord,Contrib,Cos2,V.test,P.value) %>% 
  data.frame %>% 
  afficher_tableau()
```

Axe 3

```{r, echo=FALSE}
res$vars %>% 
  filter(grepl("Supplementary", Type), Axis == 3) %>%
  mutate(Level = ifelse(Class == "Quantitative", "-", Level)) %>% 
  dplyr::select(Variable, Level, Count,Coord,Contrib,Cos2,V.test,P.value) %>% 
  data.frame %>% 
  afficher_tableau()
```

#### Professions et statuts d'emploi

Les professions et statuts d'emploi ont des positions assez marquées sur les axes de l'ACM comparées aux autres variables en supplémentaire. 

-	En haut à droite (pauvreté) : Autre inactif, au foyer, chômeurs, 
-	En haut à gauche (richesse) : cadres, professions libérales, professions intermédiaires, retraités, artisans et même agriculteur
-	En bas (situation entre deux) : Employés, Ouvriers


```{r, echo=FALSE}
explor::MCA_var_plot(res, xax = 1, yax = 2, var_sup = TRUE, var_sup_choice = "prof_statut_act",
                     var_lab_min_contrib = 0, col_var = "Type", symbol_var = "Variable", size_var = NULL,
                     size_range = c(10, 300), labels_size = 10, point_size = 128, transitions = TRUE,
                     labels_positions = "auto", labels_prepend_var = FALSE, 
                     xlim = xlim, ylim = ylim)
```

#### Vie familiale et tranche d'âge

Vie familiale et tranche d'âge se positionnent selon la même logique, en particulier selon l'axe horizontal, c’est-à-dire de manière moins tranchée que les PCS, à part les familles monoparentales (en haut à droite, pauvreté). Les personnes qui vivent seules sont positionnées au centre légèrement en bas et font dont partie des personnes pouvant basculer facilement dans la pauvreté.  

```{r, echo=FALSE}
explor::MCA_var_plot(res, xax = 1, yax = 2, var_sup = TRUE, var_sup_choice = c("age_tranche",
                                                                               "vie_fam"), var_lab_min_contrib = 0, col_var = "Type", symbol_var = "Variable",
                     size_var = NULL, size_range = c(10, 300), labels_size = 10, point_size = 128,
                     transitions = TRUE, labels_positions = NULL, labels_prepend_var = FALSE, 
                     xlim = xlim, ylim = ylim)
```

#### Autres variables qui se démarquent peu

Ce dernier graphique présente les dernières modalités, qui se démarquent peu sur cette ACM. Le graphique a d'ailleurs été zoomé car tout s'agglutinait au centre des deux axes. Quelques variables particulières à noter cependant : 

- Les diplômés de bac+3 et dans une moindre mesure bac+2 et les propriétaires plus sont plutôt en haut à gauche 
- Avoir quelqu'un dans son entourage au RSA ou être peu ou pas diplômé situe les individu plutôt en bas légèrement à droite (pauvreté relative)

```{r, echo=FALSE}
explor::MCA_var_plot(res, xax = 1, yax = 2, var_sup = TRUE, var_sup_choice = c("statut_occup", "diplome", "conn_rsa", "annee_fac"), var_lab_min_contrib = 0,
                     col_var = "Type", symbol_var = "Variable", size_var = NULL, size_range = c(10,
                                                                                                300), labels_size = 10, point_size = 128, transitions = TRUE, labels_positions = NULL,
                     labels_prepend_var = FALSE,
                     xlim = c(-1.5,1.5), ylim = c(-0.5, 0.5)
)

```

## CAH 

```{r, echo=FALSE}
bdd_poLCA <- bdd_logit %>% 
  mutate(s_sentpauvrisque = as.numeric(subj_pauvrete_et_risque),
         #s_infminidecla = as.numeric(subj_inf_mini_decla),
         s_infminidecla = ifelse(as.numeric(subj_inf_mini_decla)==2,1,2),
         #m_quantilenivie = as.numeric(quantile_nivie),
         m_quantilenivie = as.numeric(substr(quantile_nivie,11,11)),
        # m_quantilenivie_inv = 6-as.numeric(quantile_nivie),
         m_quantilenivie_inv = 6-as.numeric(substr(quantile_nivie,11,11)),
         m_locatif = as.numeric(revenus_locatifs),
         m_locatif_inv = 3-as.numeric(revenus_locatifs),
         m_financier = as.numeric(revenus_financiers),
         m_financier_inv = 3-as.numeric(revenus_financiers),
         i_log = as.numeric(presta_apl),
         i_rsa = as.numeric(presta_rsa),
         i_chom = as.numeric(presta_chomage),
         i_handi = as.numeric(presta_handi),
         i_bourse = as.numeric(presta_etudes),
         i_hlm = as.numeric(presta_hlm),
  ) %>% 
  dplyr::select(ident, s_sentpauvrisque, s_infminidecla,
m_quantilenivie_inv, m_locatif_inv, m_financier_inv,
i_log, i_rsa, i_chom, i_handi, i_bourse, i_hlm, sexe)


# bdd_poLCA <- bdd_logit %>% 
#   mutate(s_sentpauvrisque = as.numeric(subj_pauvrete_et_risque),
#          #s_infminidecla = as.numeric(factor(subj_inf_mini_decla,labels=c(1,2))),
#          s_infminidecla = ifelse(as.numeric(subj_inf_mini_decla)==2,1,2),
#          m_quantilenivie = as.numeric(quantile_nivie),
#          m_locatif = as.numeric(revenus_locatifs),
#          m_financier = as.numeric(revenus_financiers),
#          i_log = as.numeric(presta_apl),
#          i_rsa = as.numeric(presta_rsa),
#          i_chom = as.numeric(presta_chomage),
#          i_handi = as.numeric(presta_handi),
#          i_bourse = as.numeric(presta_etudes),
#          i_hlm = as.numeric(presta_hlm),
#   ) %>% 
#   dplyr::select(ident, s_sentpauvrisque, s_infminidecla,
# m_quantilenivie, m_locatif, m_financier,
# i_log, i_rsa, i_chom, i_handi, i_bourse, i_hlm)

num_indiv <- bdd_logit %>% 
  dplyr::select(c(all_of("ident"),all_of(actives),all_of(passives))) %>% 
  tidyr::drop_na() %>% dplyr::select(ident) %>% pull()
bdd_poLCA_rmnasup <- bdd_poLCA %>% filter(ident%in%num_indiv)

creer_x <- function(typo){
  x <- list(probs=NULL,y=NULL,P=NULL)
  x$y <- bdd_poLCA_rmnasup %>% dplyr::select(-c(ident,sexe))
  x$probs <- lapply(colnames(x$y),function(var){
    t <- table(typo,bdd_poLCA_rmnasup[[var]])
    t <- t/rowSums(t)
    row.names(t) <- paste0("classe ", row.names(t),":")
    colnames(t) <- paste0("Prop(", colnames(t),")")
    return(t)  
  })
  names(x$probs) <- colnames(x$y)
  x$P <- table(typo)/sum(table(typo))
  return(x)
}


poLCA.makeplot.poly.oneclass <- function(x,r,noms_classes=1:length(x$P)){
K.j <- sapply(x$probs,ncol)
par(mar=c(5,4,4,2)+0.1) #mfrow=c(1,1),
layout(matrix(seq(1,(1+1)),1+1,1),heights=c(rep(5,1),1))
# poLCA:::poLCA.makeplot.poly(x$probs,r,x$y,K.j,paste("Classe ",noms_classes[r]," : part de la population = ",round(100*x$P[r],1)," %",sep=""))
 poLCA:::poLCA.makeplot.poly(x$probs,r,x$y,K.j,paste("Classe ",names(x$P[r])," : part de la population = ",round(100*x$P[r],1)," %",sep=""))
}

```


### Sur les deux premiers axes factoriels

```{r}
donnees <- res.mca$ind$coord[,c(1,2)]
arbre <- hclust(dist(donnees), method = "ward.D2")
inertie <- sort(arbre$height, decreasing = TRUE)
plot(inertie[1:20], type = "s", xlab = "Nombre de classes", ylab = "Inertie")
points(c(2, 3, 4,5), inertie[c(2, 3, 4,5)], col = c("green3", "red3", "blue3","yellow3","pink3"), cex = 2, lwd = 3)

plot(arbre, labels = FALSE, main = "Partitions selon le nb de classes", xlab = "", ylab = "", sub = "", axes = FALSE, hang = -1)
rect.hclust(arbre, 2, border = "green3")
rect.hclust(arbre, 3, border = "red3")
rect.hclust(arbre, 4, border = "blue3")
rect.hclust(arbre, 5, border = "yellow3")

#Typologie en 5 classes
nbclasses <- 5

typo <- factor(factor(cutree(arbre,k=nbclasses),labels=c(5,3,4,2,1)),levels=1:5)

#saveRDS(typo,"../rapport/figures/typo_cah.RDS")

s.class(res.mca$ind$coord[,c(1,2)], typo, col = brewer.pal(5, "Set1")[1:nbclasses], sub = "Axes 1 et 2")

for(i in 1:nbclasses){
  poLCA.makeplot.poly.oneclass(creer_x(typo),i)
}

```

<!-- ### Sur tous les axes factoriels -->

```{r, eval=FALSE, echo=FALSE}
donnees <- res.mca$ind$coord
arbre <- hclust(dist(donnees), method = "ward.D2")
inertie <- sort(arbre$height, decreasing = TRUE)
plot(inertie[1:20], type = "s", xlab = "Nombre de classes", ylab = "Inertie")
points(c(2, 3, 5), inertie[c(2, 3, 5)], col = c("green3", "red3", "blue3","yellow3","pink3"), cex = 2, lwd = 3)

plot(arbre, labels = FALSE, main = "Partitions selon le nb de classes", xlab = "", ylab = "", sub = "", axes = FALSE, hang = -1)
rect.hclust(arbre, 2, border = "green3")
rect.hclust(arbre, 3, border = "red3")
rect.hclust(arbre, 5, border = "blue3")

typo <- factor(cutree(arbre,5))
s.class(res.mca$ind$coord[,c(1,2)], typo, col = brewer.pal(7, "Set1"), sub = "Axes 1 et 2")
for(i in c(1,3,4,5,2)){ #1:length(unique(typo))
  poLCA.makeplot.poly.oneclass(creer_x(typo),i)
}


```

## ACP 

```{r, echo=FALSE, dev="svglite"}
res.acp <- PCA(bdd_poLCA %>% dplyr::select(-c(sexe,ident)),
               graph=TRUE) 
```

## Figures rapport

```{r, echo=FALSE, dev="svglite"}
data_acm <- explor:::MCA_var_data(res, xax = 1, yax = 2, var_sup = TRUE, var_sup_choice = passives,
                         var_lab_min_contrib = 0, labels_prepend_var = FALSE) %>% 
  mutate(taille=ifelse(Variable=="subj_pauvrete_et_risque","bold","plain")) %>% 
  mutate(Lab=gsub("presta_hlm_","",Lab)) 

saveRDS(data_acm,"../rapport/figures/data_acm.RDS")

gg_acm_actives <- ggplot(data_acm %>%
                         filter(Type=="Active") %>% 
                         mutate(dimension = ifelse(substr(Variable,1,6)=="presta","Institutionnelle",ifelse(substr(Variable,1,4)=="subj","Subjective","Monétaire"))
                         )) + 
  geom_vline(xintercept = 0, color = "black", linetype = "dotted") +
  geom_hline(yintercept = 0, color = "black", linetype = "dotted") +
  stat_smooth(aes(x = Coord.x, y = Coord.y), method = "lm", formula = y ~ poly(x, 2), size = 1, se = FALSE, color = "grey") +
  geom_point(aes(x = Coord.x, y = Coord.y, color=Variable, shape=dimension)) + 
  geom_text_repel(aes(x = Coord.x, y = Coord.y,
                      color=Variable,label=gsub("-","",Lab),
                      size=taille,fontface=taille),
                  show.legend=FALSE, max.overlaps = 30, seed=1) +
    geom_segment(aes(x = -0.55, y = 1.75, xend = 0.55, yend = 1.75), cex=1,
                  arrow = arrow(length = unit(0.5, "cm"))) +
  ggrepel::geom_text_repel(data = data.frame(x=c(0.2),
           y=c(1.7)), size = 3, fontface="bold",
           aes(x=x,y=y),
           label = c("Niveau Pauvreté"))+
  xlim(c(-2,2)) +
  ylim(c(-1,2)) + 
  xlab("Axe 1 (19,8 %)") +
  ylab("Axe 2 (9,6 %)") + 
  scale_color_manual(name="Variables (actives)",
                     labels=c("Ménage bénéficiaire\nd'APL ?", "Ménage bénéficiaire\nd'allocation chômage ?",
                              "Ménage bénéficiaire\nde bourse d'étude ?", "Ménage bénéficiaire\nd'une allocation handicap\n/ dépendance ?",
                              "Ménage locataire\nd'un logement social ?", "Ménage bénéficiaire\ndu RSA ?", 
                              "Quintile de niveau\nde vie du ménage", "Ménage recevant\ndes revenus financiers ?", "Ménage recevant\ndes revenus locatifs ?",
                              "Difficultés financières\nperçues","Sentiment ou\nrisque de pauvreté"),
                     values=c(RColorBrewer::brewer.pal(12,"Paired")[-c(11,12)],"#000000")) +
  scale_size_discrete(range=c(4,3)) +
  scale_shape_discrete(name="Dimension de la pauvreté")+
  theme_minimal()

saveRDS(gg_acm_actives,"../rapport/figures/gg_acm_actives.RDS")

gg_acm_actives


gg_acm_passives <- ggplot(data_acm %>% filter(Type=="Supplementary") %>% 
               mutate(Lab=ifelse(Lab=="-Membre du couple (pas d’enfants à charge)","-Membre du couple\n(pas d'enfants à charge)",Lab)) %>% 
              mutate(Lab=ifelse(Lab=="-Membre du couple (enfants à charge)","-Membre du couple\n(enfants à charge)",Lab)) %>% 
               filter(Variable%in%c("annee_fac", "diplome", "prof_statut_act", "vie_fam"))) +
  geom_vline(xintercept = 0, color = "black", linetype = "dotted") +
  geom_hline(yintercept = 0, color = "black", linetype = "dotted") +
  stat_smooth(data=data_acm %>% filter(Type=="Active"),
              aes(x = Coord.x, y = Coord.y), method = "lm", formula = y ~ poly(x, 2), size = 1, se = FALSE, color = "grey") +
  geom_point(data=data_acm %>% filter(Type=="Active"), 
             aes(x = Coord.x, y = Coord.y), color="grey", shape=16) + 
  geom_point(aes(x = Coord.x, y = Coord.y, color=Variable), shape=15, size=3) +
  geom_text_repel(aes(x = Coord.x, y = Coord.y,
                      color=Variable,label=gsub("-","",Lab)),
                  size=3,show.legend=FALSE,
                  max.overlaps = 100, seed=100) +
  xlim(c(-2,2)) +
  ylim(c(-1,2)) + 
    geom_segment(aes(x = -0.55, y = 1.75, xend = 0.55, yend = 1.75), cex=1,
                  arrow = arrow(length = unit(0.5, "cm"))) +
  ggrepel::geom_text_repel(data = data.frame(x=c(0.2),
           y=c(1.7)), size = 3, fontface="bold",
           aes(x=x,y=y),
           label = c("Niveau Pauvreté"))+
  xlab("Axe 1 (19,8 %)") +
  ylab("Axe 2 (9,6 %)") + 
  scale_color_brewer(name="Variables (supplémentaires)", 
                    labels=c("Année","Niveau de diplôme","Situation professionnelle","Vie familiale"),
                    palette="Set1")+
  theme_minimal()


saveRDS(gg_acm_passives,"../rapport/figures/gg_acm_passives.RDS")

gg_acm_passives

```

```{r, echo=FALSE, dev="svglite"}
noms_classes <- c("1","2","3","4","5")
palette <- rev(RColorBrewer::brewer.pal(11, "BrBG")[c(1:5)])

gg_cah <- ggplot(data.frame(res.mca$ind$coord[,c(1,2)] %>% cbind(typo)),
                 aes(x=Dim.1,y=Dim.2)) +
  geom_vline(xintercept = 0, color = "black", linetype = "dotted") +
  geom_hline(yintercept = 0, color = "black", linetype = "dotted") +
  stat_smooth(data=data_acm %>% filter(Type=="Active"),
              aes(x = Coord.x, y = Coord.y), method = "lm", formula = y ~ poly(x, 2), size = 1, se = FALSE, color = "grey") +
  stat_ellipse(aes(color=factor(typo),fill=factor(typo)),type = "norm", linetype = 1, cex=1, geom="polygon", alpha=0.5) +
  geom_point(aes(color=factor(typo)), cex=0.5) +
  ggrepel::geom_label_repel(data = data.frame(x=c(-0.792,-0.471,-0.248,0.232,0.848),
           y=c(0.719,0.180,-0.271,-0.205,0.342)),
           aes(x=x,y=y), label = paste0('Classe ',noms_classes),
           min.segment.length = 0, size=4, fontface="bold",
           nudge_x=c(-1,-1,-1,1,1), seed=1) +
  ggrepel::geom_text_repel(data = data.frame(x=c(-0.792,-0.471,-0.248,0.232,0.848),
           y=c(0.719,0.180,-0.271,-0.205,0.342)),
           aes(x=x,y=y),
           label = c("Richesse importante", "Richesse", "Classes moyennes", "Pauvreté", "Pauvreté importante"), 
           min.segment.length = 1000, size=3, fontface="italic",
           nudge_x=c(-1,-1,-1,1,1), nudge_y = -0.15, seed=1) +
#https://stackoverflow.com/questions/42575769/how-to-modify-the-backgroup-color-of-label-in-the-multiple-ggproto-using-ggplot2
#geom_enterotype(aes(color=factor(typo))) #+
   # ggforce::geom_mark_ellipse(aes(label = paste0("Classe",typo),
  #                       description = paste0("Classe",typo)
  #                   ), color=NA, linetype=1,cex=0,
  #                   #expand=unit(-5,"mm"), radius=unit(0,"mm"),
  #                   label.buffer=unit(0,"mm"),
  #                   label.margin=margin(0,0,0,0,"mm"),
  #                   label.fontsize=8,
  #                   show.legend=FALSE) +
  geom_segment(aes(x = -0.55, y = 1.75, xend = 0.55, yend = 1.75), cex=1,
                  arrow = arrow(length = unit(0.5, "cm"))) +
  ggrepel::geom_text_repel(data = data.frame(x=c(0.2),
           y=c(1.7)), size = 3, fontface="bold",
           aes(x=x,y=y),
           label = c("Niveau Pauvreté"))+
   xlab("Axe 1 (19,8 %)") +
  ylab("Axe 2 (9,6 %)") + 
  scale_color_manual(values=palette) +
  scale_fill_manual(values=palette) +
  guides(colour="none",fill="none") +
  theme_minimal()


saveRDS(gg_cah,"../rapport/figures/gg_cah.RDS")

gg_cah

# ggplot_build(gg_cah)$data[[4]] %>%
#   group_by(group) %>%
#   summarise(x=mean(x),y=mean(y))

```

```{r, echo=FALSE, dev="svglite", fig.width=6, fig.height=7}
x <- creer_x(typo)
gg_cah_bar <- do.call("rbind", 
                 lapply(1:length(x$probs), function(i){
                   df <- x$probs[[i]]
                   df <- data.frame(df)
                   df$var <- names(x$probs)[i]
                   df$typologie=noms_classes
                   return(df)
                   })
  )  %>%
    mutate(Var2=as.numeric(Var2)) %>%
  mutate(Var2=ifelse(var=="m_quantilenivie_inv",6-Var2,Var2)) %>% 
  mutate(Var2=ifelse(!var%in%c("s_sentpauvrisque","m_quantilenivie_inv") & Var2==1,100,Var2)) %>% 
  mutate(Var2=ifelse(!var%in%c("s_sentpauvrisque","m_quantilenivie_inv") & Var2==2,1,Var2)) %>% 
  mutate(Var2=ifelse(!var%in%c("s_sentpauvrisque","m_quantilenivie_inv") & Var2==100,5,Var2)) %>% 
  # mutate(Var2=ifelse(var%in%c("m_financier","m_locatif") & Var2==1,100,Var2)) %>% 
  # mutate(Var2=ifelse(var%in%c("m_financier","m_locatif") & Var2==5,1,Var2)) %>% 
  #   mutate(Var2=ifelse(var%in%c("m_financier","m_locatif") & Var2==100,5,Var2)) %>% 
  mutate(Var2=ifelse(var=="s_sentpauvrisque" & Var2==1,100,ifelse(var=="s_sentpauvrisque" & Var2==3,1,Var2))) %>% 
   mutate(Var2=ifelse(var=="s_sentpauvrisque" & Var2==100,5,Var2)) %>% 
   mutate(Var2=ifelse(var=="s_sentpauvrisque" & Var2==2,3,Var2)) %>%
   mutate(Var2=factor(Var2)) %>% 
    mutate(var=factor(var,
    levels=c("m_quantilenivie_inv","m_locatif_inv","m_financier_inv","s_sentpauvrisque", "s_infminidecla", "i_rsa", "i_log", "i_hlm","i_chom","i_bourse","i_handi") ,
                      labels=c("Quintile de niveau\nde vie du ménage", "Ménage recevant\ndes revenus locatifs ?", "Ménage recevant\ndes revenus financiers ?",
"Sentiment ou\nrisque de pauvreté","Difficultés financières\nperçues",
"Ménage bénéficiaire\ndu RSA ?", "Ménage bénéficiaire\nd'APL ?","Ménage locataire\nd'un logement social ?","Ménage bénéficiaire\nd'allocation chômage ?","Ménage bénéficiaire\nde bourse d'étude ?", "Ménage bénéficiaire\nd'une allocation handicap\n/ dépendance ?")
    )) %>% mutate(typologie=paste0("Classe ", noms_classes[typo],                        "\n(",gsub("\\.",",",round(100*x$P[typo],1))," %)")) %>% 
  ggplot(aes(x=var, y=100*Freq)) +
   geom_rect(aes(fill = typologie),xmin = -Inf,xmax = Inf,ymin = -Inf,ymax = Inf) +
   annotate("rect", xmin = -Inf,xmax = Inf,ymin = -Inf,ymax = Inf, alpha=0.7, fill="white") +
 scale_fill_manual(values=palette,guide="none") +
ggnewscale::new_scale("fill") +
geom_bar(aes(fill=Var2), 
         stat="identity", color="black", width=1,
         position = position_dodge2(width = 1, preserve = "single"))+
  geom_text(aes(fill=Var2, label=round(100*Freq)), vjust=-0.2, color="black",
            position = position_dodge2(width = 1, preserve = "single"), size=3.5)+
    scale_fill_brewer(palette="RdYlGn", direction=1, guide="none") +
  theme_minimal() + 
  scale_y_continuous(breaks=c(0,20,40,60,80,100), expand = c(0, 20)) +
    labs(x = NULL, y = "Part de la population (%)") +
    facet_grid(typologie ~ .) +
    theme(axis.text.x = element_text(angle = 90,vjust = 0.5, hjust=1), 
          strip.text = element_text(face="bold")#aes(colour = typologie)
          )
  
# gg_cah_bar <- ggplot_gtable(ggplot_build(gg_cah_bar))
# strips <- which(grepl('strip-', gg_cah_bar$layout$name))
# pal <- rev(RColorBrewer::brewer.pal(6, "BrBG")[c(1:2,4:6)])
# for (i in seq_along(strips)) {
#   l <- which(grepl('titleGrob', gg_cah_bar$grobs[[strips[i]]]$grobs[[1]]$childrenOrder))
#   gg_cah_bar$grobs[[strips[i]]]$grobs[[1]]$children[[l]]$children[[1]]$gp$col <- pal[i]
# }

saveRDS(gg_cah_bar,"../rapport/figures/gg_cah_bar.RDS")

gg_cah_bar
```

# Notes méthodologiques

Pour ces modèles cinq vagues du Baromètre ont été empilées : 2015, 2016, 2017, 2018 et 2019 (15 137 observations) mais seules **XX XXX** observations sont conservées (celles qui n'ont aucune variable manquante pour l'ensemble des variables utilisées, actives comme supplémentaires).


# Bibliographie {.unnumbered}

- https://quanti.hypotheses.org/1871
- http://larmarange.github.io/analyse-R/classification-ascendante-hierarchique.html
- https://books.openedition.org/enseditions/1462?lang=fr belle illustration de l'effet guttman et des précautions et conclusions à en tirer.