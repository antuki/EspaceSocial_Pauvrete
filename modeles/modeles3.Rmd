---
title: |
    | Fiche de modélisations n°3
subtitle : "Reproduction et actualisation des résultats de l'article de Duvoux et Papuchon"
author: |
    | Kim Antunez
automaticcontents: true
output:
  bookdown::pdf_document2:
        toc: true
        toc_depth: 2
        number_sections: true
        fig_caption: true
        highlight: default
        keep_tex: no
        includes:
          in_header: preamble.tex
themeoptions: "coding=utf8,language=french"
classoption: 'french'
fontsize: 11pt
geometry: margin=0.90in
lang: "french"
documentclass: "article"
---

```{r setup, echo=FALSE, cache=FALSE}
library(knitr)
#library(rmdformats)

## Global options
#options(max.print="75")
opts_chunk$set(echo=TRUE,
	             cache=FALSE,
               prompt=FALSE,
               tidy=FALSE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               fig.width = 5,
               fig.height = 3
               )
options(knitr.kable.NA = '')
#opts_knit$set(width=75)
```


# Objectif

L'objectif de cette troisième série de modèles est de reproduire les résultats statistiques contenus dans l'article de Duvoux et Papuchon afin de s'assurer de bien **comprendre leur démarche empirique**.

# Analyses

\begin{tcolorbox}

Pas grand chose de plus que ce qui est contenu dans leur article. Les résultats de l'article ont pu être reproduits avec parfois des écarts d'un ou deux points de pourcentages sûrement dûs à des petites différences de champs pour certaines variables. Différentes remarques ont été ajoutées au fil du code.

A la fin du document se trouvent les éléments présents dans le mémoire qui actualisent les résultats (modèles 1 et 2) de Duvoux et Papuchon (2018), avec quelques graphiques de statistiques descriptives en complément.

\end{tcolorbox}

# Code et résultats

```{r}
#chargement des packages
library(knitr)
library(dplyr) #manipuler les bases de données
library(tidyr) #pour pivot_longer
library(ggplot2) #pour les graphiques
library(RColorBrewer) #pour les palettes de couleur
```

```{r}
#Chargement de la base de données
bdd2017 <- readRDS("../data/2017/barometre2000_2017_papuchon.rds") %>% 
  filter(annee%in%2015:2017)

```

```{r, eval=FALSE, echo=FALSE}
seuils_min <- c(0,1000,1400,1900,2400,3800,5300)
seuils_max <- c(1000,1400,1900,2400,3800,5300,1000000000000)
seuils_moy <- (seuils_max+seuils_min)/2
seuils <- seuils_max

bdd2017$sdrevcl2 <- ifelse(bdd2017$sdrevtr==1,seuils[1],ifelse(bdd2017$sdrevtr==2,seuils[2],ifelse(bdd2017$sdrevtr==3,seuils[3],ifelse(bdd2017$sdrevtr==4,seuils[4],ifelse(bdd2017$sdrevtr==5,seuils[5],ifelse(bdd2017$sdrevtr==6,seuils[6],ifelse(bdd2017$sdrevtr==7,seuils[7],NA)))))))

# Seuil de pauvreté sur les 3 ans compilés : 857 (880 en 2015, 840 en 2016 et 2017)
0.6*median(ifelse(bdd2017$sdrevcl==999999999,NA,bdd2017$sdrevcl)/bdd2017$sduc, na.rm=TRUE)

#Tests sur les seuils de pauvreté
bdd2017 <- bdd2017 %>% mutate(obj_pauvrete2 = case_when(
      sdrevtr==8 ~ NA,
      sdrevcl/sduc<=seuil_pauvrete ~ TRUE,
      sdrevtr==1 & seuils_max[1]/sduc<=seuil_pauvrete ~ TRUE,
      sdrevtr==2 & seuils_max[2]/sduc<=seuil_pauvrete ~ TRUE,
      sdrevtr==3 & seuils_max[3]/sduc<=seuil_pauvrete ~ TRUE,
      sdrevtr==4 & seuils_max[4]/sduc<=seuil_pauvrete ~ TRUE,
      sdrevtr==5 & seuils_max[5]/sduc<=seuil_pauvrete ~ TRUE,
      sdrevtr==6 & seuils_max[6]/sduc<=seuil_pauvrete ~ TRUE,
      sdrevtr==7 & seuils_max[7]/sduc<=seuil_pauvrete ~ TRUE,
      sdrevtr==1 & seuils_min[1]/sduc>seuil_pauvrete ~ FALSE,
      sdrevtr==2 & seuils_min[2]/sduc>seuil_pauvrete ~ FALSE,
      sdrevtr==3 & seuils_min[3]/sduc>seuil_pauvrete ~ FALSE,
      sdrevtr==4 & seuils_min[4]/sduc>seuil_pauvrete ~ FALSE,
      sdrevtr==5 & seuils_min[5]/sduc>seuil_pauvrete ~ FALSE,
      sdrevtr==6 & seuils_min[6]/sduc>seuil_pauvrete ~ FALSE,
      sdrevtr==7 & seuils_min[7]/sduc>seuil_pauvrete ~ FALSE,
      TRUE ~ NA
))
bdd2017 <- bdd2017 %>% mutate(obj_pauvrete3 = case_when(
      sdrevtr==8 ~ NA,
      sdrevcl!=999999999 & (sdrevcl/sduc<seuil_pauvrete) ~ TRUE,
      sdrevtr==1 & (seuils_max[1]/sduc<seuil_pauvrete) ~ TRUE,
      sdrevtr==2 & (seuils_max[2]/sduc<seuil_pauvrete) ~ TRUE,
      sdrevtr==3 & (seuils_max[3]/sduc<seuil_pauvrete) ~ TRUE,
      sdrevtr==4 & (seuils_max[4]/sduc<seuil_pauvrete) ~ TRUE,
      sdrevtr==5 & (seuils_max[5]/sduc<seuil_pauvrete) ~ TRUE,
      sdrevtr==6 & (seuils_max[6]/sduc<seuil_pauvrete) ~ TRUE,
      sdrevtr==7 & (seuils_max[7]/sduc<seuil_pauvrete) ~ TRUE,
      TRUE ~ FALSE
))


```

## Graphique 1 (p.8)

```{r}
revenus_a_imputer <- bdd2017 %>%
  mutate(sdrevcl = ifelse(sdrevcl==999999999,NA,sdrevcl)) %>%
  group_by(sdrevtr) %>% 
  summarise(sdrevcl = mean(sdrevcl,na.rm=TRUE))


bdd2017 <- bdd2017 %>% 
  mutate(
    sdrevcl_imput_moy = case_when(
      sdrevcl!=999999999 ~ sdrevcl,
      sdrevcl==999999999 & sdrevtr==1 ~ revenus_a_imputer$sdrevcl[1],
      sdrevcl==999999999 & sdrevtr==2 ~ revenus_a_imputer$sdrevcl[2],
      sdrevcl==999999999 & sdrevtr==3 ~ revenus_a_imputer$sdrevcl[3],
      sdrevcl==999999999 & sdrevtr==4 ~ revenus_a_imputer$sdrevcl[4],
      sdrevcl==999999999 & sdrevtr==5 ~ revenus_a_imputer$sdrevcl[5],
      sdrevcl==999999999 & sdrevtr==6 ~ revenus_a_imputer$sdrevcl[6],
      sdrevcl==999999999 & sdrevtr==7 ~ revenus_a_imputer$sdrevcl[7]
             )
  )

bdd2017 <- bdd2017 %>% 
   mutate(seuil_pauvrete = do.call(c,lapply(annee,function(annee_selec){
0.6*median(bdd2017[bdd2017$annee==annee_selec,"sdrevcl_imput_moy"]/bdd2017[bdd2017$annee==annee_selec,"sduc"],
           na.rm=TRUE)
}
))) %>% 
    mutate(subj_inf_mini_decla = sdrevcl_imput_moy - ifelse(pe16==999999999,NA,pe16) <0) %>% 
  mutate(subj_pauvrete = 
           ifelse(pe3==3, TRUE,ifelse(pe3==4,NA,FALSE))) %>% 
  mutate(subj_besoin_aide_etat =
                   ifelse(pe15==2, TRUE,ifelse(pe15==4,NA,FALSE))) %>%
  mutate(obj_pauvrete= sdrevcl_imput_moy/sduc<seuil_pauvrete)
```

```{r}
data_g1 <- bdd2017 %>%
  group_by(annee) %>%
    summarise(subj_pauvrete = round(100*weighted.mean(subj_pauvrete,
                                                             poids, na.rm=TRUE)),
              subj_inf_mini_decla = round(100*weighted.mean(subj_inf_mini_decla,
                                                             poids, na.rm=TRUE)),
            obj_pauvrete = round(100*weighted.mean(obj_pauvrete,
                                                             poids, na.rm=TRUE)),
              
              subj_besoin_aide_etat = round(100*weighted.mean(subj_besoin_aide_etat,
                                                         poids, na.rm=TRUE))
              ) 

ggplot(data=data_g1 %>% tidyr::pivot_longer(!annee),
       aes(x=name, y=value, fill=annee)) +
  geom_bar(stat="identity", position=position_dodge())+
  geom_text(aes(label=value), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+
  scale_fill_brewer(palette="Paired")+
  theme_minimal() +
  scale_x_discrete(name ="",
                   limits=c("subj_pauvrete","obj_pauvrete",
                            "subj_besoin_aide_etat",
                            "subj_inf_mini_decla"),
                   labels=c(
      "obj_pauvrete" = "Pauvreté\nmonétaire\nobjective",
      "subj_inf_mini_decla" = "Niveau de vie\ninf. au minimum\ndéclaré",
      "subj_besoin_aide_etat"="Besoin de\nplus d'aide\npublique",
      "subj_pauvrete" = "Sentiment\nde pauvreté"))+
  ggtitle("Graphique 1 : Différents indicateurs de pauvreté") + ylab("")+
  labs(fill="Année")
```


Commentaires : 

- Les NSP sont exclus du champ pour `subj_pauvrete`, pour `subj_inf_mini_decla`  mais apparemment pas pour `subj_besoin_aide_etat`. Il faudrait le faire aussi (correction dans le graphique qui suit). 
- Il est intéressant de voir que le fait de prendre en compte ou non le "0" dans la différence entre le revenu réel et le minimum pour vivre fait varier significativement l'indicateur `subj_inf_mini_decla` (l'augmenterait d'une dizaine de points)
- Il est possible d'imputer le revenu d'une autre façon que celle proposée dans l'article de Duvoux et Papuchon (ils proposent l'imputation par la moyenne des revenus en clairs par tranche). Nous avons utilisé une autre méthode d'imputation (documentation à préciser) pour tester dans le graphique ci-après. 



```{r, echo=FALSE}
bdd20172 <- readRDS("../data/2019/barometre2000_2019_diff.rds") 

bdd20172 <- bdd20172 %>% 
  filter(annee%in%2015:2017) %>% 
  # mutate(
  #   sdrevcl_imput_moy = case_when(
  #     sdrevcl!=999999999 ~ sdrevcl,
  #     sdrevcl==999999999 & sdrevtr==1 ~ revenus_a_imputer$sdrevcl[1],
  #     sdrevcl==999999999 & sdrevtr==2 ~ revenus_a_imputer$sdrevcl[2],
  #     sdrevcl==999999999 & sdrevtr==3 ~ revenus_a_imputer$sdrevcl[3],
  #     sdrevcl==999999999 & sdrevtr==4 ~ revenus_a_imputer$sdrevcl[4],
  #     sdrevcl==999999999 & sdrevtr==5 ~ revenus_a_imputer$sdrevcl[5],
  #     sdrevcl==999999999 & sdrevtr==6 ~ revenus_a_imputer$sdrevcl[6],
  #     sdrevcl==999999999 & sdrevtr==7 ~ revenus_a_imputer$sdrevcl[7]
  #            )
  # )  %>% 
#    mutate(seuil_pauvrete = do.call(c,lapply(annee,function(annee_selec){
# 0.6*median(bdd2017[bdd2017$annee==annee_selec,"sdrevcl_imput_moy"]/bdd2017[bdd2017$annee==annee_selec,"sduc"],na.rm=TRUE)
# }
# ))) %>%  #NEW
     mutate(seuil_pauvrete = do.call(c,lapply(annee,function(annee_selec){
0.6*median(ifelse(bdd20172[bdd20172$annee==annee_selec,"sdrevcl_imput"]==999999999,NA,bdd20172[bdd20172$annee==annee_selec,"sdrevcl_imput"])/bdd20172[bdd20172$annee==annee_selec,"sduc"],
           na.rm=TRUE)
}
))) %>% 
  mutate(subj_inf_mini_decla = sdrevcl_imput - ifelse(pe16==999999999,NA,pe16) <0) %>% 
    # mutate(subj_inf_mini_decla = factor(
    #  sdrevcl_imput_moy - ifelse(pe16==999999999,NA,pe16) <0,
    #  levels=c(TRUE,FALSE),
    #  labels=paste0("-",c("Rev. inf. au minimum décla.","Rev. sup. au minimum décla.")))
    #  ) %>% 
  mutate(subj_pauvrete = 
           ifelse(pe3==3, TRUE,ifelse(pe3==4,NA,FALSE))) %>% 
    mutate(subj_besoin_aide_etat = ifelse(pe15==2,     TRUE,ifelse(pe15%in%c(3),NA,FALSE))) %>% 
  mutate(obj_pauvrete= sdrevcl_imput/sduc<seuil_pauvrete)
```

```{r, echo=FALSE}
data2_g1 <- bdd20172 %>%
  group_by(annee) %>%
    summarise(subj_pauvrete = round(100*weighted.mean(subj_pauvrete,
                                                             poids, na.rm=TRUE)),
              subj_inf_mini_decla = round(100*weighted.mean(subj_inf_mini_decla,
                                                             poids, na.rm=TRUE)),
              
              
              
              
            obj_pauvrete = round(100*weighted.mean(obj_pauvrete,
                                                             poids, na.rm=TRUE)),
              
              subj_besoin_aide_etat = round(100*weighted.mean(subj_besoin_aide_etat,
                                                         poids, na.rm=TRUE))
              ) 

ggplot(data=data2_g1 %>% tidyr::pivot_longer(!annee),
       aes(x=name, y=value, fill=annee)) +
  geom_bar(stat="identity", position=position_dodge())+
  geom_text(aes(label=value), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+
  scale_fill_brewer(palette="Paired")+
  theme_minimal() +
  scale_x_discrete(name ="",
                   limits=c("subj_pauvrete","obj_pauvrete",
                            "subj_besoin_aide_etat",
                            "subj_inf_mini_decla"),
                   labels=c(
      "obj_pauvrete" = "Pauvreté\nmonétaire\nobjective",
      "subj_inf_mini_decla" = "Niveau de vie\ninf. au minimum\ndéclaré",
      "subj_besoin_aide_etat"="Besoin de\nplus d'aide\npublique",
      "subj_pauvrete" = "Sentiment\nde pauvreté"))+
  ggtitle("Graphique 1 (corrigé) : Différents indicateurs de pauvreté") + ylab("")+
  labs(fill="Année")
```


## Graphique 2 (p.16) et Tableau 2 (p.17)


```{r, eval=FALSE, echo=FALSE}
#### Erreur non détectée dans ce code pour l'ancien codage PCS. A creuser
# bdd2017 <- bdd2017 %>% 
#   mutate(
#     PCS_recode = case_when(
#       sdpcs7%in%c(5,6) & (sdstatemp%in%c(1,2) | sdsitua==2) ~ "Employés et ouvriers précaires ou temps partiels",
#       sdpcs7%in%c(5,6) & sdpcs10==8 ~ "Employés et ouvriers à la retraite", #sdsitua==6
#       sdsitua==1 & !(sdpcs7%in%c(5,6) & (sdstatemp%in%c(2,3,4) | sdsitua%in%c(2,3,5))) ~ "En emploi à temps plein",
#      sdpcs7%in%c(5,6) & sdsitua==4  ~ "Employés et ouvriers au chômage", #sdstat==5 sdpcs10==7
#       sdsitua==7 ~ "Sans activité professionnelle",
#       TRUE                      ~  "Autres"
#     )
#   )
```

```{r}
bdd2017 <- bdd2017 %>% 
  mutate(
    prof_exercee_ou_derniere = case_when(
      sdpcs7%in%c(1,2) ~ "Agriculteurs, artisans et commerçants",
      sdpcs7%in%c(3) ~ "Cadre supérieur, profession libérale",
      sdpcs7%in%c(4) ~ "Profession intermédiaire",
      sdpcs7%in%c(5) ~ "Employé",
      sdpcs7%in%c(6) ~ "Ouvrier",
      sdpcs7%in%c(7) ~ "Autres (n'ayant jamais travaillé)"
    )
  ) %>% 
  mutate(
    activite_actuelle = case_when(
      sdsitua==4 ~ "Chômeur",
      sdsitua==6 ~ "Retraité",
      (sdsitua==1 & sdstatemp!=1) | sdsitua%in%c(2,3) ~
        "Emploi précaire/temps partiel",
      TRUE #sdsitua%in%c(5,7) | (sdsitua==1 & sdstatemp==1) incomplet
      ~
        "Autres (CDI à temps plein, étudiants en formations et personnes n'ayant jamais travaillé)"
    )
  )%>% 
  mutate(
    PCS_recode = case_when(
      prof_exercee_ou_derniere%in%c("Employé","Ouvrier") & activite_actuelle=="Emploi précaire/temps partiel" ~
        "Employés et ouvriers\nprécaires ou\ntemps partiels",
      prof_exercee_ou_derniere%in%c("Employé","Ouvrier") & activite_actuelle=="Retraité" ~
        "Employés et ouvriers\nà la retraite", #sdsitua==6
      prof_exercee_ou_derniere%in%c("Employé","Ouvrier") & activite_actuelle=="Chômeur"  ~
        "Employés et ouvriers\nau chômage",
      sdsitua==1 & !(prof_exercee_ou_derniere%in%c("Employé","Ouvrier") & activite_actuelle=="Emploi précaire/temps partiel") ~ "En emploi à temps plein",
      sdsitua%in%c(7)  ~ "Sans activité\nprofessionnelle",
      TRUE                      ~  "Autres"
    )
  )
```

```{r}
tab_croise_g2 <- questionr::cprop(questionr::wtd.table(
  bdd2017$PCS_recode,bdd2017$subj_pauvrete, weights = bdd2017$poids))

data_g2 <- data.frame(
  group=row.names(tab_croise_g2)[-nrow(tab_croise_g2)],
  value=tab_croise_g2[,2][-nrow(tab_croise_g2)]
) %>% 
  arrange(desc(group)) %>%
  mutate(ypos = cumsum(value)- 0.5*value) %>% 
  mutate(labels=paste0(group,"\n(",round(value,0)," %)"))

ggplot(data_g2, aes(x="", y=value, fill=group)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  theme_void() + 
  theme(legend.position="none",
         plot.title = element_text(size=10)) +
  geom_text(aes(y = ypos, label = labels), color = "black", size=2) +
  scale_fill_brewer(palette="Set3") + 
  labs(title = "Graphique 2  : Qui sont les personnes\nqui se sentent pauvres ?")
```


```{r}
tab_croise_t2a <- questionr::cprop(questionr::wtd.table(bdd2017$prof_exercee_ou_derniere,
                                                        bdd2017$subj_pauvrete,
                                                        weights = bdd2017$poids)
                                   )[c(1,3,6,4,5,2,7),c(2,1)]

tab_croise_t2b <- questionr::cprop(questionr::wtd.table(bdd2017$activite_actuelle,
                                                        bdd2017$subj_pauvrete,
                                                        weights = bdd2017$poids)
                                   )[c(2,4,3,1,5),c(2,1)]

data_t2 <- round(rbind(tab_croise_t2a,tab_croise_t2b),0)
colnames(data_t2)<-c("Se sent pauvre","Ne se sent pas pauvre")

data_t2 %>% 
  kable(caption="Tableau 2 - Statut d’activité et dernière profession exercée des personnes qui se disent pauvres, par rapport au reste de la population") %>%
   kableExtra::column_spec(1, width = "9cm") %>% 
   kableExtra::column_spec(2, width = "3cm") %>% 
   kableExtra::column_spec(3, width = "3cm") 

```


- Il y a des petits écarts d'un point ou deux pour le camembert. Le codage n'est pas très clair (ce qui est compté dans autres et dans sans activité professionnelle).

## Graphiques 3 (p.23), 4 (p.24) et 5 (p.25) 

```{r}
bdd2017 <- bdd2017 %>% 
  mutate(
    sitfam = case_when(
      sdsitfam==2 ~ "Membre du couple",
      sdsitfam==1 ~ "Vie seule",
      sdsitfam==3 ~ "Famille monoparentale",
      sdsitfam%in%c(4,5,6,7) ~ "Autre situation (enfant de la famille,\nami ou parent hébergé, colocataire)" 
      #pas précisé si prise compte de 7 mais très peu d'individus
    )
  ) %>% 
  mutate(
    crois_pauvrete_obj_subj = case_when(
      !subj_pauvrete & !obj_pauvrete & !is.na(subj_pauvrete) & !is.na(obj_pauvrete)  ~
        "Au-dessus du seuil\net ne se sent pas pauvre",
      !subj_pauvrete & obj_pauvrete & !is.na(subj_pauvrete) & !is.na(obj_pauvrete) ~
        "Sous le seuil\nmais ne se sent pas pauvre",
      subj_pauvrete & !obj_pauvrete & !is.na(subj_pauvrete) & !is.na(obj_pauvrete) ~
        "Au-dessus du seuil\nmais se sent pauvre",
      subj_pauvrete & obj_pauvrete & !is.na(subj_pauvrete) & !is.na(obj_pauvrete)~
        "Pauvreté monétaire\net ressentie"
    )
  )
```


```{r,eval=TRUE, fig.height=4, fig.width=10}
data_g3 <- data.frame(
  round(
    questionr::cprop(
      questionr::wtd.table(bdd2017$sitfam,
                           bdd2017$crois_pauvrete_obj_subj,
                           weights=bdd2017$poids)
    )[-5,-5]
  )
) %>% mutate(Var1 = factor(Var1,levels=c(
  "Membre du couple", "Vie seule",
  "Famille monoparentale",
  "Autre situation (enfant de la famille,\nami ou parent hébergé, colocataire)"
)))


ggplot(data=data_g3,
       aes(x=Var2, y=Freq, fill=Var1)) +
  geom_bar(stat="identity", position=position_dodge())+
  geom_text(aes(label=Freq), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+
  scale_fill_brewer(palette="Paired")+
  theme_minimal() +
  scale_x_discrete(name ="",
                   limits=c("Au-dessus du seuil\net ne se sent pas pauvre",
                            "Sous le seuil\nmais ne se sent pas pauvre",
                            "Au-dessus du seuil\nmais se sent pauvre",
                            "Pauvreté monétaire\net ressentie"))+
  ggtitle("Graphique 3 : Situation familiale en fonction des indicateurs
de pauvreté monétaire et ressentie") + ylab("")+
  labs(fill="Situation familiale")
```


```{r,eval=TRUE, fig.height=4, fig.width=10}
data_g4 <- data.frame(
  round(
    questionr::cprop(
      questionr::wtd.table(bdd2017$sitfam[bdd2017$sdsexe==1],
                           bdd2017$crois_pauvrete_obj_subj[bdd2017$sdsexe==1],
                           weights=bdd2017$poids[bdd2017$sdsexe==1])
    )[-5,-5]
  )
) %>% mutate(Var1 = factor(Var1,levels=c(
  "Membre du couple", "Vie seule",
  "Famille monoparentale",
  "Autre situation (enfant de la famille,\nami ou parent hébergé, colocataire)"
)))


ggplot(data=data_g4,
       aes(x=Var2, y=Freq, fill=Var1)) +
  geom_bar(stat="identity", position=position_dodge())+
  geom_text(aes(label=Freq), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+
  scale_fill_brewer(palette="Paired")+
  theme_minimal() +
  scale_x_discrete(name ="",
                   limits=c("Au-dessus du seuil\net ne se sent pas pauvre",
                            "Sous le seuil\nmais ne se sent pas pauvre",
                            "Au-dessus du seuil\nmais se sent pauvre",
                            "Pauvreté monétaire\net ressentie"))+
  ggtitle("Graphique 4 : Situation familiale DES HOMMES en fonction des indicateurs
de pauvreté monétaire et ressentie") + ylab("")+
  labs(fill="Situation familiale")
```

```{r,eval=TRUE, fig.height=4, fig.width=10}
data_g4 <- data.frame(
  round(
    questionr::cprop(
      questionr::wtd.table(bdd2017$sitfam[bdd2017$sdsexe==2],
                           bdd2017$crois_pauvrete_obj_subj[bdd2017$sdsexe==2],
                           weights=bdd2017$poids[bdd2017$sdsexe==2])
    )[-5,-5]
  )
) %>% mutate(Var1 = factor(Var1,levels=c(
  "Membre du couple", "Vie seule",
  "Famille monoparentale",
  "Autre situation (enfant de la famille,\nami ou parent hébergé, colocataire)"
)))


ggplot(data=data_g4,
       aes(x=Var2, y=Freq, fill=Var1)) +
  geom_bar(stat="identity", position=position_dodge())+
  geom_text(aes(label=Freq), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+
  scale_fill_brewer(palette="Paired")+
  theme_minimal() +
  scale_x_discrete(name ="",
                   limits=c("Au-dessus du seuil\net ne se sent pas pauvre",
                            "Sous le seuil\nmais ne se sent pas pauvre",
                            "Au-dessus du seuil\nmais se sent pauvre",
                            "Pauvreté monétaire\net ressentie"))+
  ggtitle("Graphique 5 : Situation familiale DES FEMMES en fonction des indicateurs
de pauvreté monétaire et ressentie") + ylab("")+
  labs(fill="Situation familiale")
```


- Encore des écarts d'un point maximum par rapport aux données de l'article. 

## Tableaux 4 (p.26) et 5 (p.27)

- Dans l'article, la notion d'assistance est décrite comme la réception du RSA, d'allocation chômage (mais cet élément est absent des régressions, seul le statut chômeur est mentionné) ou de prestations liées au handicap, validité et dépendance. L'aide au logement n'est pas prise en compte


```{r}
#sdres_3 : RSA, sdres_4 : chômage, sdres_10 : handicap dépdce.
bdd2017 <- bdd2017 %>% 
  mutate(
    assistance = case_when(
      sdres_3==1 | sdres_4==1 | sdres_10==1 ~ TRUE,
      sdres_3==2 & sdres_4==2 & sdres_10==2 ~ FALSE,
      TRUE ~ NA
      )
  ) %>% 
  mutate(
    pessimisme = case_when(
      og3_1%in%c(1,2) ~ FALSE,
      og3_1%in%c(3,4) ~ TRUE,
      og3_1%in%c(5) ~ NA
      )
  ) %>% 
  mutate(
    declassement = case_when(
      og2_ab%in%c(1,2) | og2_cd%in%c(4,5)  ~ TRUE,
      og2_ab%in%c(3,4,5) | og2_cd%in%c(1,2,3) ~ FALSE,
      og2_ab%in%c(6) | og2_cd%in%c(6) ~ NA
      )
  ) 

```

```{r}
data_t4 <- data.frame(round(cbind(
#colonne1
questionr::rprop(questionr::wtd.table(bdd2017$subj_pauvrete[bdd2017$obj_pauvrete],
                                      bdd2017$pessimisme[bdd2017$obj_pauvrete],
                                      weights=bdd2017$poids[bdd2017$obj_pauvrete]))[c(1,2,3),2],
#colonne2
questionr::rprop(questionr::wtd.table(bdd2017$subj_pauvrete[!bdd2017$obj_pauvrete],
                                      bdd2017$pessimisme[!bdd2017$obj_pauvrete],
                                      weights=bdd2017$poids[!bdd2017$obj_pauvrete]))[c(1,2,3),2],
#colonne3
questionr::rprop(questionr::wtd.table(bdd2017$subj_pauvrete[!bdd2017$assistance],
                                      bdd2017$pessimisme[!bdd2017$assistance],
                                      weights=bdd2017$poids[!bdd2017$assistance]))[c(1,2,3),2],
#colonne4
questionr::rprop(questionr::wtd.table(bdd2017$subj_pauvrete[bdd2017$assistance],
                                      bdd2017$pessimisme[bdd2017$assistance],
                                      weights=bdd2017$poids[bdd2017$assistance]))[c(1,2,3),2],
#colonne5
questionr::rprop(questionr::wtd.table(bdd2017$subj_pauvrete,
                                      bdd2017$pessimisme,
                                      weights=bdd2017$poids))[c(1,2,3),2]
)))
row.names(data_t4) <- c("Ne se déclare pas pauvre", "Se déclare pauvre", "Ensemble")
colnames(data_t4) <- c("Sous le seuil de pauvreté", "Au-dessus du seuil de pauvreté",
                       "Pas en situation d'assistance", "Situation d'assistance", "Ensemble")
data_t4 %>% 
  kable(caption="Tableau 4 : Pauvreté et trajectoire sociale escomptée") %>%
   kableExtra::column_spec(1, width = "4cm") %>% 
   kableExtra::column_spec(2:5, width = "2cm")
```

```{r,eval=FALSE}
data_t5 <- data.frame(round(cbind(
#colonne1
questionr::rprop(questionr::wtd.table(bdd2017$subj_pauvrete[bdd2017$obj_pauvrete],
                                      bdd2017$declassement[bdd2017$obj_pauvrete],
                                      weights=bdd2017$poids[bdd2017$obj_pauvrete]))[c(1,2,3),2],
#colonne2
questionr::rprop(questionr::wtd.table(bdd2017$subj_pauvrete[!bdd2017$obj_pauvrete],
                                      bdd2017$declassement[!bdd2017$obj_pauvrete],
                                      weights=bdd2017$poids[!bdd2017$obj_pauvrete]))[c(1,2,3),2],
#colonne3
questionr::rprop(questionr::wtd.table(bdd2017$subj_pauvrete[!bdd2017$assistance],
                                      bdd2017$declassement[!bdd2017$assistance],
                                      weights=bdd2017$poids[!bdd2017$assistance]))[c(1,2,3),2],
#colonne4
questionr::rprop(questionr::wtd.table(bdd2017$subj_pauvrete[bdd2017$assistance],
                                      bdd2017$declassement[bdd2017$assistance],
                                      weights=bdd2017$poids[bdd2017$assistance]))[c(1,2,3),2],
#colonne5
questionr::rprop(questionr::wtd.table(bdd2017$subj_pauvrete,
                                      bdd2017$declassement,
                                      weights=bdd2017$poids))[c(1,2,3),2]
)))
row.names(data_t5) <- c("Ne se déclare pas pauvre", "Se déclare pauvre", "Ensemble")
colnames(data_t5) <- c("Sous le seuil de pauvreté", "Au-dessus du seuil de pauvreté",
                       "Pas en situation d'assistance", "Situation d'assistance", "Ensemble")
data_t5 %>% 
  kable(caption="Tableau 5 : Pauvreté et trajectoire sociale perçue")%>%
   kableExtra::column_spec(1, width = "4cm") %>% 
   kableExtra::column_spec(2:5, width = "2cm")
```

- Encore des écarts par rapport aux données de l'article (monte jusqu'à deux points). 

## Tableau 6 (p.28)

```{r}
bdd2017 <- bdd2017 %>% 
  mutate(
    proprietaire = case_when(
      lo1==1 ~ TRUE,
      lo1%in%c(2,3,4) ~ FALSE,
      lo1==5 ~ NA
      )
  ) %>% 
  mutate(
    retraite = case_when(
      sdsitua==6 ~ TRUE,
       TRUE ~ FALSE
    )
  )
```


```{r}

data_t6 <- data.frame(round(cbind(
#colonne1
questionr::rprop(questionr::wtd.table(bdd2017$proprietaire[bdd2017$retraite],
                                      bdd2017$subj_pauvrete[bdd2017$retraite],
                                      weights=bdd2017$poids[bdd2017$retraite]))[c(2,1,3),2],
#colonne2
questionr::rprop(questionr::wtd.table(bdd2017$proprietaire[!bdd2017$retraite],
                                      bdd2017$subj_pauvrete[!bdd2017$retraite],
                                      weights=bdd2017$poids[!bdd2017$retraite]))[c(2,1,3),2]
)))
row.names(data_t6) <- c("Propriétaires", "Non-propriétaires", "Ensemble")

colnames(data_t6) <- c("Retraités", "Non-retraités")


data_t6 %>% 
  kable(caption="Tableau 6 : Les retraités non propriétaires particulièrement surexposés au sentiment de pauvreté")%>%
   kableExtra::column_spec(1, width = "4cm") %>% 
   kableExtra::column_spec(2:3, width = "3cm")
```

- Mêmes pourcentages que dans l'article 

## Tableau 1 -- Modèle 1 (p.13) et Tableau 3 -- Modèle 2 (p.22)

```{r}
bdd2017_logit <- bdd2017 %>% 
 mutate(nivie = sdrevcl_imput_moy/sduc) %>% 
 mutate(quantile_nivie = factor(
    cut(sdrevcl_imput_moy/sduc, include.lowest=TRUE,
        breaks=quantile(sdrevcl_imput_moy/sduc,
                        probs=seq(0,1,0.2),na.rm=TRUE),
        labels=1:5),
    levels=c(2,1,3,4,5),
    labels=paste0("-Quintile ",c(2,1,3,4,5)))
  ) %>% 
  mutate(
    statact = factor(case_when(
      sdsitua==1 & sdstatemp%in%c(1)   ~ 1,
      sdsitua%in%c(2,3) | (sdsitua==1 & sdstatemp%in%c(NA,2,3,4,5)) ~ 2,
      sdsitua==4 ~ 3,
      sdsitua==5 ~ 4,
      sdsitua==6 ~ 5,
      sdsitua==7 ~ 6,
      TRUE ~ NA_real_
    ),
    levels=1:6,
    labels=paste0("-",
                  c("CDI temps plein",
                    "Emploi précaire ou à temps partiel",
                    "Recherche d’emploi",
                    "Étudiant",
                    "Retraité",
                    "Aucune activité professionnelle"))
    )) %>% 
  mutate(prof = factor(
    #ifelse(sdpcs7!=7,sdpcs7,NA),
    sdpcs7,
    levels=c(4,1,2,3,5,6,7),
    labels=paste0("-",c("Profession intermédiaire","Agriculteur",
                        "Artisan commerçant","Cadre supérieur, profession libérale",
                        "Employé","Ouvrier","Aucune"))
  )) %>%
  # fastDummies::dummy_cols(select_columns = 'prof') %>% 
  mutate(
    diplome = factor(case_when(
      sddipl%in%c(1,2,3,4) ~ 1,
      sddipl%in%c(5,6) ~ 2,
      sddipl%in%c(7) ~ 3,
      sddipl%in%c(8) ~ 4,
      TRUE ~ NA_real_
    ),
    levels=c(2,1,3,4),
    labels=paste0("-",c("Baccalauréat","CAP, BEP ou moins","Bac + 2","Bac + 3 ou plus"))
    )) %>% 
  mutate(aide_log = factor(
    ifelse(sdres_9!=3,sdres_9,NA),
    levels=c(2,1),
    labels=paste0("-",c("Pas d'aide au logement","Aide au logement reçue"))
  )) %>% 
  mutate(aide_rsa = factor(
    ifelse(sdres_3!=3,sdres_3,NA),
    levels=c(2,1),
    labels=paste0("-",c("Pas de RSA","RSA reçu"))
  )) %>% 
  mutate(aide_handi = factor(
    ifelse(sdres_10!=3,sdres_10,NA),
    levels=c(2,1),
    labels=paste0("-",c("Pas d'alloc. hand./invalid./dépend.",
                        "Alloc. hand./invalid./dépend. reçu"))
  )) %>% 
  mutate(sexe = factor(
    ifelse(sdsexe!=3,sdsexe,NA),
    levels=c(2,1),
    labels=paste0("-",c("Femme","Homme"))
  )) %>% 
  mutate(age_tranche = factor(
    cut(sdage,
        breaks=c(18,30,40,50,60,70,120),
        include.lowest=TRUE,
        labels=1:6),
    levels=c(2,1,3,4,5,6),
    labels=paste0("-",c("30 à 39 ans","18 à 29 ans","40 à 49 ans",
                        "50 à 59 ans","60 à 69 ans", "70 ans et plus")))
  ) %>% 
  mutate(
    vie_fam = factor(case_when(
      sdsitfam==1 ~ 1,
      sdsitfam==2 & sdnbenf==0 ~ 2, #attention dépend des bases
      sdsitfam==2 & sdnbenf!=0 ~ 3, #attention dépend des bases
      sdsitfam==3 ~ 4,
      sdsitfam==4 ~ 5,
      sdsitfam%in%c(5,6,7) ~ 6,
      TRUE ~ NA_real_
    ),
    levels=c(2,1,3,4,5,6),
    labels=paste0("-",
                  c("Membre du couple (pas d’enfants à charge)","Vit seul",
                    "Membre du couple (enfants à charge)", "Chef famille monoparentale",
                    "Enfant","Autre"))
    )) %>% 
  mutate(
    statut_occup0 = factor(case_when(
      lo1%in%c(2,3,4)  ~ 1,
      lo1==1 ~ 2,
      lo1==5 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Locataire ou hébergé","Propriétaire ")) 
    )) %>% 
  mutate(annee_fac = factor(annee,labels=paste0("-",2015:2017))) %>% 
  mutate(pauvrete_mon_rel= factor(
    ifelse(sdrevcl_imput_moy/sduc<seuil_pauvrete,3,
                                  ifelse(sdrevcl_imput_moy/sduc>=1.2*seuil_pauvrete,1,
                                         ifelse(sdrevcl_imput_moy/sduc<1.2*seuil_pauvrete &
                                                  sdrevcl_imput_moy/sduc>=seuil_pauvrete ,
                                                2,NA)
                                  )),
    levels=c(1,2,3),
    labels=paste0("-",c("Revenus > 20 pourcents seuil pauvreté",
                        "Entre le seuil et 20 pourcents au dessus",
                        "Pauvreté monétaire"))
  )
  )

```


Modèle 1

```{r}
reg1 <- glm(subj_pauvrete ~ quantile_nivie + aide_log +
             aide_rsa + aide_handi + statact + 
             prof + diplome + vie_fam +
             statut_occup0 + sexe + age_tranche + annee_fac,
           data = bdd2017_logit %>% select(`subj_pauvrete`, `quantile_nivie`,
                                       `statact`, `prof`,`diplome`, `aide_log`, `aide_rsa`,
                                       `aide_handi`, `sexe`, `age_tranche`,
                                       `vie_fam`, `statut_occup0`, `annee_fac`
                                       ) %>% tidyr::drop_na(),
           family = binomial(logit))
results1 <- summary(reg1)$coefficients
modalites1 <- c("(Intercept)")
for(var in c("quantile_nivie", "aide_log", "aide_rsa",
             "aide_handi", "statact", "prof","diplome", 
             "vie_fam","statut_occup0", "sexe", "age_tranche",
             "annee_fac")){
  modalites1 <- c(modalites1,gsub("-","",levels(bdd2017_logit[,var])))
  
}


df_model1 <- data.frame(noms= c("-(Intercept)",row.names(results1)[-1]),
           valeur=round(results1[,1],2),
           pvaleur=cut(results1[,4], breaks = c(0, 0.001, 0.01, 0.05, 1),
                       include.lowest = T,
                       labels = c('***', '**', '*', '')),
           row.names=NULL
) %>% mutate(noms = gsub("`","",noms)) %>%  
  tidyr::separate(noms,c("variable","modalite"),sep="-") %>% 
   # mutate(odds=ifelse(is.na(pvaleur) | pvaleur=='',NA,round(exp(results1[,1]),2))) %>% 
    mutate(odds=round(exp(results1[,1]),2)) %>% 
  right_join(data.frame(modalite=modalites1),by="modalite") %>% 
  arrange(match(modalite, modalites1))

R2_ajuste1 <- with(summary(reg1), 1 - deviance/null.deviance)
N1 <- length(summary(reg1)$deviance.resid)

df_model1 %>% select(-variable) %>%
  kable(format = 'latex', booktabs = TRUE, longtable = TRUE,
  caption="Tableau 1 - Les déterminants du sentiment de pauvreté (Modèle 1)
") %>%  
   kableExtra::column_spec(1, width = "4cm") %>% 
   kableExtra::column_spec(2:4, width = "2cm") %>% 
kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header")) %>% 
     kableExtra::footnote(paste0("Modèle logit (Variable dépendante = Se déclarer pauvre) / N = ",
                                 N1," / R2 ajusté = ",
                                 round(100*R2_ajuste1,1)," %")) 

```


Modèle 2


```{r}
#On remplace la tranche d'âge par l'âge
#On remplace les quantiles de niveau de vie par pauvrete monétaire relative
#On enlève l'assistance
reg2 <- glm(subj_pauvrete ~ sdage + pauvrete_mon_rel + diplome + statact +
              sexe + prof + vie_fam +  statut_occup0 + annee_fac,
        data = bdd2017_logit %>% select(`subj_pauvrete`, `sdage`,  `pauvrete_mon_rel`, `statact`, `prof`,`diplome`, `sexe`,
                                        `vie_fam`, `statut_occup0`, `annee_fac`
            ) %>% tidyr::drop_na(),
            family = binomial(logit))

results2 <- summary(reg2)$coefficients
modalites2 <- c("(Intercept)","sdage")
for(var in c("sdage","pauvrete_mon_rel","diplome", "statact", "sexe",
             "prof","vie_fam","statut_occup0", "annee_fac")){
  modalites2 <- c(modalites2,gsub("-","",levels(bdd2017_logit[,var])))
  
}

df_model2 <- data.frame(noms= c("-(Intercept)","-sdage",row.names(results2)[-c(1,2)]),
                        valeur=round(results2[,1],2),
                        pvaleur=cut(results2[,4], breaks = c(0, 0.001, 0.01, 0.05, 1),
                                    include.lowest = T,
                                    labels = c('***', '**', '*', '')),
                        row.names=NULL
) %>% mutate(noms = gsub("`","",noms)) %>%  
  tidyr::separate(noms,c("variable","modalite"),sep="-") %>% 
  #mutate(odds=ifelse(is.na(pvaleur) | pvaleur=='',NA,round(exp(results2[,1]),2))) %>% 
  mutate(odds=round(exp(results2[,1]),2)) %>% 
right_join(data.frame(modalite=modalites2),by="modalite") %>% 
  arrange(match(modalite, modalites2))

R2_ajuste2 <- with(summary(reg2), 1 - deviance/null.deviance)
N2 <- length(summary(reg2)$deviance.resid)


df_model2 %>% select(-variable) %>%
  kable(format = 'latex', booktabs = TRUE, longtable = TRUE,
  caption="Tableau 4 - Facteurs du sentiment de pauvreté (Modèle 2)") %>%  
   kableExtra::column_spec(1, width = "4cm") %>% 
   kableExtra::column_spec(2:4, width = "2cm") %>% 
kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header")) %>% 
     kableExtra::footnote(paste0("Modèle logit (Variable dépendante = Se déclarer pauvre) / N = ",
                                 N2," / R2 ajusté = ",
                                 round(100*R2_ajuste2,1)," %")) 

```

- Les résultats principaux sont les mêmes mais les coefficients parfois légèrement différents. 
- Le modèle tel qu'exposé dans Papuchon et Duvoux n'est pas estimable dans le sens où les personnes sans PCS sont censées être exclues du champ. Or les personnes sans activité professionnelle le sont bien dans la partie statut d'activité. On ajoute donc une catégorie autres dans les PCS. 
- Dans quel case ranger un indépendant ? CDI à temps plein ? Précaire à temps partiel ? Car les indépendants ne répondent pas sur leur contrat de travail. 

## Données actualisées (2015-2019) et figures du rapport

```{r, echo=FALSE}
#Chargement de la base de données
bdd <- readRDS("../data/2019/barometre2000_2019_diff.rds") %>% 
  filter(annee%in%2015:2019) #NEW : 2015 à 2019

revenus_a_imputer <- bdd %>%
  mutate(sdrevcl = ifelse(sdrevcl==999999999,NA,sdrevcl)) %>%
  group_by(sdrevtr) %>% 
  summarise(sdrevcl = mean(sdrevcl,na.rm=TRUE))


bdd <- bdd %>% 
  mutate(
    sdrevcl_imput_moy = case_when(
      sdrevcl!=999999999 ~ sdrevcl,
      sdrevcl==999999999 & sdrevtr==1 ~ revenus_a_imputer$sdrevcl[1],
      sdrevcl==999999999 & sdrevtr==2 ~ revenus_a_imputer$sdrevcl[2],
      sdrevcl==999999999 & sdrevtr==3 ~ revenus_a_imputer$sdrevcl[3],
      sdrevcl==999999999 & sdrevtr==4 ~ revenus_a_imputer$sdrevcl[4],
      sdrevcl==999999999 & sdrevtr==5 ~ revenus_a_imputer$sdrevcl[5],
      sdrevcl==999999999 & sdrevtr==6 ~ revenus_a_imputer$sdrevcl[6],
      sdrevcl==999999999 & sdrevtr==7 ~ revenus_a_imputer$sdrevcl[7]
             )
  )

bdd <- bdd %>% 
   mutate(seuil_pauvrete = do.call(c,lapply(annee,function(annee_selec){
0.6*median(bdd[bdd$annee==annee_selec,"sdrevcl_imput_moy"]/bdd[bdd$annee==annee_selec,"sduc"],
           na.rm=TRUE)
}
))) %>% 
  mutate(subj_inf_mini_decla = factor(
     sdrevcl_imput_moy - ifelse(pe16==999999999,NA,pe16) <0,
     levels=c(TRUE,FALSE),
     labels=paste0("-",c("Rev. inf. au minimum décla.","Rev. sup. au minimum décla.")))
     ) %>%
   # mutate(subj_inf_mini_decla = sdrevcl_imput_moy - ifelse(pe16==999999999,NA,pe16) <0) %>% 
  mutate(subj_pauvrete = 
           ifelse(pe3==3, TRUE,ifelse(pe3==4,NA,FALSE))) %>% 
  mutate(subj_besoin_aide_etat =
                   ifelse(pe15==2, TRUE,ifelse(pe15==4,NA,FALSE))) %>%
  mutate(obj_pauvrete= sdrevcl_imput_moy/sduc<seuil_pauvrete)
```

```{r, echo=FALSE}
bdd_logit <- bdd %>%
  mutate(nivie = sdrevcl_imput_moy/sduc) %>% 
  mutate(quantile_nivie = factor(
    cut(sdrevcl_imput_moy/sduc, include.lowest=TRUE,
        breaks=quantile(sdrevcl_imput_moy/sduc,
                        probs=seq(0,1,0.2),na.rm=TRUE),
        labels=1:5),
    levels=c(2,1,3,4,5),
    labels=paste0("-Quintile ",c(2,1,3,4,5)))
  ) %>% 
  mutate(
    statact = factor(case_when(
      sdsitua==1 & sdstatemp%in%c(1)   ~ 1,
      sdsitua%in%c(2,3) | (sdsitua==1 & sdstatemp%in%c(NA,2,3,4,5)) ~ 2,
      sdsitua==4 ~ 3,
      sdsitua==5 ~ 4,
      sdsitua==6 ~ 5,
      sdsitua==7 ~ 6,
      TRUE ~ NA_real_
    ),
    levels=1:6,
    labels=paste0("-",
                  c("CDI temps plein",
                    "Emploi précaire ou à temps partiel",
                    "Recherche d’emploi",
                    "Étudiant",
                    "Retraité",
                    "Aucune activité professionnelle"))
    )) %>% 
  mutate(prof = factor(
    #ifelse(sdpcs7!=7,sdpcs7,NA),
    sdpcs7,
    levels=c(4,1,2,3,5,6,7),
    labels=paste0("-",c("Profession intermédiaire","Agriculteur",
                        "Artisan commerçant","Cadre supérieur, profession libérale",
                        "Employé","Ouvrier","Aucune"))
  )) %>%
  # fastDummies::dummy_cols(select_columns = 'prof') %>% 
  mutate(
    diplome = factor(case_when(
      sddipl%in%c(1,2,3,4) ~ 1,
      sddipl%in%c(5,6) ~ 2,
      sddipl%in%c(7) ~ 3,
      sddipl%in%c(8) ~ 4,
      TRUE ~ NA_real_
    ),
    levels=c(2,1,3,4),
    labels=paste0("-",c("Baccalauréat","CAP, BEP ou moins","Bac + 2","Bac + 3 ou plus"))
    )) %>% 
  mutate(aide_log = factor(
    ifelse(sdres_9!=3,sdres_9,NA),
    levels=c(2,1),
    labels=paste0("-",c("Pas d'aide au logement","Aide au logement reçue"))
  )) %>% 
  mutate(aide_rsa = factor(
    ifelse(sdres_3!=3,sdres_3,NA),
    levels=c(2,1),
    labels=paste0("-",c("Pas de RSA","RSA reçu"))
  )) %>% 
  mutate(aide_handi = factor(
    ifelse(sdres_10!=3,sdres_10,NA),
    levels=c(2,1),
    labels=paste0("-",c("Pas d'alloc. hand./invalid./dépend.",
                        "Alloc. hand./invalid./dépend. reçu"))
  )) %>% 
  mutate(sexe = factor(
    ifelse(sdsexe!=3,sdsexe,NA),
    levels=c(2,1),
    labels=paste0("-",c("Femme","Homme"))
  )) %>% 
  mutate(age_tranche = factor(
    cut(sdage,
        breaks=c(18,30,40,50,60,70,120),
        include.lowest=TRUE,
        labels=1:6),
    levels=c(2,1,3,4,5,6),
    labels=paste0("-",c("30 à 39 ans","18 à 29 ans","40 à 49 ans",
                        "50 à 59 ans","60 à 69 ans", "70 ans et plus")))
  ) %>% 
  mutate(
    vie_fam = factor(case_when(
      sdsitfam==1 ~ 1,
      sdsitfam==2 & sdnbenf==1 ~ 2, #attention dépend des bases
      sdsitfam==2 & sdnbenf!=1 ~ 3, #attention dépend des bases
      sdsitfam==3 ~ 4,
      sdsitfam==4 ~ 5,
      sdsitfam%in%c(5,6,7) ~ 6,
      TRUE ~ NA_real_
    ),
    levels=c(2,1,3,4,5,6),
    labels=paste0("-",
                  c("Membre du couple (pas d’enfants à charge)","Vit seul",
                    "Membre du couple (enfants à charge)", "Chef famille monoparentale",
                    "Enfant","Autre"))
    )) %>% 
  mutate(
    statut_occup0 = factor(case_when(
      lo1%in%c(2,3,4)  ~ 1,
      lo1==1 ~ 2,
      lo1==5 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Locataire ou hébergé","Propriétaire")) 
    )) %>% 
  mutate(annee_fac = factor(annee,labels=paste0("-",2015:2019))) %>%  #NEW : 2015 à 2019
  mutate(pauvrete_mon_rel= factor(
    ifelse(sdrevcl_imput_moy/sduc<seuil_pauvrete,3,
                                  ifelse(sdrevcl_imput_moy/sduc>=1.2*seuil_pauvrete,1,
                                         ifelse(sdrevcl_imput_moy/sduc<1.2*seuil_pauvrete &
                                                  sdrevcl_imput_moy/sduc>=seuil_pauvrete ,
                                                2,NA)
                                  )),
    levels=c(1,2,3),
    labels=paste0("-",c("Revenus > 20 pourcents seuil pauvreté",
                        "Entre le seuil et 20 pourcents au dessus",
                        "Pauvreté monétaire"))
  )
  )

#NEW depuis fiche 3
 bdd_logit <- bdd_logit %>% #chômeur indemnise 
  mutate(
    conn_choindemnise = factor(case_when(
      sdproxim_1%in%c(1,4)  ~ 1,
      sdproxim_1%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_1==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de chômeur indemnisé",
                    "Connait un chômeur indemnisé")) 
    )) %>% 
  mutate(
    est_choindemnise = factor(case_when(
      sdproxim_1%in%c(4,6,7,8)  ~ 2,
      sdproxim_1%in%c(1,2,3,5)  ~ 1,
      sdproxim_1==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas chômeur indemnisé",
                    "est chômeur indemnisé")) 
    )) %>%
  mutate(
    conn_chononindemnise = factor(case_when(
      sdproxim_2%in%c(1,4)  ~ 1,
      sdproxim_2%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_2==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de chômeur non indemnisé",
                    "Connait un chômeur non indemnisé")) 
    )) %>% 
  mutate(
    est_chononindemnise = factor(case_when(
      sdproxim_2%in%c(4,6,7,8)  ~ 2,
      sdproxim_2%in%c(1,2,3,5)  ~ 1,
      sdproxim_2==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas chômeur non indemnisé",
                    "est chômeur non indemnisé")) 
    )) %>% #SDF
  mutate(
    conn_sdf = factor(case_when(
      sdproxim_3%in%c(1,4)  ~ 1,
      sdproxim_3%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_3==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de SDF",
                    "Connait un SDF")) 
    )) %>% 
  mutate(
    est_sdf = factor(case_when(
      sdproxim_3%in%c(4,6,7,8)  ~ 2,
      sdproxim_3%in%c(1,2,3,5)  ~ 1,
      sdproxim_3==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas SDF",
                    "est SDF")) 
    )) %>% #personne élevant seul ses enfants avec moins du SMIC 
  mutate(
    conn_eleveseulsmic = factor(case_when(
      sdproxim_4%in%c(1,4)  ~ 1,
      sdproxim_4%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_4==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de personne élevant seul ses enfants avec moins du SMIC",
                    "Connait une personne élevant seul ses enfants avec moins du SMIC")) 
    )) %>% 
  mutate(
    est_eleveseulsmic = factor(case_when(
      sdproxim_4%in%c(4,6,7,8)  ~ 2,
      sdproxim_4%in%c(1,2,3,5)  ~ 1,
      sdproxim_4==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas personne élevant seul ses enfants avec moins du SMIC",
                    "est personne élevant seul ses enfants avec moins du SMIC")) 
    )) %>% #pensionné invalide indicapé ne pouvant pas travailler 
  mutate(
    conn_pensionhandi = factor(case_when(
      sdproxim_5%in%c(1,4)  ~ 1,
      sdproxim_5%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_5==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de pensionné invalide indicapé ne pouvant pas travailler",
                    "Connait un pensionné invalide indicapé ne pouvant pas travailler")) 
    )) %>% 
  mutate(
    est_pensionhandi = factor(case_when(
      sdproxim_5%in%c(4,6,7,8)  ~ 2,
      sdproxim_5%in%c(1,2,3,5)  ~ 1,
      sdproxim_5==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas pensionné invalide indicapé ne pouvant pas travailler",
                    "est pensionné invalide indicapé ne pouvant pas travailler")) 
    )) %>% #personne en emploi précaire 
  mutate(
    conn_emploiprecaire = factor(case_when(
      sdproxim_6%in%c(1,4)  ~ 1,
      sdproxim_6%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_6==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de personne en emploi précaire",
                    "Connait une personne en emploi précaire")) 
    )) %>% 
  mutate(
    est_emploiprecaire = factor(case_when(
      sdproxim_6%in%c(4,6,7,8)  ~ 2,
      sdproxim_6%in%c(1,2,3,5)  ~ 1,
      sdproxim_6==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas personne en emploi précaire",
                    "est personne en emploi précaire")) 
    )) %>%  mutate(
    conn_rsa_fam = factor(case_when(
      sdproxim_7%in%c(1,3,4,7)  ~ 1,
      sdproxim_7%in%c(2,5,6,8)  ~ 2,
      sdproxim_7==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de personne dans sa famille au RSA",
                    "Connait une personne dans sa famille au RSA")) 
    )) %>%
   mutate(
    conn_rsa_horsfam = factor(case_when(
      sdproxim_7%in%c(1,2,4,6)  ~ 1,
      sdproxim_7%in%c(3,5,7,8)  ~ 2,
      sdproxim_7==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de personne hors de sa famille au RSA",
                    "Connait une personne hors de sa famille au RSA")) 
    )) %>% #personne au RSA 
  mutate(
    conn_rsa = factor(case_when(
      sdproxim_7%in%c(1,4)  ~ 1,
      sdproxim_7%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_7==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de personne au RSA",
                    "Connait une personne au RSA")) 
    )) %>% 
  mutate(
    est_rsa = factor(case_when(
      sdproxim_7%in%c(4,6,7,8)  ~ 2,
      sdproxim_7%in%c(1,2,3,5)  ~ 1,
      sdproxim_7==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas personne au RSA",
                    "est personne au RSA")) 
    )) %>% #personne handicapée de moins de 60 ans
  mutate(
    conn_handijeune = factor(case_when(
      sdproxim_8%in%c(1,4)  ~ 1,
      sdproxim_8%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_8==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de personne handicapée de moins de 60 ans",
                    "Connait une personne handicapée de moins de 60 ans")) 
    )) %>% 
  mutate(
    est_handijeune = factor(case_when(
      sdproxim_8%in%c(4,6,7,8)  ~ 2,
      sdproxim_8%in%c(1,2,3,5)  ~ 1,
      sdproxim_8==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas personne handicapée de moins de 60 ans",
                    "est personne handicapée de moins de 60 ans")) 
    )) %>% #personne âgée dépendante
  mutate(
    conn_dependant = factor(case_when(
      sdproxim_9%in%c(1,4)  ~ 1,
      sdproxim_9%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_9==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de personne âgée dépendante",
                    "Connait une personne âgée dépendante")) 
    )) %>% 
  mutate(
    est_dependant = factor(case_when(
      sdproxim_9%in%c(4,6,7,8)  ~ 2,
      sdproxim_9%in%c(1,2,3,5)  ~ 1,
      sdproxim_9==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas personne âgée dépendante",
                    "est personne âgée dépendante")) 
    )) %>% 
  mutate(
    revenus_salaires = factor(case_when(
      sdres_1%in%c(2)  ~ 1,
      sdres_1%in%c(1)  ~ 2,
      sdres_1==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de revenus de salaires",
                    "Revenus de salaires")) 
    )) %>% 
  mutate(
    revenus_independant = factor(case_when(
      sdres_2%in%c(2)  ~ 1,
      sdres_2%in%c(1)  ~ 2,
      sdres_2==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de revenus d'activité indépendante",
                    "Revenus d'activité indépendante")) 
    )) %>%
  mutate(
    presta_hlm = factor(case_when(
      lo1%in%c(1,3,4) ~ 1,
      lo1==2  ~ 2,
      lo1==5 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Locataire privé / hébergé, Propriétaire","Locataire HLM")) 
    )) %>% 
  mutate(
    presta_rsa = factor(case_when(
      sdres_3%in%c(2)  ~ 1,
      sdres_3%in%c(1)  ~ 2,
      sdres_3==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de RSA",
                    "RSA")) 
    )) %>% 
  mutate(
    presta_chomage = factor(case_when(
      sdres_4%in%c(2)  ~ 1,
      sdres_4%in%c(1)  ~ 2,
      sdres_4==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas d'allocation chômage",
                    "Allocation chômage")) 
    )) %>% 
  mutate(
    revenus_retraite = factor(case_when(
      sdres_5%in%c(2)  ~ 1,
      sdres_5%in%c(1)  ~ 2,
      sdres_5==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de revenus de retraite",
                    "Revenus de retraite")) 
    )) %>%
  mutate(
    revenus_financiers = factor(case_when(
      sdres_6%in%c(2)  ~ 1,
      sdres_6%in%c(1)  ~ 2,
      sdres_6==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de revenus d'actifs financiers",
                    "Revenus d'actifs financiers")) 
    )) %>% 
  mutate(
    revenus_locatifs = factor(case_when(
      sdres_7%in%c(2)  ~ 1,
      sdres_7%in%c(1)  ~ 2,
      sdres_7==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de revenus de locations",
                    "Revenus de locations")) 
    )) %>% 
  mutate(
    presta_fam = factor(case_when(
      sdres_8%in%c(2)  ~ 1,
      sdres_8%in%c(1)  ~ 2,
      sdres_8==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de prestations familiales",
                    "Prestations familiales")) 
    )) %>% 
  mutate(
    presta_apl = factor(case_when(
      sdres_9%in%c(2)  ~ 1,
      sdres_9%in%c(1)  ~ 2,
      sdres_9==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas d'APL",
                    "APL")) 
    )) %>% 
  mutate(
    presta_handi = factor(case_when(
      sdres_10%in%c(2)  ~ 1,
      sdres_10%in%c(1)  ~ 2,
      sdres_10==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas d'AAH, APA, PCH (handicap)",
                    "AAH, APA, PCH (handicap)")) 
    )) %>% 
  mutate(
    presta_etudes = factor(case_when(
      sdres_11%in%c(2)  ~ 1,
      sdres_11%in%c(1)  ~ 2,
      sdres_11==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de bourse d'étude",
                    "Bourse d'étude")) 
    )) %>% 
  mutate(
    presta_pensionalim = factor(case_when(
      sdres_12%in%c(2)  ~ 1,
      sdres_12%in%c(1)  ~ 2,
      sdres_12==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de pension alimentaire",
                    "pension alimentaire")) 
    )) %>% 
  mutate(
    statut_activite = factor(case_when(
      sdstat==2 & (sdsitua==1 & sdstatemp==1) ~ 1,
      sdstat==2 & !(sdsitua==1 & sdstatemp==1) ~ 2,
      sdstat==1 & (sdsitua==1 & sdstatemp==1) ~ 3,
      sdstat==1 & !(sdsitua==1 & sdstatemp==1) ~ 4,
      sdstat==3 ~ 5,
      sdstat==4 ~ 6,
      sdstat==5 ~ 7,
      sdstat==6 ~ 8,
      sdstat==7 ~ 9,
      sdstat==8 ~ NA_real_
   ),
    levels=1:9,
    labels=paste0("-",
                  c("Salarié du secteur privé (en CDI à temps plein)",
"Salarié du secteur privé (précaire ou à temps partiel)",
"Salarié du secteur public (en CDI à temps plein)",
"Salarié du secteur public (précaire ou à temps partiel)",
"Indépendant sans salarié",
"Employeur",
"Chômeur",
"Inactif",
"Autre statut d'activité")
) 
    )) %>% 
  mutate(prof = factor(
    sdpcs7,
    levels=c(4,1,2,3,5,6,7),
    labels=paste0("-",c("Profession intermédiaire","Agriculteur",
                        "Artisan commerçant","Cadre supérieur, profession libérale",
                        "Employé","Ouvrier","Aucune"))
  ))  %>% 
  mutate(prof_statut_act = factor(
    sdpcs10,
    levels=c(4,1,2,3,5,6,7,8,9,10),
    labels=paste0("-",c("Profession intermédiaire","Agriculteur",
                        "Artisan commerçant","Cadre supérieur, profession libérale",
                        "Employé","Ouvrier","Chômeur",
                        "Retraité","Au foyer","Autre inactif"))
  )) %>%
  mutate(
    statut_activite_resp = factor(case_when(
      sdprstat==2 & (sdprsitua==1) ~ 1,
      sdprstat==2 & !(sdprsitua==1) ~ 2,
      sdprstat==1 & (sdprsitua==1) ~ 3,
      sdprstat==1 & !(sdprsitua==1) ~ 4,
      sdprstat==3 ~ 5,
      sdprstat==4 ~ 6,
      sdprstat==5 ~ 7,
      sdprstat==6 ~ 8,
      sdprstat==7 ~ 9,
      sdprstat==8 ~ NA_real_
   ),
    levels=1:9,
    labels=paste0("-Pers. réf. ",
                  c("Salarié du secteur privé (à temps plein)",
"Salarié du secteur privé (à temps partiel)",
"Salarié du secteur public (à temps plein)",
"Salarié du secteur public (à temps partiel)",
"Indépendant sans salarié",
"Employeur",
"Chômeur",
"Inactif",
"Autre statut d'activité")
) 
    )) %>% 
  mutate(prof_resp = factor(
    sdprpcs7,
    levels=c(4,1,2,3,5,6,7),
    labels=paste0("-Pers. réf. ",c("Profession intermédiaire","Agriculteur",
                        "Artisan commerçant","Cadre supérieur, profession libérale",
                        "Employé","Ouvrier","Aucune"))
  )) %>% 
  mutate(prof_statut_act_resp = factor(
    sdprpcs10,
    levels=c(4,1,2,3,5,6,7,8,9,10),
    labels=paste0("-Pers. réf. ",c("Profession intermédiaire","Agriculteur",
                        "Artisan commerçant","Cadre supérieur, profession libérale",
                        "Employé","Ouvrier","Chômeur",
                        "Retraité","Au foyer","Autre inactif"))
  ))

```


Graphique intro : Sentiment de pauvreté en fonction du niveau de vie en 2019

 
```{r, echo=FALSE}
fig_intro <- bdd_logit %>%
  filter(annee==2019 & !is.na(quantile_nivie)) %>% 
  group_by(quantile_nivie) %>% 
  count(pe3, wt=poids) %>% 
  mutate(n = 100*n/sum(n)) %>% 
  ungroup() %>% 
  mutate(#quantile_nivie=factor(quantile_nivie,labels=names(attr(bdd$quantile_nivie,"labels"))),
         pe3=factor(pe3,labels=
           c(names(attr(bdd$pe3,"labels"))[1:2],"Je me considère déjà\ncomme pauvre",names(attr(bdd$pe3,"labels"))[4])), 
         pe3=factor(pe3,levels=levels(pe3)[c(4,2,1,3)])) %>% 
  ggplot(aes(x=quantile_nivie, y=n, fill=pe3)) +
  geom_bar(stat="identity") + coord_flip() +
  labs(
   # title="Sentiment de pauvreté en fonction du niveau de vie en 2019",
    y="Part (%)", x="Niveau de vie") +
  theme_minimal() +
  scale_fill_manual(name= paste(strwrap(attr(bdd$pe3,"label"),30),collapse="\n"),
                    values=rev(c('red','orange','lightgreen','gray')),
                    guide=guide_legend(reverse=TRUE)) + 
  geom_text(aes(label = paste0(round(n,0))), 
            position = position_stack(vjust = 0.5))

fig_intro
saveRDS(fig_intro,"../rapport/figures/fig_intro.RDS")
```

Graphique chapitre 1 : Différents indicateurs de pauvreté (2015 à 2019)

    
```{r, echo=FALSE}

data_g1_new_effectifs <- bdd %>%
  mutate(subj_inf_mini_decla=ifelse(subj_inf_mini_decla=="-Rev. inf. au minimum décla.",TRUE,FALSE)) %>% 
   group_by(annee) %>% 
   summarise(subj_pauvrete = sum(!is.na(subj_pauvrete)),
             subj_inf_mini_decla = sum(!is.na(subj_inf_mini_decla)),
             obj_pauvrete = sum(!is.na(obj_pauvrete)),
             subj_besoin_aide_etat = sum(!is.na(subj_besoin_aide_etat))
             )

data_g1_new <- bdd %>%
  mutate(subj_inf_mini_decla=ifelse(subj_inf_mini_decla=="-Rev. inf. au minimum décla.",TRUE,FALSE)) %>% 
  group_by(annee) %>%
    summarise(subj_pauvrete = round(100*weighted.mean(subj_pauvrete,
                                                             poids, na.rm=TRUE)),
                            subj_inf_mini_decla = round(100*weighted.mean(subj_inf_mini_decla, poids, na.rm=TRUE)),
            obj_pauvrete = round(100*weighted.mean(obj_pauvrete,
                                                             poids, na.rm=TRUE)),
              
              subj_besoin_aide_etat = round(100*weighted.mean(subj_besoin_aide_etat,
                                                         poids, na.rm=TRUE))
              ) 

data_g1_new_ic <- cbind(data_g1_new[,1],1.96*100*sqrt(apply(data_g1_new,2,as.numeric)/100 * (1-apply(data_g1_new,2,as.numeric)/100)/apply(data_g1_new_effectifs,2,as.numeric))[,-1])




fig_chap1_compa20152019 <- ggplot(
  data=cbind(data_g1_new %>% tidyr::pivot_longer(!annee),
             data_g1_new_ic %>% tidyr::pivot_longer(!annee) %>% dplyr::select(value) 
  ) %>% setNames(c("annee","name","value","ic")),
       aes(x=name, y=value, fill=annee)) +
  geom_bar(stat="identity", position=position_dodge())+
  geom_errorbar(aes(ymin = value - ic, ymax = value + ic), width = 0.2, position = position_dodge(0.9)) +
  geom_text(aes(label=value), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+
  scale_fill_manual(values = c(rev(brewer.pal(5,"Purples")[3:5]),brewer.pal(4,"Oranges")[3:4]) )+
  theme_minimal() +
  scale_x_discrete(name ="Part des Français concernés (%)",
                   limits=c("subj_pauvrete","obj_pauvrete",
                            "subj_besoin_aide_etat",
                            "subj_inf_mini_decla"),
                   labels=c(
      "obj_pauvrete" = "Pauvreté\nmonétaire\nobjective",
      "subj_inf_mini_decla" = "Niveau de vie\ninf. au minimum\ndéclaré",
      "subj_besoin_aide_etat"="Besoin de\nplus d'aide\npublique",
      "subj_pauvrete" = "Sentiment\nde pauvreté"))+
  #ggtitle("Graphique 1 : Différents indicateurs de pauvreté") +
  ylab("")+
  labs(fill="Année")
fig_chap1_compa20152019
saveRDS(fig_chap1_compa20152019,"../rapport/figures/fig_chap1_compa20152019.RDS")
```


Graphique chapitre 1 : Evolution du sentiment de pauvreté selon les statuts d'activités

```{r, echo=FALSE}
data_statactevol <- bdd %>%
   mutate(subj_pauvrete_et_risque = 
           factor(
           ifelse(pe3==4, NA, ifelse(pe3==1,2,ifelse(pe3==2,1,3))),
           labels=c("Non pauvre","Risque pauvreté futur", "Déjà pauvre"))
         ) %>% 
  mutate(
    statact = factor(case_when(
      sdsitua==1 & sdstatemp%in%c(1)   ~ 1,
      sdsitua%in%c(2,3) | (sdsitua==1 & sdstatemp%in%c(NA,2,3,4,5)) ~ 2,
      sdsitua==4 ~ 3,
      sdsitua==5 ~ 4,
      sdsitua==6 ~ 5,
      sdsitua==7 ~ 6,
      TRUE ~ NA_real_),
    levels=1:6,
    labels=paste0("",
                  c("CDI temps plein",
                    "Emploi précaire ou à temps partiel",
                    "Recherche d’emploi",
                    "Étudiant",
                    "Retraité",
                    "Aucune activité professionnelle"))
    )) %>%
  group_by(annee, statact, subj_pauvrete_et_risque) %>% 
  summarise(poids= sum(poids)) %>% 
  na.omit() %>%
  group_by(annee, statact) %>% 
  mutate(poids=prop.table(poids)*100) %>%
  filter(subj_pauvrete_et_risque=="Déjà pauvre") %>% 
  group_by(annee, statact) %>% 
  summarise(poids = poids)

fig_statactevol <- ggplot(data_statactevol, aes(x = annee, y = poids, group = statact)) +
    geom_line(aes(color = statact))+
    geom_point(aes(color = statact)) +
    geom_text(aes(label=round(poids,0), color=statact),hjust=0, vjust=-0.5, show.legend = FALSE)+
    scale_color_brewer(palette="Dark2")+
    theme_minimal() +
    #theme(plot.margin = margin(1, 0, 0, 0, "pt")) +
    scale_y_continuous(expand = c(0, 5)) +
    scale_x_discrete(name ="Année")+
    #ggtitle("Evolution du sentiment de pauvreté selon le statut d'activité") +
  ylab("Sentiment de pauvreté (%)")+
  labs(color="Statut d'activité")
fig_statactevol
saveRDS(fig_statactevol,"../rapport/figures/fig_statactevol.RDS")
```


Graphique chapitre 1 : Evolution du sentiment de pauvreté selon les professions

```{r, echo=FALSE}
data_pcsevol <- bdd %>%
   mutate(subj_pauvrete_et_risque = 
           factor(
           ifelse(pe3==4, NA, ifelse(pe3==1,2,ifelse(pe3==2,1,3))),
           labels=c("Non pauvre","Risque pauvreté futur", "Déjà pauvre"))
         ) %>%
  mutate(prof = factor(
    #ifelse(sdpcs7!=7,sdpcs7,NA),
    sdpcs7,
    levels=c(1,2,3,4,5,6,7),
    labels=paste0("",c("Agriculteur",
                        "Artisan commerçant","Cadre supérieur, profession libérale","Profession intermédiaire",
                        "Employé","Ouvrier","Aucune"))
  )) %>% 
  group_by(annee, prof, subj_pauvrete_et_risque) %>% 
  summarise(poids= sum(poids)) %>% 
  na.omit() %>%
  group_by(annee, prof) %>% 
  mutate(poids=prop.table(poids)*100) %>%
  filter(subj_pauvrete_et_risque=="Déjà pauvre") %>% 
  group_by(annee, prof) %>% 
  summarise(poids = poids)

fig_pcsevol <- ggplot(data_pcsevol, aes(x = annee, y = poids, group = prof)) +
    geom_line(aes(color = prof))+
    geom_point(aes(color = prof)) +
    geom_text(aes(label=round(poids,0), color=prof),hjust=0, vjust=-0.5, show.legend = FALSE)+
    scale_color_brewer(palette="Paired")+
    theme_minimal() +
    #theme(plot.margin = margin(1, 0, 0, 0, "pt")) +
    scale_y_continuous(expand = c(0, 5)) +
    scale_x_discrete(name ="Année")+
    #ggtitle("Evolution du sentiment de pauvreté selon la catégorie professionnelle") +
  ylab("Sentiment de pauvreté (%)")+
  labs(color="Catégorie professionnelle")
fig_pcsevol
saveRDS(fig_pcsevol,"../rapport/figures/fig_pcsevol.RDS")
```


Graphique chapitre 1 : Evolution du sentiment de pauvreté selon la situation familiale

```{r, echo=FALSE}
data_viefamevol <- bdd %>%
   mutate(subj_pauvrete_et_risque = 
           factor(
           ifelse(pe3==4, NA, ifelse(pe3==1,2,ifelse(pe3==2,1,3))),
           labels=c("Non pauvre","Risque pauvreté futur", "Déjà pauvre"))
         ) %>% 
  mutate(
    vie_fam = factor(case_when(
      sdsitfam==1 ~ 1,
      sdsitfam==2 & sdnbenf==1 ~ 2, #attention dépend des bases
      sdsitfam==2 & sdnbenf!=1 ~ 3, #attention dépend des bases
      sdsitfam==3 ~ 4,
      sdsitfam==4 ~ 5,
      sdsitfam%in%c(5,6,7) ~ 6,
      TRUE ~ NA_real_
    ),
    levels=c(1,2,3,4,5,6),
    labels=paste0("",
                  c("Vit seul","Membre du couple (pas d’enfants à charge)",
                    "Membre du couple (enfants à charge)", "Chef famille monoparentale",
                    "Enfant","Autre situation familiale"))
    )) %>% 
  filter(vie_fam!="Autre situation familiale") %>% #NEW enlever autres du graphique
  group_by(annee, vie_fam, sdsexe, subj_pauvrete_et_risque) %>% 
  summarise(poids= sum(poids)) %>% 
  na.omit()

data_viefamevol <-  bind_rows(
  data_viefamevol %>%
  group_by(annee, vie_fam, subj_pauvrete_et_risque) %>% 
  summarise(poids= sum(poids)) %>% 
  group_by(annee, vie_fam) %>% 
  mutate(poids=prop.table(poids)*100) %>%
  filter(subj_pauvrete_et_risque=="Déjà pauvre") %>% 
  group_by(annee, vie_fam) %>% 
  summarise(poids = poids) %>% 
  mutate(sdsexe="3"),
  data_viefamevol %>%
  group_by(annee, vie_fam, sdsexe) %>% 
  mutate(poids=prop.table(poids)*100) %>%
  filter(subj_pauvrete_et_risque=="Déjà pauvre") %>% 
  filter(vie_fam%in%c("Vit seul","Chef famille monoparentale")) %>% 
  group_by(annee, vie_fam, sdsexe) %>% 
  summarise(poids = poids)
  
)

fig_viefamevol <- ggplot(data_viefamevol, aes(x = annee, y = poids, group = interaction(vie_fam, sdsexe))) +
    geom_line(aes(color = vie_fam, linetype=sdsexe))+
    geom_point(aes(color = vie_fam)) +
    geom_text(aes(label=ifelse(sdsexe=="3",round(poids,0),""), color=vie_fam),hjust=0, vjust=-0.5, show.legend = FALSE)+
    scale_color_brewer(palette="Set2")+
    theme_minimal() +
    #theme(plot.margin = margin(1, 0, 0, 0, "pt")) +
    scale_y_continuous(expand = c(0, 5)) +
    scale_x_discrete(name ="Année")+
    #ggtitle("Evolution du sentiment de pauvreté selon la situation familiale") +
  scale_linetype_manual(name="Sexe",values=c("solid", "dotted","dashed"), breaks=c(3,1,2), labels=c("Proportions cumulées","Hommes","Femmes"))+
  ylab("Sentiment de pauvreté (%)")+
  labs(color="Situation familiale")
fig_viefamevol
saveRDS(fig_viefamevol,"../rapport/figures/fig_viefamevol.RDS")
```


Modèle 1

```{r, echo=FALSE}
reg1_new <- glm(subj_pauvrete ~ quantile_nivie + aide_log +
             aide_rsa + aide_handi + statact + 
             prof + diplome + vie_fam +
             statut_occup0 + sexe + age_tranche + annee_fac,
           data = bdd_logit %>% select(`subj_pauvrete`, `quantile_nivie`,
                                       `statact`, `prof`,`diplome`, `aide_log`, `aide_rsa`,
                                       `aide_handi`, `sexe`, `age_tranche`,
                                       `vie_fam`, `statut_occup0`, `annee_fac`
                                       ) %>% tidyr::drop_na(),
           family = binomial(logit))
results1 <- summary(reg1_new)$coefficients
modalites1 <- c("(Intercept)")
for(var in c("quantile_nivie", "aide_log", "aide_rsa",
             "aide_handi", "statact", "prof","diplome", 
             "vie_fam","statut_occup0", "sexe", "age_tranche",
             "annee_fac")){
  modalites1 <- c(modalites1,gsub("-","",levels(bdd_logit[,var])))
  
}

df_model1_new <- data.frame(noms= c("-(Intercept)",row.names(results1)[-1]),
           valeur=round(results1[,1],2),
           pvaleur=cut(results1[,4], breaks = c(0, 0.001, 0.01, 0.05, 1),
                       include.lowest = T,
                       labels = c('***', '**', '*', '')),
           row.names=NULL
) %>% mutate(noms = gsub("`","",noms)) %>%  
  tidyr::separate(noms,c("variable","modalite"),sep="-") %>% 
   #mutate(odds=ifelse(is.na(pvaleur) | pvaleur=='',NA,round(exp(results1[,1]),2))) %>% 
  mutate(odds=round(exp(results1[,1]),2)) %>% 
  right_join(data.frame(modalite=modalites1),by="modalite") %>% 
  arrange(match(modalite, modalites1))

R2_ajuste1 <- with(summary(reg1_new), 1 - deviance/null.deviance)
N1 <- length(summary(reg1_new)$deviance.resid)

# df_model1_new %>% select(-variable) %>%
#   kable(format = 'latex', booktabs = TRUE, longtable = TRUE,
#   caption="Tableau 1 - Les déterminants du sentiment de pauvreté (Modèle 1)
# ") %>%  
#    kableExtra::column_spec(1, width = "4cm") %>% 
#    kableExtra::column_spec(2:4, width = "2cm") %>% 
# kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header")) %>% 
#      kableExtra::footnote(paste0("Modèle logit (Variable dépendante = Se déclarer pauvre) / N = ",
#                                  N1," / R2 ajusté = ",
#                                  round(100*R2_ajuste1,1)," %")) 

```


Modèle 2


```{r, echo=FALSE}
#On remplace la tranche d'âge par l'âge
#On remplace les quantiles de niveau de vie par pauvrete monétaire relative
#On enlève l'assistance
reg2_new <- glm(subj_pauvrete ~ sdage + pauvrete_mon_rel + diplome + statact +
              sexe + prof + vie_fam +  statut_occup0 + annee_fac,
        data = bdd_logit %>% select(`subj_pauvrete`, `sdage`,  `pauvrete_mon_rel`, `statact`, `prof`,`diplome`, `sexe`,
                                        `vie_fam`, `statut_occup0`, `annee_fac`
            ) %>% tidyr::drop_na(),
            family = binomial(logit))

results2 <- summary(reg2_new)$coefficients
modalites2 <- c("(Intercept)","sdage")
for(var in c("sdage","pauvrete_mon_rel","diplome", "statact", "sexe",
             "prof","vie_fam","statut_occup0", "annee_fac")){
  modalites2 <- c(modalites2,gsub("-","",levels(bdd_logit[,var])))
  
}

df_model2_new <- data.frame(noms= c("-(Intercept)","-sdage",row.names(results2)[-c(1,2)]),
                        valeur=round(results2[,1],2),
                        pvaleur=cut(results2[,4], breaks = c(0, 0.001, 0.01, 0.05, 1),
                                    include.lowest = T,
                                    labels = c('***', '**', '*', '')),
                        row.names=NULL
) %>% mutate(noms = gsub("`","",noms)) %>%  
  tidyr::separate(noms,c("variable","modalite"),sep="-") %>% 
  #mutate(odds=ifelse(is.na(pvaleur) | pvaleur=='',NA,round(exp(results2[,1]),2))) %>% 
  mutate(odds=round(exp(results2[,1]),2)) %>% 
  right_join(data.frame(modalite=modalites2),by="modalite") %>% 
  arrange(match(modalite, modalites2))

R2_ajuste2 <- with(summary(reg2_new), 1 - deviance/null.deviance)
N2 <- length(summary(reg2_new)$deviance.resid)


# df_model2_new %>% select(-variable) %>%
#   kable(format = 'latex', booktabs = TRUE, longtable = TRUE,
#   caption="Tableau 4 - Facteurs du sentiment de pauvreté (Modèle 2)") %>%  
#    kableExtra::column_spec(1, width = "4cm") %>% 
#    kableExtra::column_spec(2:4, width = "2cm") %>% 
# kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header")) %>% 
#      kableExtra::footnote(paste0("Modèle logit (Variable dépendante = Se déclarer pauvre) / N = ",
#                                  N2," / R2 ajusté = ",
#                                  round(100*R2_ajuste2,1)," %")) 

```

```{r, echo=FALSE}
tab_compa_old <- df_model1 %>%
  mutate(odds_ratio = ifelse(
    !is.na(valeur),paste0(gsub("\\.",",",odds),pvaleur),"Réf."
    )) %>%
  add_row(modalite = "2018",odds_ratio="Non inclus") %>% 
  add_row(modalite = "2019",odds_ratio="Non inclus") %>% 
  select(variable,modalite,odds_ratio) %>% 
  slice(-1) %>% 
  arrange(match(modalite, c(modalite[2],modalite[-2]))) %>% 
  arrange(match(modalite, c(modalite[1:17],modalite[19:21],modalite[18],modalite[22:49]))) %>% 
    arrange(match(modalite, c(modalite[1:24],modalite[26],modalite[25],modalite[27:49]))) %>% 
    arrange(match(modalite, c(modalite[1:28],modalite[30],modalite[29],modalite[31:49]))) %>% 
    arrange(match(modalite, c(modalite[1:38],modalite[40],modalite[39],modalite[41:49]))) %>% 
#  arrange(match(modalite,c("Quintile 1", "Quintile 2", "Quintile 3", "Quintile 4", "Quintile 5", "CDI temps plein", "Emploi précaire ou à temps partiel", "Recherche d’emploi", "Étudiant", "Retraité", "Aucune activité professionnelle", "Agriculteur", "Artisan commerçant", "Cadre supérieur, profession libérale", "Profession intermédiaire", "Employé", "Ouvrier", "Aucune", "CAP, BEP ou moins", "Baccalauréat", "Bac + 2", "Bac + 3 ou plus", "Pas d'aide au logement", "Aide au logement reçue", "Pas de RSA", "RSA reçu", "Pas d'alloc. hand./invalid./dépend.", "Alloc. hand./invalid./dépend. reçu", "Femme", "Homme", "18 à 29 ans", "30 à 39 ans", "40 à 49 ans", "50 à 59 ans", "60 à 69 ans", "70 ans et plus", "Vit seul", "Membre du couple (pas d’enfants à charge)", "Membre du couple (enfants à charge)", "Chef famille monoparentale", "Enfant", "Autre", "Locataire ou hébergé", "Propriétaire", "2015", "2016", "2017", "2018", "2019") )) %>% 
  mutate(variable = c("Niveau de vie",rep("",4),"Types de ressources ","perçues par le ménage ","(12 mois)",rep("",3), "Statut d'activité",rep("",5),"Catégorie professionnelle",rep("",6),"Niveau de diplôme le plus élevé",rep("",3),"Situation familiale",rep("",5),"Logement",rep("",1), "Sexe",rep("",1),"Classe d'âge",rep("",5),"Année",rep("",4))) 

R2_ajuste_old <- with(summary(reg1), 1 - deviance/null.deviance)
N_old <- length(summary(reg1)$deviance.resid)


tab_compa_new <- df_model1_new %>%
 mutate(odds_ratio = ifelse(
    !is.na(valeur),paste0(gsub("\\.",",",odds),pvaleur),"Réf."
    )) %>%
  #add_row(modalite = "2015",odds_ratio="Non inclus") %>% 
  select(variable,modalite,odds_ratio) %>% 
  slice(-1)  %>% 
  arrange(match(modalite, c(modalite[2],modalite[-2]))) %>% 
  arrange(match(modalite, c(modalite[1:17],modalite[19:21],modalite[18],modalite[22:49]))) %>% 
    arrange(match(modalite, c(modalite[1:24],modalite[26],modalite[25],modalite[27:49]))) %>% 
    arrange(match(modalite, c(modalite[1:28],modalite[30],modalite[29],modalite[31:49]))) %>% 
    arrange(match(modalite, c(modalite[1:38],modalite[40],modalite[39],modalite[41:49]))) %>%
  mutate(variable = c("Niveau de vie",rep("",4),"Types de ressources ","perçues par le ménage ","(12 mois)",rep("",3), "Statut d'activité",rep("",5),"Catégorie professionnelle",rep("",6),"Niveau de diplôme le plus élevé",rep("",3),"Situation familiale",rep("",5),"Logement",rep("",1), "Sexe",rep("",1),"Classe d'âge",rep("",5),"Année",rep("",4))) 

R2_ajuste_new <- with(summary(reg1_new), 1 - deviance/null.deviance)
N_new <- length(summary(reg1_new)$deviance.resid)

tab_compa <- tab_compa_old %>% bind_cols(tab_compa_new %>% select(odds_ratio)) %>% 
  setNames(c("Modèle logit"," Variable dépendante : se déclarer pauvre", "Odds ratio - Années 2015 à 2017","Odds ratio - Années 2015 à 2019"))

saveRDS(tab_compa,"../rapport/figures/tab_compa.RDS")

tab_compa %>% 
  kable(caption="Réactualisation du modèle 1 de Duvoux et Papuchon (2018)",
        booktabs = TRUE, longtable = TRUE) %>%  
   kableExtra::column_spec(1, width = "3cm") %>% 
   kableExtra::column_spec(2, width = "5cm") %>% 
   kableExtra::column_spec(3:4, width = "2cm") %>% 
kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header")) %>% 
     kableExtra::footnote(paste0("Modèle 2015-2017 : N = ",
                                 N_old," et $R^2$ ajusté = ",
                                 gsub("\\.",",",
                                      round(100*R2_ajuste_old,1))," %",
                                 " / Modèle 2015-2019 : N = ",
                                 N_new," et $R^2$ ajusté = ", 
                                 gsub("\\.",",",
                                      round(100*R2_ajuste_new,1))," %."))


```

Stat desc assistance chapitre 1

```{r, echo=FALSE}
prov <- bdd_logit %>% 
  mutate(assistance_apl_rsa = ifelse(aide_rsa=="-RSA reçu" | aide_log=="-Aide au logement reçue","assistance","non assistance")
  )
questionr::rprop(questionr::wtd.table(
  prov$subj_pauvrete,prov$assistance_apl_rsa, weights = prov$poids))
```

```{r, echo=FALSE}
bdd_objpauv <- bdd_logit %>%
  mutate(subj_inf_mini_decla = sdrevcl_imput_moy - ifelse(pe16==999999999,NA,pe16) <0) %>% 
  mutate(presta_apl=ifelse(presta_apl=="-APL",1,0)) %>% 
  mutate(presta_rsa=ifelse(presta_rsa=="-RSA",1,0)) %>%  
  filter(quantile_nivie%in%c("-Quintile 1","-Quintile 2")) 

tab_pauvviefam <- bind_cols(
  data.frame(questionr::rprop(questionr::wtd.table(bdd_objpauv$vie_fam,bdd_objpauv$subj_pauvrete,weights = bdd_objpauv$poids))) %>% filter(Var2==TRUE) %>% mutate(Freq=round(Freq,0)) %>% dplyr::select(Var1,Freq),
  data.frame(questionr::rprop(questionr::wtd.table(bdd_objpauv$vie_fam,bdd_objpauv$subj_inf_mini_decla,weights = bdd_objpauv$poids))) %>% filter(Var2==TRUE) %>% mutate(Freq=round(Freq,0)) %>% dplyr::select(Freq),
) %>%
  mutate(Var1=gsub("-","",Var1)) %>%
  arrange(match(Var1, c("Chef famille monoparentale",
                          "Vit seul", "Autre",
                          "Enfant",
                          "Membre du couple (pas d’enfants à charge)",
                          "Membre du couple (enfants à charge)"))) %>%
  setNames(c("Situation familiale","Sentiment de pauvreté (%)","Difficultés financières perçues (%)"))

saveRDS(tab_pauvviefam,"../rapport/figures/tab_pauvviefam.RDS")

tab_pauvviefam %>%
  kable(caption="Indicateurs de pauvreté subjective selon la situation familiale pour les personnes appartenant aux deux premiers quintiles de niveau de vie") %>%
   kableExtra::column_spec(1, width = "3cm") %>% 
   kableExtra::column_spec(2, width = "5cm") %>% 
   kableExtra::row_spec(7, bold = TRUE)

tab_prestaviefam <- bind_cols(
  data.frame(questionr::rprop(questionr::wtd.table(bdd_objpauv$vie_fam,bdd_objpauv$presta_apl,weights = bdd_objpauv$poids))) %>% filter(Var2==1) %>% mutate(Freq=round(Freq,0)) %>% dplyr::select(Var1,Freq),
  data.frame(questionr::rprop(questionr::wtd.table(bdd_objpauv$vie_fam,bdd_objpauv$presta_rsa,weights = bdd_objpauv$poids))) %>% filter(Var2==1) %>% mutate(Freq=round(Freq,0)) %>% dplyr::select(Freq),
) %>%
  mutate(Var1=gsub("-","",Var1)) %>%
  arrange(match(Var1, c("Chef famille monoparentale","Autre",
                          "Membre du couple (enfants à charge)",
                           "Vit seul",
                          "Enfant",
                          "Membre du couple (pas d’enfants à charge)"
                          ))) %>%
  setNames(c("Situation familiale","Part des bénéficiaires d'APL sans son ménage (%)","Part des bénéficiaires du RSA dans son ménage (%)"))

saveRDS(tab_prestaviefam,"../rapport/figures/tab_prestaviefam.RDS")

tab_prestaviefam %>%
  kable(caption="Être bénéficiaire de RSA et d'APL selon la situation familiale pour les personnes appartenant aux deux premiers quintiles de niveau de vie") %>%
   kableExtra::column_spec(1, width = "6cm") %>%
   kableExtra::column_spec(2:3, width = "4cm") %>%
   kableExtra::row_spec(7, bold = TRUE)


```

```{r, echo=FALSE, fig.height=6, fig.width=7, eval=FALSE}
gg_taux_viefam <- function(df, legend_only=FALSE,
                           legend.position="none", sous_champ="Titre"){
  df <- df %>% 
    filter(!vie_fam%in%c("-Autre situation familiale")) %>%
    mutate(vie_fam = gsub("-","",vie_fam)) %>%         
    mutate(vie_fam = factor(vie_fam,
                            levels=c("Vit seul",
                                     "Membre du couple (pas d’enfants à charge)",
                                     "Membre du couple (enfants à charge)",
                                     "Chef famille monoparentale",
                                     "Enfant"),
                            labels=c("Vit seul",
                                     "Membre du couple\n(pas d’enfants\nà charge)",
                                     "Membre du couple\n(enfants\nà charge)",
                                     "Chef famille\nmonoparentale",
                                     "Enfant")
    )) %>% 
    group_by(vie_fam) %>%
    arrange(nivie) %>% 
    mutate(denom = cumsum(poids*ifelse(is.na(indicatrice),0,1))) %>% 
    mutate(num=cumsum(poids*ifelse(is.na(indicatrice) | !indicatrice,0,1))) %>% 
    mutate(ratio=num/denom) %>% 
    select(vie_fam,indicatrice,poids,nivie,num,denom,ratio)
  
  p <- ggplot(df, aes(x=nivie, y=ratio, group=vie_fam, color=vie_fam)) +
    #geom_line() +
    geom_smooth(method = "loess", size=1)+ #lm, glm, loess, NULL, gam
    scale_color_brewer(palette="Set2")+
    theme_minimal()+
    scale_x_continuous(name ="Niveau de vie de moins de ... (euros/mois)", limits=c(500,3000))+
    scale_y_continuous(name ="Part de la population concernée",
                       limits=c(0,1),
                       labels=scales::percent)+
    ggtitle(sous_champ) +
    guides(linetype = guide_legend(title="Champ",order = 1),
           color = guide_legend(title="Situation\nfamiliale", order = 2)
    )+
    theme(title=element_text(size=8, face="bold"))

  if(legend_only){
    p <- p +  
      theme(legend.box="vertical", legend.position = "top",
            legend.spacing.x = unit(0.2, 'cm'))
    p <- cowplot::get_legend(p)
  } else{
    p <- p+  theme(legend.position=legend.position)
    
  }
  
  
  return(p)
  
  
}

leg <- gg_taux_viefam(df=bdd_logit %>% mutate(indicatrice = ifelse(presta_rsa=="-RSA",1,0)), legend_only = TRUE)
p1 <- gg_taux_viefam(df=bdd_logit %>% mutate(indicatrice = ifelse(presta_rsa=="-RSA",1,0)), sous_champ="Français qui bénéficient du RSA")
p2 <- gg_taux_viefam(df=bdd_logit %>% mutate(indicatrice = ifelse(presta_apl=="-APL",1,0)), sous_champ="Français qui bénéficient d'APL")
p3 <- gg_taux_viefam(df=bdd_logit %>% mutate(indicatrice = ifelse(subj_pauvrete==1,1,0)), sous_champ="Français qui se sentent pauvres")
p4 <- gg_taux_viefam(df=bdd_logit %>% mutate(indicatrice = ifelse(subj_inf_mini_decla==1,1,0)), sous_champ="Français se sentant en difficulté fin.") #"-Rev. inf. au minimum décla."
library(cowplot)

gg_taux_viefam <- plot_grid(NULL,NULL,p1,p2,p3,p4,nrow=3, rel_heights = c(1,3,3))+
  draw_plot(leg,x=0,y=0.45)

gg_taux_viefam

```

# Notes méthodologiques

Pour ces modèles trois vagues du Baromètre ont été empilées : 2015, 2016, 2017 (9070 observations). 

# Bibliographie {.unnumbered}

- Duvoux Nicolas, Papuchon Adrien, « Qui se sent pauvre en France ? Pauvreté subjective et insécurité sociale », Revue française de sociologie, vol. 59, 2018, p. 607-647.
- Formule pour les intervalles de confiance de proportions : https://courses.lumenlearning.com/atd-odessa-statistics/chapter/a-population-proportion/
