---
title: |
    | Fiche de modélisations n°6
subtitle : "Variables et classes latentes"
author: |
    | Kim Antunez
automaticcontents: true
output:
  bookdown::pdf_document2:
        toc: true
        toc_depth: 2
        number_sections: true
        fig_caption: true
        highlight: default
        keep_tex: no
        includes:
          in_header: preamble.tex
themeoptions: "coding=utf8,language=french"
classoption: 'french'
fontsize: 11pt
geometry: margin=0.90in
lang: "french"
documentclass: "article"
---

```{r setup, echo=FALSE, cache=FALSE}
library(knitr)
#library(rmdformats)

## Global options
#options(max.print="75")
opts_chunk$set(echo=TRUE,
	             cache=FALSE,
               prompt=FALSE,
               tidy=FALSE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               fig.width = 10,
               fig.height = 5
               )
options(knitr.kable.NA = '')
#opts_knit$set(width=75)
```


# Objectif

L'objectif de cette sixième série de modèles est de ...

# Analyses

# Code et résultats

```{r}
#chargement des packages
library(knitr)
library(dplyr) #manipuler les bases de données
library(psych) #EFA
library(lavaan) #CFA et SEM
library(semPlot) #path draw CFA SEM
library(poLCA) #pour les Latent Categorical Variables
library(ade4) #pour la fonction s5 de plot des classes de CAH
library(RColorBrewer) #palettes de couleur
library(ggplot2) #graphiques corrplot
library(tidyr) #pour pivot_longer / wider
library(tibble) #pour rownames_to_column
library(DiagrammeR) #pour refaire les graphiques de path
```
```{r, echo=FALSE}
poLCA.makeplot.poly.oneclass <- function(x,r,noms_classes=1:length(x$P)){
K.j <- sapply(x$probs,ncol)
par(mar=c(5,4,4,2)+0.1) #mfrow=c(1,1),
layout(matrix(seq(1,(1+1)),1+1,1),heights=c(rep(5,1),1))
poLCA:::poLCA.makeplot.poly(x$probs,r,x$y,K.j,paste("Classe ",noms_classes[r]," : part de la population = ",round(100*x$P[r],1)," %",sep=""))
}



correlation_ggplot <- function(mat,ordre=row.names(mat),titre_legende="Corrélation", seuilcroix=0.5){
  mat <- mat[ordre,ordre]
  #mat[lower.tri(mat)] <- NA
  cbind(
    data.frame(mat)  %>%
      rownames_to_column(var="mesure1") %>%
      pivot_longer(-mesure1, "mesure2") %>%
      mutate(mesure1 = factor(mesure1,levels = unique(mesure1)),
             mesure2 = factor(mesure2,levels = unique(mesure1))
      ),
    data.frame(ggcorrplot::cor_pmat(mat))  %>%
      rownames_to_column(var="mesure1") %>%
      pivot_longer(-mesure1, "mesure2") %>% 
      mutate(value=ifelse(value>0.05,1,2)) %>% 
      dplyr::select(value) %>% 
      setNames("signi")
  )  %>% 
    mutate(label = round(value,2)) %>% 
    mutate(highval = ifelse(abs(value)>seuilcroix,2,1)) %>% 
    ggplot(aes(mesure1, mesure2, fill=value)) + ## to get the rect filled
    geom_tile(color="white", fill="white") +
    geom_point(aes(stroke= highval),size = 5, shape=21) +
    #geom_point(aes(shape = highval),size = 2,color = "black")+
    labs(x = NULL, y = NULL, col = titre_legende) +
    theme_classic()+
    #scale_shape_manual(name=paste0("Corrélation (val.\nabs.) > ",seuilcroix),values=c(4,NA), breaks=c("1","0"),labels=c("Oui","Non"))+
  continuous_scale("stroke", "stroke", name= paste0("Corrélation (val.\nabs.) > ",seuilcroix),
                   palette = function(x){scales::rescale(x, c(1, 2))},
                   breaks = c(2, 1), labels=c("Oui","Non")) +
    scale_fill_gradient2(mid="#FBFEF9",low="#6D9EC1",high="#E46726",
                          limits=c(-1,1), na.value="#FFFFFF")  +
    scale_x_discrete(expand=c(0,0)) +
    scale_y_discrete(expand=c(0,0)) +
    scale_size(range=c(4,10), guide=NULL) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  
}

```

```{r, echo=FALSE}
bdd <- readRDS("../data/2019/barometre2000_2019_diff.rds") %>% 
  filter(annee%in%2015:2019) #NEW : 2015 à 2019

revenus_a_imputer <- bdd %>%
mutate(sdrevcl = ifelse(sdrevcl==999999999,NA,sdrevcl)) %>%
group_by(sdrevtr) %>% 
summarise(sdrevcl = mean(sdrevcl,na.rm=TRUE))

bdd <- bdd %>%   mutate(
    sdrevcl_imput_moy = case_when(
      sdrevcl!=999999999 ~ sdrevcl,
      sdrevcl==999999999 & sdrevtr==1 ~ revenus_a_imputer$sdrevcl[1],
      sdrevcl==999999999 & sdrevtr==2 ~ revenus_a_imputer$sdrevcl[2],
      sdrevcl==999999999 & sdrevtr==3 ~ revenus_a_imputer$sdrevcl[3],
      sdrevcl==999999999 & sdrevtr==4 ~ revenus_a_imputer$sdrevcl[4],
      sdrevcl==999999999 & sdrevtr==5 ~ revenus_a_imputer$sdrevcl[5],
      sdrevcl==999999999 & sdrevtr==6 ~ revenus_a_imputer$sdrevcl[6],
      sdrevcl==999999999 & sdrevtr==7 ~ revenus_a_imputer$sdrevcl[7]
             )
  )

bdd <- bdd %>% 
   mutate(seuil_pauvrete = do.call(c,lapply(annee,function(annee_selec){
0.6*median(bdd[bdd$annee==annee_selec,"sdrevcl_imput_moy"]/bdd[bdd$annee==annee_selec,"sduc"],
           na.rm=TRUE)
}
))) %>% 
   # mutate(subj_inf_mini_decla = sdrevcl_imput_moy - ifelse(pe16==999999999,NA,pe16) <0) %>% 
  mutate(subj_inf_mini_decla = factor(
     sdrevcl_imput_moy - ifelse(pe16==999999999,NA,pe16) <0,
     levels=c(TRUE,FALSE),
     labels=paste0("-",c("Rev. inf. au minimum décla.","Rev. sup. au minimum décla.")))
     ) %>% 
  mutate(subj_pauvrete = 
           ifelse(pe3==3, TRUE,ifelse(pe3==4,NA,FALSE))) %>% 
  mutate(subj_risque_pauvrete = 
           ifelse(pe3==1, TRUE,ifelse(pe3==4,NA,FALSE))) %>% 
  mutate(subj_pauvrete_et_risque = 
           factor(
           ifelse(pe3==4, NA, ifelse(pe3==1,2,ifelse(pe3==2,1,3))),
           labels=c("Non pauvre","Risque pauvreté futur", "Déjà pauvre"))
         ) %>% 
  mutate(subj_besoin_aide_etat =
           ifelse(pe15==2, TRUE,ifelse(pe15==4,NA,FALSE))) %>%
  mutate(obj_pauvrete= sdrevcl_imput_moy/sduc<seuil_pauvrete)

bdd <- bdd %>% 
  mutate(
    prof_exercee_ou_derniere = case_when(
      sdpcs7%in%c(1,2) ~ "Agriculteurs, artisans et commerçants",
      sdpcs7%in%c(3) ~ "Cadre supérieur, profession libérale",
      sdpcs7%in%c(4) ~ "Profession intermédiaire",
      sdpcs7%in%c(5) ~ "Employé",
      sdpcs7%in%c(6) ~ "Ouvrier",
      sdpcs7%in%c(7) ~ "Autres (n'ayant jamais travaillé)"
    )
  ) %>% 
  mutate(
    activite_actuelle = case_when(
      sdsitua==4 ~ "Chômeur",
      sdsitua==6 ~ "Retraité",
      (sdsitua==1 & sdstatemp!=1) | sdsitua%in%c(2,3) ~
        "Emploi précaire/temps partiel",
      TRUE #sdsitua%in%c(5,7) | (sdsitua==1 & sdstatemp==1) incomplet
      ~
        "Autres (CDI à temps plein, étudiants en formations et personnes n'ayant jamais travaillé)"
    )
  )%>% 
  mutate(
    PCS_recode = case_when(
      prof_exercee_ou_derniere%in%c("Employé","Ouvrier") & activite_actuelle=="Emploi précaire/temps partiel" ~
        "Employés et ouvriers\nprécaires ou\ntemps partiels",
      prof_exercee_ou_derniere%in%c("Employé","Ouvrier") & activite_actuelle=="Retraité" ~
        "Employés et ouvriers\nà la retraite", #sdsitua==6
      prof_exercee_ou_derniere%in%c("Employé","Ouvrier") & activite_actuelle=="Chômeur"  ~
        "Employés et ouvriers\nau chômage",
      sdsitua==1 & !(prof_exercee_ou_derniere%in%c("Employé","Ouvrier") & activite_actuelle=="Emploi précaire/temps partiel") ~ "En emploi à temps plein",
      sdsitua%in%c(7)  ~ "Sans activité\nprofessionnelle",
      TRUE                      ~  "Autres"
    )
  ) %>% 
  mutate(
    sitfam = case_when(
      sdsitfam==2 ~ "Membre du couple",
      sdsitfam==1 ~ "Vie seule",
      sdsitfam==3 ~ "Famille monoparentale",
      sdsitfam%in%c(4,5,6,7) ~ "Autre situation (enfant de la famille,\nami ou parent hébergé, colocataire)" 
      #pas précisé si prise compte de 7 mais très peu d'individus
    )
  ) %>% 
  mutate(
    crois_pauvrete_obj_subj = case_when(
      !subj_pauvrete & !obj_pauvrete & !is.na(subj_pauvrete) & !is.na(obj_pauvrete)  ~
        "Au-dessus du seuil\net ne se sent pas pauvre",
      !subj_pauvrete & obj_pauvrete & !is.na(subj_pauvrete) & !is.na(obj_pauvrete) ~
        "Sous le seuil\nmais ne se sent pas pauvre",
      subj_pauvrete & !obj_pauvrete & !is.na(subj_pauvrete) & !is.na(obj_pauvrete) ~
        "Au-dessus du seuil\nmais se sent pauvre",
      subj_pauvrete & obj_pauvrete & !is.na(subj_pauvrete) & !is.na(obj_pauvrete)~
        "Pauvreté monétaire\net ressentie"
    )
  ) %>% 
#sdres_3 : RSA, sdres_4 : chômage, sdres_10 : handicap dépdce.
  mutate(
    assistance = case_when(
      sdres_3==1 | sdres_4==1 | sdres_10==1 ~ TRUE,
      sdres_3==2 & sdres_4==2 & sdres_10==2 ~ FALSE,
      TRUE ~ NA
      )
  ) %>% 
  mutate(
    pessimisme = case_when(
      og3_1%in%c(1,2) ~ FALSE,
      og3_1%in%c(3,4) ~ TRUE,
      og3_1%in%c(5) ~ NA
      )
  ) %>% 
  mutate(
    declassement = case_when(
      #og2_ab%in%c(1,2) | og2_cd%in%c(4,5)  ~ TRUE,
      #og2_ab%in%c(3,4,5) | og2_cd%in%c(1,2,3) ~ FALSE,
      #og2_ab%in%c(6) | og2_cd%in%c(6) ~ NA
      og2%in%c(1,2) ~ TRUE,
      og2%in%c(3,4,5) ~ FALSE,
      og2%in%c(6) ~ NA
      )
  )  %>% 
  mutate(
    proprietaire = case_when(
      lo1==1 ~ TRUE,
      lo1%in%c(2,3,4) ~ FALSE,
      lo1==5 ~ NA
      )
  ) %>% 
  mutate(
    retraite = case_when(
      sdsitua==6 ~ TRUE,
       TRUE ~ FALSE
    )
  )


```


```{r, echo=FALSE}
bdd_logit <- bdd %>% 
   mutate(nivie = sdrevcl_imput_moy/sduc) %>% 
  mutate(quantile_nivie = factor(
    cut(sdrevcl_imput_moy/sduc, include.lowest=TRUE,
        breaks=quantile(sdrevcl_imput_moy/sduc,
                        probs=seq(0,1,0.2),na.rm=TRUE),
        labels=1:5),
    levels=c(2,1,3,4,5),
    labels=paste0("-Quintile ",c(2,1,3,4,5)))
  ) %>% 
  mutate(
    statact = factor(case_when(
      sdsitua==1 & sdstatemp%in%c(1)   ~ 1,
      sdsitua%in%c(2,3) | (sdsitua==1 & sdstatemp%in%c(NA,2,3,4,5)) ~ 2,
      sdsitua==4 ~ 3,
      sdsitua==5 ~ 4,
      sdsitua==6 ~ 5,
      sdsitua==7 ~ 6,
      TRUE ~ NA_real_
    ),
    levels=1:6,
    labels=paste0("-",
                  c("CDI temps plein",
                    "Emploi précaire ou à temps partiel",
                    "Recherche d’emploi",
                    "Étudiant",
                    "Retraité",
                    "Aucune activité professionnelle"))
    )) %>%
  # fastDummies::dummy_cols(select_columns = 'prof') %>% 
  mutate(
    diplome = factor(case_when(
      sddipl%in%c(1,2,3,4) ~ 1,
      sddipl%in%c(5,6) ~ 2,
      sddipl%in%c(7) ~ 3,
      sddipl%in%c(8) ~ 4,
      TRUE ~ NA_real_
    ),
    levels=c(2,1,3,4),
    labels=paste0("-",c("Baccalauréat","CAP, BEP ou moins","Bac + 2","Bac + 3 ou plus"))
    )) %>% 
  mutate(aide_log = factor(
    ifelse(sdres_9!=3,sdres_9,NA),
    levels=c(2,1),
    labels=paste0("-",c("Pas d'aide au logement","Aide au logement reçue"))
  )) %>% 
  mutate(aide_rsa = factor(
    ifelse(sdres_3!=3,sdres_3,NA),
    levels=c(2,1),
    labels=paste0("-",c("Pas de RSA","RSA reçu"))
  )) %>% 
  mutate(aide_handi = factor(
    ifelse(sdres_10!=3,sdres_10,NA),
    levels=c(2,1),
    labels=paste0("-",c("Pas d'alloc. hand./invalid./dépend.",
                        "Alloc. hand./invalid./dépend. reçu"))
  )) %>% 
  mutate(sexe = factor(
    ifelse(sdsexe!=3,sdsexe,NA),
    levels=c(2,1),
    labels=paste0("-",c("Femme","Homme"))
  )) %>% 
  mutate(age_tranche = factor(
    cut(sdage,
        breaks=c(18,30,40,50,60,70,120),
        include.lowest=TRUE,
        labels=1:6),
    levels=c(2,1,3,4,5,6),
    labels=paste0("-",c("30 à 39 ans","18 à 29 ans","40 à 49 ans",
                        "50 à 59 ans","60 à 69 ans", "70 ans et plus")))
  ) %>% 
  mutate(
    vie_fam = factor(case_when(
      sdsitfam==1 ~ 1,
      #sdsitfam==2 & sdnbenf==0 ~ 2,
      #sdsitfam==2 & sdnbenf!=0 ~ 3,
      sdsitfam==2 & sdnbenf==1 ~ 2,
      sdsitfam==2 & sdnbenf!=1 ~ 3,
      sdsitfam==3 ~ 4,
      sdsitfam==4 ~ 5,
      sdsitfam%in%c(5,6,7) ~ 6,
      TRUE ~ NA_real_
    ),
    levels=c(2,1,3,4,5,6),
    labels=paste0("-",
                  c("Membre du couple (pas d’enfants à charge)","Vit seul",
                    "Membre du couple (enfants à charge)", "Chef famille monoparentale",
                    "Enfant","Autre situation familiale"))
    )) %>% 
  mutate(
    statut_occup0 = factor(case_when(
      lo1%in%c(2,3,4)  ~ 1,
      lo1==1 ~ 2,
      lo1==5 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Locataire ou hébergé","Propriétaire")) 
    )) %>% 
  mutate(
    statut_occup = factor(case_when(
      lo1%in%c(3,4)  ~ 1,
      lo1==2  ~ 2,
      lo1==1 ~ 3,
      lo1==5 ~ NA_real_
   ),
    levels=c(1,2,3),
    labels=paste0("-",
                  c("Locataire privé / hébergé",
                    "Locataire HLM","Propriétaire")) 
    )) %>% 
  mutate(annee_fac = factor(annee,labels=paste0("-",2015:2019))) %>% 
  mutate(annee_fac_paires = factor(ifelse(annee%in%c(2016,2018),annee,NA),labels=paste0("-",c(2016,2018)))) %>% 
  mutate(pauvrete_mon_rel= factor(
    ifelse(sdrevcl_imput_moy/sduc<seuil_pauvrete,3,
                                  ifelse(sdrevcl_imput_moy/sduc>=1.2*seuil_pauvrete,1,
                                         ifelse(sdrevcl_imput_moy/sduc<1.2*seuil_pauvrete &
                                                  sdrevcl_imput_moy/sduc>=seuil_pauvrete ,
                                                2,NA)
                                  )),
    levels=c(1,2,3),
    labels=paste0("-",c("Revenus > 20 pourcents seuil pauvreté",
                        "Entre le seuil et 20 pourcents au dessus",
                        "Pauvreté monétaire"))
  )
  )

# bdd_logit <- bdd_logit %>% mutate(sdniviecl_imput_quint = 
# factor(
#     cut(sdniviecl_imput, include.lowest=TRUE,
#         breaks=quantile(sdniviecl_imput,
#                         probs=seq(0,1,0.2),na.rm=TRUE),
#         labels=1:5),
#     levels=c(2,1,3,4,5),
#     labels=paste0("-Quintile ",c(2,1,3,4,5))))

#NEW depuis fiche 3
 bdd_logit <- bdd_logit %>% #chômeur indemnise 
  mutate(
    conn_choindemnise = factor(case_when(
      sdproxim_1%in%c(1,4)  ~ 1,
      sdproxim_1%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_1==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de chômeur indemnisé",
                    "Connait un chômeur indemnisé")) 
    )) %>% 
  mutate(
    est_choindemnise = factor(case_when(
      sdproxim_1%in%c(4,6,7,8)  ~ 2,
      sdproxim_1%in%c(1,2,3,5)  ~ 1,
      sdproxim_1==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas chômeur indemnisé",
                    "est chômeur indemnisé")) 
    )) %>%
  mutate(
    conn_chononindemnise = factor(case_when(
      sdproxim_2%in%c(1,4)  ~ 1,
      sdproxim_2%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_2==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de chômeur non indemnisé",
                    "Connait un chômeur non indemnisé")) 
    )) %>% 
  mutate(
    est_chononindemnise = factor(case_when(
      sdproxim_2%in%c(4,6,7,8)  ~ 2,
      sdproxim_2%in%c(1,2,3,5)  ~ 1,
      sdproxim_2==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas chômeur non indemnisé",
                    "est chômeur non indemnisé")) 
    )) %>% #SDF
  mutate(
    conn_sdf = factor(case_when(
      sdproxim_3%in%c(1,4)  ~ 1,
      sdproxim_3%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_3==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de SDF",
                    "Connait un SDF")) 
    )) %>% 
  mutate(
    est_sdf = factor(case_when(
      sdproxim_3%in%c(4,6,7,8)  ~ 2,
      sdproxim_3%in%c(1,2,3,5)  ~ 1,
      sdproxim_3==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas SDF",
                    "est SDF")) 
    )) %>% #personne élevant seul ses enfants avec moins du SMIC 
  mutate(
    conn_eleveseulsmic = factor(case_when(
      sdproxim_4%in%c(1,4)  ~ 1,
      sdproxim_4%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_4==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de personne élevant seul ses enfants avec moins du SMIC",
                    "Connait une personne élevant seul ses enfants avec moins du SMIC")) 
    )) %>% 
  mutate(
    est_eleveseulsmic = factor(case_when(
      sdproxim_4%in%c(4,6,7,8)  ~ 2,
      sdproxim_4%in%c(1,2,3,5)  ~ 1,
      sdproxim_4==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas personne élevant seul ses enfants avec moins du SMIC",
                    "est personne élevant seul ses enfants avec moins du SMIC")) 
    )) %>% #pensionné invalide indicapé ne pouvant pas travailler 
  mutate(
    conn_pensionhandi = factor(case_when(
      sdproxim_5%in%c(1,4)  ~ 1,
      sdproxim_5%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_5==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de pensionné invalide indicapé ne pouvant pas travailler",
                    "Connait un pensionné invalide indicapé ne pouvant pas travailler")) 
    )) %>% 
  mutate(
    est_pensionhandi = factor(case_when(
      sdproxim_5%in%c(4,6,7,8)  ~ 2,
      sdproxim_5%in%c(1,2,3,5)  ~ 1,
      sdproxim_5==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas pensionné invalide indicapé ne pouvant pas travailler",
                    "est pensionné invalide indicapé ne pouvant pas travailler")) 
    )) %>% #personne en emploi précaire 
  mutate(
    conn_emploiprecaire = factor(case_when(
      sdproxim_6%in%c(1,4)  ~ 1,
      sdproxim_6%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_6==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de personne en emploi précaire",
                    "Connait une personne en emploi précaire")) 
    )) %>% 
  mutate(
    est_emploiprecaire = factor(case_when(
      sdproxim_6%in%c(4,6,7,8)  ~ 2,
      sdproxim_6%in%c(1,2,3,5)  ~ 1,
      sdproxim_6==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas personne en emploi précaire",
                    "est personne en emploi précaire")) 
    )) %>% #personne au RSA 
  mutate(
    conn_rsa = factor(case_when(
      sdproxim_7%in%c(1,4)  ~ 1,
      sdproxim_7%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_7==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de personne au RSA",
                    "Connait une personne au RSA")) 
    )) %>% 
  mutate(
    est_rsa = factor(case_when(
      sdproxim_7%in%c(4,6,7,8)  ~ 2,
      sdproxim_7%in%c(1,2,3,5)  ~ 1,
      sdproxim_7==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas personne au RSA",
                    "est personne au RSA")) 
    )) %>% #personne handicapée de moins de 60 ans
  mutate(
    conn_handijeune = factor(case_when(
      sdproxim_8%in%c(1,4)  ~ 1,
      sdproxim_8%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_8==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de personne handicapée de moins de 60 ans",
                    "Connait une personne handicapée de moins de 60 ans")) 
    )) %>% 
  mutate(
    est_handijeune = factor(case_when(
      sdproxim_8%in%c(4,6,7,8)  ~ 2,
      sdproxim_8%in%c(1,2,3,5)  ~ 1,
      sdproxim_8==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas personne handicapée de moins de 60 ans",
                    "est personne handicapée de moins de 60 ans")) 
    )) %>% #personne âgée dépendante
  mutate(
    conn_dependant = factor(case_when(
      sdproxim_9%in%c(1,4)  ~ 1,
      sdproxim_9%in%c(2,3,5,6,7,8)  ~ 2,
      sdproxim_9==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Ne connaît pas de personne âgée dépendante",
                    "Connait une personne âgée dépendante")) 
    )) %>% 
  mutate(
    est_dependant = factor(case_when(
      sdproxim_9%in%c(4,6,7,8)  ~ 2,
      sdproxim_9%in%c(1,2,3,5)  ~ 1,
      sdproxim_9==9 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("N'est pas personne âgée dépendante",
                    "est personne âgée dépendante")) 
    )) %>% 
  mutate(
    revenus_salaires = factor(case_when(
      sdres_1%in%c(2)  ~ 1,
      sdres_1%in%c(1)  ~ 2,
      sdres_1==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de revenus de salaires",
                    "Revenus de salaires")) 
    )) %>% 
  mutate(
    revenus_independant = factor(case_when(
      sdres_2%in%c(2)  ~ 1,
      sdres_2%in%c(1)  ~ 2,
      sdres_2==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de revenus d'activité indépendante",
                    "Revenus d'activité indépendante")) 
    )) %>%
  mutate(
    presta_hlm = factor(case_when(
      lo1%in%c(1,3,4) ~ 1,
      lo1==2  ~ 2,
      lo1==5 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Locataire privé / hébergé, Propriétaire","Locataire HLM")) 
    )) %>%  
  mutate(
    presta_rsa = factor(case_when(
      sdres_3%in%c(2)  ~ 1,
      sdres_3%in%c(1)  ~ 2,
      sdres_3==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de RSA",
                    "RSA")) 
    )) %>% 
  mutate(
    presta_chomage = factor(case_when(
      sdres_4%in%c(2)  ~ 1,
      sdres_4%in%c(1)  ~ 2,
      sdres_4==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas d'allocation chômage",
                    "Allocation chômage")) 
    )) %>% 
  mutate(
    revenus_retraite = factor(case_when(
      sdres_5%in%c(2)  ~ 1,
      sdres_5%in%c(1)  ~ 2,
      sdres_5==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de revenus de retraite",
                    "Revenus de retraite")) 
    )) %>%
  mutate(
    revenus_financiers = factor(case_when(
      sdres_6%in%c(2)  ~ 1,
      sdres_6%in%c(1)  ~ 2,
      sdres_6==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de revenus d'actifs financiers",
                    "Revenus d'actifs financiers")) 
    )) %>% 
  mutate(
    revenus_locatifs = factor(case_when(
      sdres_7%in%c(2)  ~ 1,
      sdres_7%in%c(1)  ~ 2,
      sdres_7==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de revenus de locations",
                    "Revenus de locations")) 
    )) %>% 
  mutate(
    presta_fam = factor(case_when(
      sdres_8%in%c(2)  ~ 1,
      sdres_8%in%c(1)  ~ 2,
      sdres_8==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de prestations familiales",
                    "Prestations familiales")) 
    )) %>% 
  mutate(
    presta_apl = factor(case_when(
      sdres_9%in%c(2)  ~ 1,
      sdres_9%in%c(1)  ~ 2,
      sdres_9==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas d'APL",
                    "APL")) 
    )) %>% 
  mutate(
    presta_handi = factor(case_when(
      sdres_10%in%c(2)  ~ 1,
      sdres_10%in%c(1)  ~ 2,
      sdres_10==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas d'AAH, APA, PCH (handicap)",
                    "AAH, APA, PCH (handicap)")) 
    )) %>% 
  mutate(
    presta_etudes = factor(case_when(
      sdres_11%in%c(2)  ~ 1,
      sdres_11%in%c(1)  ~ 2,
      sdres_11==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de bourse d'étude",
                    "Bourse d'étude")) 
    )) %>% 
  mutate(
    presta_pensionalim = factor(case_when(
      sdres_12%in%c(2)  ~ 1,
      sdres_12%in%c(1)  ~ 2,
      sdres_12==3 ~ NA_real_
   ),
    levels=c(1,2),
    labels=paste0("-",
                  c("Pas de pension alimentaire",
                    "pension alimentaire")) 
    )) %>% 
  mutate(
    statut_activite = factor(case_when(
      sdstat==2 & (sdsitua==1 & sdstatemp==1) ~ 1,
      sdstat==2 & !(sdsitua==1 & sdstatemp==1) ~ 2,
      sdstat==1 & (sdsitua==1 & sdstatemp==1) ~ 3,
      sdstat==1 & !(sdsitua==1 & sdstatemp==1) ~ 4,
      sdstat==3 ~ 5,
      sdstat==4 ~ 6,
      sdstat==5 ~ 7,
      sdstat==6 ~ 8,
      sdstat==7 ~ 9,
      sdstat==8 ~ NA_real_
   ),
    levels=1:9,
    labels=paste0("-",
                  c("Salarié du secteur privé (en CDI à temps plein)",
"Salarié du secteur privé (précaire ou à temps partiel)",
"Salarié du secteur public (en CDI à temps plein)",
"Salarié du secteur public (précaire ou à temps partiel)",
"Indépendant sans salarié",
"Employeur",
"Chômeur",
"Inactif",
"Autre statut d'activité")
) 
    )) %>% 
  mutate(prof = factor(
    sdpcs7,
    levels=c(4,1,2,3,5,6,7),
    labels=paste0("-",c("Profession intermédiaire","Agriculteur",
                        "Artisan commerçant","Cadre supérieur, profession libérale",
                        "Employé","Ouvrier","Autre inactif"))
  ))  %>% 
  mutate(prof_statut_act = factor(
    sdpcs10,
    levels=c(4,1,2,3,5,6,7,8,9,10),
    labels=paste0("-",c("Profession intermédiaire","Agriculteur",
                        "Artisan commerçant","Cadre supérieur, profession libérale",
                        "Employé","Ouvrier","Chômeur",
                        "Retraité","Au foyer","Autre inactif"))
  )) %>%
  mutate(
    statut_activite_resp = factor(case_when(
      sdprstat==2 & (sdprsitua==1) ~ 1,
      sdprstat==2 & !(sdprsitua==1) ~ 2,
      sdprstat==1 & (sdprsitua==1) ~ 3,
      sdprstat==1 & !(sdprsitua==1) ~ 4,
      sdprstat==3 ~ 5,
      sdprstat==4 ~ 6,
      sdprstat==5 ~ 7,
      sdprstat==6 ~ 8,
      sdprstat==7 ~ 9,
      sdprstat==8 ~ NA_real_
   ),
    levels=1:9,
    labels=paste0("-Pers. réf. ",
                  c("Salarié du secteur privé (à temps plein)",
"Salarié du secteur privé (à temps partiel)",
"Salarié du secteur public (à temps plein)",
"Salarié du secteur public (à temps partiel)",
"Indépendant sans salarié",
"Employeur",
"Chômeur",
"Inactif",
"Autre statut d'activité")
) 
    )) %>% 
  mutate(prof_resp = factor(
    sdprpcs7,
    levels=c(4,1,2,3,5,6,7),
    labels=paste0("-Pers. réf. ",c("Profession intermédiaire","Agriculteur",
                        "Artisan commerçant","Cadre supérieur, profession libérale",
                        "Employé","Ouvrier","Autre inactif"))
  )) %>% 
  mutate(prof_statut_act_resp = factor(
    sdprpcs10,
    levels=c(4,1,2,3,5,6,7,8,9,10),
    labels=paste0("-Pers. réf. ",c("Profession intermédiaire","Agriculteur",
                        "Artisan commerçant","Cadre supérieur, profession libérale",
                        "Employé","Ouvrier","Chômeur",
                        "Retraité","Au foyer","Autre inactif"))
  ))

```

```{r, echo=FALSE}
# 3 dimensions
# s : pauvreté subjective
# m : pauvreté monétaire
# i : pauvreté institutionnelle
bdd_fa <- bdd_logit %>% 
  mutate(s_sentpauv = subj_pauvrete + 0,
         s_risqpauv = subj_risque_pauvrete + 0,
         #s_infminidecla = subj_inf_mini_decla + 0,
         s_infminidecla = ifelse(as.numeric(subj_inf_mini_decla)==2,0,1),
         m_nivie1 = ifelse(quantile_nivie=="-Quintile 1",1,0),
         m_nivie2 = ifelse(quantile_nivie=="-Quintile 2",1,0),
         m_nivie3 = ifelse(quantile_nivie=="-Quintile 3",1,0),
         m_nivie4 = ifelse(quantile_nivie=="-Quintile 4",1,0),
         m_nivie5 = ifelse(quantile_nivie=="-Quintile 5",1,0),
         m_locatif = ifelse(revenus_locatifs=="-Revenus de locations",1,0),
         m_financier = ifelse(revenus_financiers=="-Revenus d'actifs financiers",1,0),
         i_log = ifelse(presta_apl=="-APL",1,0),
         i_rsa = ifelse(presta_rsa=="-RSA",1,0),
         i_chom = ifelse(presta_chomage=="-Allocation chômage",1,0),
         i_handi = ifelse(presta_handi=="-AAH, APA, PCH (handicap)",1,0),
         i_bourse = ifelse(presta_etudes=="-Bourse d'étude",1,0),
         i_hlm = ifelse(presta_hlm=="-Locataire HLM",1,0)
          
  ) #%>% 
#  dplyr::select(s_sentpauv, s_risqpauv, s_infminidecla,
#m_nivie1, m_nivie2, m_nivie3, m_nivie4, m_nivie5, m_locatif, m_financier,
#i_log, i_rsa, i_chom)

# actives_autres <- c("revenus_financiers","revenus_locatifs",
#                     ,"presta_handi","presta_etudes", "presta_hlm")



bdd_poLCA <- bdd_logit %>% 
  mutate(s_sentpauvrisque = as.numeric(subj_pauvrete_et_risque),
         s_infminidecla = ifelse(as.numeric(subj_inf_mini_decla)==2,1,2),
         #m_quantilenivie = as.numeric(quantile_nivie),
         m_quantilenivie = as.numeric(substr(quantile_nivie,11,11)),
         # m_quantilenivie_inv = 6-as.numeric(quantile_nivie),
         m_quantilenivie_inv = 6-as.numeric(substr(quantile_nivie,11,11)),
         m_locatif = as.numeric(revenus_locatifs),
         m_locatif_inv = 3-as.numeric(revenus_locatifs),
         m_financier = as.numeric(revenus_financiers),
         m_financier_inv = 3-as.numeric(revenus_financiers),
         i_log = as.numeric(presta_apl),
         i_rsa = as.numeric(presta_rsa),
         i_chom = as.numeric(presta_chomage),
         i_handi = as.numeric(presta_handi),
         i_bourse = as.numeric(presta_etudes),
         i_hlm = as.numeric(presta_hlm),
  ) %>% 
  dplyr::select(ident, s_sentpauvrisque, s_infminidecla,
m_quantilenivie_inv, m_locatif_inv, m_financier_inv,
i_log, i_rsa, i_chom, i_handi, i_bourse, i_hlm, sexe)


```

## Correlation coefficients

A correlation coefficient suited for dichotomous data and based on this underlying normal strategy is the tetrachoric correlation. It gives us a single number describing the degree of dependence in the table above with the extreme values of 1 if the off-diagonals are 0 and -1 if the diagonals are 0. In addition, we get estimates for the thresholds tau1 and tau2. polycholoric existe aussi pour deux items polytomous. 

We print out the last six eigenvalues and see that the last eigenvalue is negative. Thus, this matrix does not fulfill the properties of a correlation matrix. The trick is now to apply some smoothing on the correlations.

The final criterion is interpretability.

### Indicatrices

```{r, echo=FALSE}
bdd_fa_small <- bdd_fa %>% 
  dplyr::select(s_sentpauv, s_risqpauv, s_infminidecla,
m_nivie1, m_nivie2, m_nivie3, m_nivie4, m_nivie5, m_locatif, m_financier,
i_log, i_rsa, i_chom, i_handi, i_bourse, i_hlm) 

# Matrice de corrélation pearson
cor_pearson = cor(bdd_fa_small %>% na.omit(), method = "pearson")
correlation_ggplot(mat=cor_pearson, ordre = c("s_sentpauv","s_infminidecla","i_log","i_rsa","m_nivie1","i_hlm","i_bourse",
                                                   "i_handi","i_chom","m_nivie2","s_risqpauv","m_nivie3","m_nivie4","m_nivie5","m_locatif",
                                                   "m_financier"),
                   titre_legende = "Corrélation Pearson", seuilcroix = 0.3)
# Matrice de corrélation tétra
bdd_fa_tetra <- tetrachoric(bdd_fa_small, smooth = TRUE)
correlation_ggplot(mat=bdd_fa_tetra$rho, ordre = c("s_sentpauv","s_infminidecla","i_log","i_rsa","m_nivie1","i_hlm","i_bourse",
                                                   "i_handi","i_chom","m_nivie2","s_risqpauv","m_nivie3","m_nivie4","m_nivie5","m_locatif",
                                                   "m_financier"),
                   titre_legende = "Corrélation Tétra", seuilcroix = 0.3)
```

### Variables catégorielles (plus de 2 modalités possibles)

```{r, eval=TRUE, echo=FALSE}
bdd_poLCA_small <- bdd_poLCA %>% 
  dplyr::select(s_sentpauvrisque, s_infminidecla,
m_quantilenivie_inv, m_locatif_inv, m_financier_inv,
i_log, i_rsa, i_chom, i_handi, i_bourse, i_hlm)


# Matrice de corrélation spearman
cor_spearman = cor(bdd_poLCA_small %>% na.omit(), method = "spearman")
correlation_ggplot(mat=cor_spearman, ordre = c("m_quantilenivie_inv","m_locatif_inv","m_financier_inv","s_sentpauvrisque", "s_infminidecla", "i_rsa", "i_log", "i_hlm","i_chom","i_bourse","i_handi"),
                   titre_legende = "Corrélation Spearman", seuilcroix = 0.3)
# Matrice de corrélation poly
#If using data with a variable number of response alternatives, it is necessary to use the global=FALSE option in polychoric.
bdd_poLCA_poly <- polychoric(bdd_poLCA_small, smooth = TRUE, global=FALSE)
correlation_ggplot(mat=bdd_poLCA_poly$rho, ordre = c("m_quantilenivie_inv","m_locatif_inv","m_financier_inv","s_sentpauvrisque", "s_infminidecla", "i_rsa", "i_log", "i_hlm","i_chom","i_bourse","i_handi"),
                   titre_legende = "Corrélation Poly", seuilcroix = 0.3)
```


## Exploratory Factor Analysis (EFA)

However, in order to get an even clearer picture, in EFA we typically apply a rotation on the loadings matrix. Such a rotation does not change the fit of the model; it is only done for interpretation purposes by transforming the loadings. We distinguish between two basic types of rotations: orthogonal (qui implique que les facteurs sont indépendants) and nonorthogonal rotation (comme oblimin).

In practice, EFA with oblique rotation is often used prior to a CFA in order to explore whether the underlying latent structure theory is reflected by the data.

```{r, echo=FALSE, eval=FALSE}
# Graphique
# Valeurs propres
vp <- eigen(bdd_fa_tetra$rho)$values
# Conservation de la variance. 
round((vp/sum(vp)*100),2)
scree(bdd_fa_tetra$rho, factors = FALSE)
par(mar=c(0,0,0,0)) #mfrow=c(1,1),
resnf <- nfactors(bdd_fa_tetra$rho, n = 8, fm = "ml", cor = "tet")

pauvFA <- fa(bdd_fa_tetra$rho, nfactors = 3, rotate = "oblimin", fm = "ml", cor="tet", scores= "regression", missing = TRUE, impute = "median") 
# New approche plus classique ?
#pauvFA <- fa(bdd_fa_small, nfactors = 3, rotate = "oblimin", fm = "ml", cor="tet", scores= "regression", missing = TRUE, impute = "median") 

summary(pauvFA)

#Factor loading can be classified based on their magnitude.
#* 0.50 or more - Practically significant
#* 0.40 to 0.49 - More important
#* 0.30 to 0.39 - Minimum consideration level

fa.diagram(pauvFA,cut=0)

# reproduction lavaan
modlavaan <- 'ML3 =~ 0.817*s_infminidecla + m_nivie5 + m_financier + m_locatif + s_sentpauv + s_risqpauv
          ML1 =~ 0.996*i_log + i_rsa + i_hlm + i_handi + m_nivie4 #+ i_chom
          ML2 =~0.832*m_nivie1 + m_nivie2 + m_nivie3'
pauvFAlavaan <- lavaan::cfa(modlavaan,bdd_fa_small,std.lv=TRUE)

lavaan.diagram(pauvFAlavaan, cut=0)
# Diagramme complètement différent avec lavaan... pas compatible

# reproduction lavaan simplifié (que ceux >0.4)
modlavaan <- 'ML3 =~ 0.817*s_infminidecla + m_nivie5 + m_financier + m_locatif + s_sentpauv
          ML1 =~ 0.996*i_log + i_rsa + i_hlm
          ML2 =~0.832*m_nivie1 + m_nivie2'
pauvFAlavaan <- lavaan::cfa(modlavaan,bdd_fa_small,std.lv=TRUE)

lavaan.diagram(pauvFAlavaan, cut=0)


fa.plot(pauvFA$loadings[,1:2], labels=row.names(bdd_fa_tetra$rho), cluster = c(rep(1,3),rep(2,7),rep(3,6)))
fa.plot(pauvFA$loadings[,2:3], labels=row.names(bdd_fa_tetra$rho), cluster = c(rep(1,3),rep(2,7),rep(3,6)))
fa.plot(pauvFA$loadings[,c(3,2)], labels=row.names(bdd_fa_tetra$rho), cluster = c(rep(1,3),rep(2,7),rep(3,6)))

print(pauvFA$loadings, cutoff = 0.2)
round(pauvFA$communality, 2)
```


<!-- ### Variables catégorielles  -->

```{r, echo=FALSE, eval = TRUE}
# Graphique
# Valeurs propres
vp <- eigen(bdd_poLCA_poly$rho)$values
# Conservation de la variance. 
round((vp/sum(vp)*100),2)
scree(bdd_poLCA_poly$rho, factors = FALSE)
par(mar=c(0,0,0,0)) #mfrow=c(1,1),
resnf <- nfactors(bdd_poLCA_poly$rho, n = 8, fm = "ml", cor = "tet")

#Analyse en facteurs
pauvFA2 <- fa(bdd_poLCA_poly$rho, nfactors = 2, rotate = "oblimin", fm = "ml", cor="poly", scores= "regression", missing = TRUE, impute = "median") 
# Poids des scores par défaut. On peut utiliser une autre méthode si besoin
factor.scores(bdd_poLCA_poly$rho, pauvFA2, method="Thurstone")
# Summary
summary(pauvFA2)
print(pauvFA2$loadings, cutoff = 0.3)
round(pauvFA2$communality, 2)

fa.plot(pauvFA2$loadings[,1:2], labels=row.names(bdd_poLCA_poly$rho), cluster = c(rep(1,2),rep(2,3),rep(3,6)))

# fa.plot(pauvFA2$loadings[,2:3], labels=row.names(bdd_poLCA_poly$rho), cluster = c(rep(1,2),rep(2,1),rep(3,3)))
# fa.plot(pauvFA2$loadings[,c(3,2)], labels=row.names(bdd_poLCA_poly$rho), cluster = c(rep(1,2),rep(2,1),rep(3,3)))

```

Premier type de clustering (de variables et non d'individus) avec iclust

```{r, echo=FALSE, fig.height = 6}
ic.poly <- iclust(bdd_poLCA_poly$rho,title="ICLUST using polychoric correlations")
#iclust.diagram(ic.poly)
```




## Latent Categorical Variables

Source : https://m-clark.github.io/sem/mixture-models.html

Documentation https://raw.githubusercontent.com/dlinzer/poLCA/master/inst/doc/poLCA-manual-1-4.pdf


```{r, echo=FALSE, fig.height = 3}
actives_autres <- c("quantile_nivie","revenus_financiers","revenus_locatifs","presta_rsa","presta_chomage","presta_apl","presta_handi","presta_etudes", "presta_hlm")
actives_subj <- c("subj_pauvrete_et_risque", "subj_inf_mini_decla")
actives <- c(actives_subj,actives_autres)
passives <- c("statut_occup", "diplome", "conn_rsa","annee_fac", "prof_statut_act", "age_tranche","vie_fam"#,"presta_handi",
              )

num_indiv <- bdd_logit %>% 
  dplyr::select(c(all_of("ident"),all_of(actives),all_of(passives))) %>% 
  tidyr::drop_na() %>% dplyr::select(ident) %>% pull()
bdd_poLCA_rmnasup <- bdd_poLCA %>% filter(ident%in%num_indiv)

par(mfrow=c(1,1),mar=c(5,4,4,2)+0.1)

set.seed(1)

nbclasses = 6
```


```{r, echo=FALSE, eval=FALSE, fig.height = 3}
modele_poLCA <- function(nbclasses, verbose=TRUE){
  result = poLCA(cbind(s_sentpauvrisque, s_infminidecla,
m_quantilenivie_inv,m_locatif_inv, m_financier_inv,
i_log, i_rsa, i_chom, i_handi, i_bourse, i_hlm) ~ 1, bdd_poLCA_rmnasup,nrep=1,nclass=nbclasses, graphs=FALSE, na.rm=TRUE, verbose = verbose,maxiter = 5000)
  return(result)
}

# Tous les modèles pour comparer les fits
result2 <- modele_poLCA(2, verbose=FALSE)
result3 <- modele_poLCA(3, verbose=FALSE)
result4 <- modele_poLCA(4, verbose=FALSE)
result5 <- modele_poLCA(5, verbose=FALSE)
result6 <- modele_poLCA(6, verbose=FALSE)
result7 <- modele_poLCA(7, verbose=FALSE)
result8 <- modele_poLCA(8, verbose=FALSE)


tab.modfit <- c()
for(i in 2:8){
  lc <- get(paste0("result",i))
  tab.modfit <- rbind(tab.modfit, 
                      c(i,
                        lc$llik, 
                        lc$resid.df, 
                        lc$bic,                                  (-2*lc$llik)+((log((lc$N + 2)/24))* get(paste0("result",i))$npar),
                        lc$aic,
                        (-2*lc$llik)+ lc$npar * (1+log(lc$N)),
                        lc$Gsq,
                        lc$Chisq,
                        1 - sum(lc$posterior * log(lc$posterior), na.rm=T) / (nrow(lc$posterior) * log(ncol(lc$posterior)))
                      ))
}
tab.modfit <- data.frame(round(tab.modfit,2))
colnames(tab.modfit) <- c("Nombre de classes","Valeur maximiale de la log-vraisemblance", "Degrés de liberté des résidus", "BIC", "BIC ajusté", "AIC", "AIC consistant", "Ratio de vraisemblance", "Chi2 de Pearson (données estimées versus observées)", "Entropie")
tab.modfit
saveRDS(tab.modfit,"../rapport/figures/tab_modfit.RDS")

# Modèle final à 6 classes
result = modele_poLCA(nbclasses=nbclasses)

# Lister dans l'ordre ou c'est dessiné
# c(3,4,6,2,1,5) non
# c(5,4,1,2,6,3) oui

probs.start.new <- poLCA.reorder(result$probs.start,c(3,2,6,1,4,5))
  
result = poLCA(cbind(s_sentpauvrisque, s_infminidecla,
m_quantilenivie_inv,m_locatif_inv, m_financier_inv,
i_log, i_rsa, i_chom, i_handi, i_bourse, i_hlm) ~ 1, bdd_poLCA_rmnasup,nrep=1,nclass=nbclasses, graphs=FALSE, na.rm=TRUE,  probs.start=probs.start.new, verbose = FALSE,maxiter = 5000)

saveRDS(result,"../data/result.rds")
```


```{r, echo=FALSE, fig.height = 5, fig.width=10}
result <- readRDS("../data/result.rds")
res.mca <- readRDS("../data/res.mca.rds")
noms_classes <- c("A","B","C.1","C.2","D.1","D.2")
s.class(res.mca$ind$coord[,c(1,2)], factor(result$predclass,labels=noms_classes), col = c("#2166ac","#67a9cf","#9970ab","#762a83","#e9a3c9","#c51b7d"), sub = "Axes 1 et 2")

saveRDS(factor(result$predclass,labels=noms_classes),"../data/latent_classes.rds")

for(i in 1:nbclasses){
poLCA.makeplot.poly.oneclass(result,i, noms_classes = noms_classes)
}

```


## Confirmatory factor analysis (CFA) des dimensions de la pauvreté 

EFA and CFA are mathematically very similar, since we have the same fundamental equation in both cases. 


```{r, echo=FALSE}
bdd_CFA_rmnasup  <- bdd_logit %>% 
  mutate(s_sentpauvrisque = as.numeric(subj_pauvrete_et_risque),
         s_infminidecla = ifelse(as.numeric(subj_inf_mini_decla)==2,1,2),
         m_quantilenivie = as.numeric(substr(quantile_nivie,11,11)),
         m_quantilenivie_inv = 6-as.numeric(substr(quantile_nivie,11,11)),
         m_locatif = as.numeric(revenus_locatifs),
         m_locatif_inv = 3-as.numeric(revenus_locatifs),
         m_financier = as.numeric(revenus_financiers),
         m_financier_inv = 3-as.numeric(revenus_financiers),
         i_log = as.numeric(presta_apl),
         i_rsa = as.numeric(presta_rsa),
         i_chom = as.numeric(presta_chomage),
         i_handi = as.numeric(presta_handi),
         i_bourse = as.numeric(presta_etudes),
         i_hlm = as.numeric(presta_hlm),
         cov_sexe_femme = ifelse(sexe=="-Femme",1,0),
         cov_sexe_homme = ifelse(sexe=="-Homme",1,0),
         cov_statut_occup0_proprio = ifelse(statut_occup0=="-Propriétaire",1,0),
          cov_statut_occup0_locataire = ifelse(statut_occup0=="-Locataire ou hébergé",1,0),
         cov_diplome_sans = ifelse(diplome=="-CAP, BEP ou moins",1,0),
         cov_diplome_bac = ifelse(diplome=="-Baccalauréat",1,0),
         cov_diplome_bacplus2 = ifelse(diplome=="-Bac + 2",1,0), 
         cov_diplome_bacplus3 = ifelse(diplome=="-Bac + 3 ou plus",1,0),
         cov_prof_statut_act_inter = ifelse(prof_statut_act=="-Profession intermédiaire",1,0),
         cov_prof_statut_act_chom = ifelse(prof_statut_act=="-Chômeur",1,0),
         cov_prof_statut_act_ouv = ifelse(prof_statut_act=="-Ouvrier",1,0),
         cov_prof_statut_act_commer = ifelse(prof_statut_act=="-Artisan commerçant",1,0),
         cov_prof_statut_act_employ = ifelse(prof_statut_act=="-Employé",1,0),
         cov_prof_statut_act_autrinac = ifelse(prof_statut_act=="-Autre inactif",1,0),
         cov_prof_statut_act_foyer = ifelse(prof_statut_act=="-Au foyer",1,0),
         cov_prof_statut_act_cadre = ifelse(prof_statut_act=="-Cadre supérieur, profession libérale",1,0),
         cov_prof_statut_act_retr = ifelse(prof_statut_act=="-Retraité",1,0),
         cov_prof_statut_act_agri = ifelse(prof_statut_act=="-Agriculteur",1,0),
         cov_prof_statut_act_commer = ifelse(prof_statut_act=="-Artisan commerçant",1,0),
         cov_age_tranche_1829 = ifelse(age_tranche=="-18 à 29 ans",1,0),
         cov_age_tranche_3039 = ifelse(age_tranche=="-30 à 39 ans",1,0),
         cov_age_tranche_4049 = ifelse(age_tranche=="-40 à 49 ans",1,0),
         cov_age_tranche_5059 = ifelse(age_tranche=="-50 à 59 ans",1,0),
         cov_age_tranche_6069 = ifelse(age_tranche=="-60 à 69 ans",1,0),
         cov_age_tranche_70 = ifelse(age_tranche=="-70 ans et plus",1,0),
         cov_vie_fam_mono = ifelse(vie_fam=="-Chef famille monoparentale",1,0),
         cov_vie_fam_seul = ifelse(vie_fam=="-Vit seul",1,0),
         cov_vie_fam_coupsansenf = ifelse(vie_fam=="-Membre du couple (pas d’enfants à charge)",1,0),
         cov_vie_fam_coupenf = ifelse(vie_fam=="-Membre du couple (enfants à charge)",1,0),
         cov_vie_fam_autre = ifelse(vie_fam=="-Autre situation familiale",1,0),
         cov_vie_fam_enf = ifelse(vie_fam=="-Enfant",1,0)
  ) %>%
  filter(ident%in%num_indiv) %>% 
  dplyr::select(s_sentpauvrisque, s_infminidecla,
m_quantilenivie_inv, m_locatif_inv, m_financier_inv,
i_log, i_rsa, i_chom, i_handi, i_bourse, i_hlm, cov_sexe_femme, cov_sexe_homme, cov_statut_occup0_locataire, cov_statut_occup0_proprio, cov_diplome_sans, cov_diplome_bac, cov_diplome_bacplus2, cov_diplome_bacplus3, cov_prof_statut_act_inter, cov_prof_statut_act_chom, cov_prof_statut_act_ouv, cov_prof_statut_act_commer, cov_prof_statut_act_employ, cov_prof_statut_act_autrinac, cov_prof_statut_act_foyer, cov_prof_statut_act_cadre, cov_prof_statut_act_retr, cov_prof_statut_act_agri, cov_prof_statut_act_commer, cov_age_tranche_1829, cov_age_tranche_3039, cov_age_tranche_4049, cov_age_tranche_5059, cov_age_tranche_6069, cov_age_tranche_70, cov_vie_fam_mono, cov_vie_fam_seul, cov_vie_fam_coupenf, cov_vie_fam_coupsansenf, cov_vie_fam_autre, cov_vie_fam_enf) %>% 
  mutate(s_sentpauvrisque_std = scale(s_sentpauvrisque))
```



### Modèle avec 3 dimensions de la pauvreté (i,m,s) ORTHOGONALES + SANS hiérarchie

=> Le modèle avec les dimensions de la pauvreté orthogonales peut être qualifié de très mauvais. C'est pourquoi on teste juste après le même modèle avec rotation oblique. 

```{r, echo=FALSE, eval=TRUE}
pauv_model1 <- '
s =~ s_sentpauvrisque + s_infminidecla
m =~ m_quantilenivie_inv + m_locatif_inv + m_financier_inv
i =~ i_rsa + i_chom + i_log + i_handi + i_bourse + i_hlm 
'

fit1 <- lavaan::cfa(pauv_model1, data = bdd_CFA_rmnasup,
ordered = TRUE, orthogonal=TRUE) #estimator = "WLSMV"

fit1_var <- lavaan::cfa(pauv_model1, data = bdd_CFA_rmnasup,
ordered = TRUE, orthogonal=TRUE,std.lv = TRUE) #estimator = "WLSMV"

semPaths(fit1_var, what = "est", edge.label.cex = 0.7,
edge.color = 1, esize = 1, sizeMan = 4.5, asize = 2.5,
intercepts = FALSE, rotation = 4, thresholdColor = "red",
mar = c(1, 5, 1.5, 5), fade = FALSE, nCharNodes = 4)

# fitMeasures
print("fit1_var: ")
fitMeasures(fit1_var)[c("chisq","df","pvalue","cfi","tli","rmsea", "srmr")]

```


```{r, echo=FALSE, eval=FALSE}
# # Error variance of indicators
 diag(inspect(fit1, what = "est")$theta)
# # Loadings and standardized loadings
 inspect(fit1, what = "est")$lambda
 inspect(fit1, what = "std")$lambda
# # Latent variable covariance matrix
 inspect(fit1, what = "est")$psi
 inspect(fit1, what = "std")$psi
# # Covariance matrix
 parameterEstimates(fit1, standardized = TRUE)
# Summary
summary(fit1, standardized = TRUE, fit.measures = TRUE, ci=TRUE)

```

### Modèle avec 3 dimensions de la pauvreté (i,m,s) OBLIQUES + SANS hiérarchie

#### Sans covariates avec dimension subjective

Graphique 

```{r, echo=FALSE}
pauv_model2 <- '
s =~ s_sentpauvrisque + s_infminidecla
m =~ m_quantilenivie_inv + m_locatif_inv + m_financier_inv
i =~ i_rsa + i_chom + i_log + i_handi + i_bourse + i_hlm 
'

fit2 <- lavaan::cfa(pauv_model2, data = bdd_CFA_rmnasup,
ordered = TRUE, orthogonal=FALSE) #estimator = "WLSMV"

fit2_var <- lavaan::cfa(pauv_model2, data = bdd_CFA_rmnasup,
ordered = TRUE, orthogonal=FALSE,std.lv = TRUE) #estimator = "WLSMV"

semPaths(fit2_var, what = "est", edge.label.cex = 0.7,
edge.color = 1, esize = 1, sizeMan = 4.5, asize = 2.5,
intercepts = FALSE, rotation = 4, thresholdColor = "red",
mar = c(1, 5, 1.5, 5), fade = FALSE, nCharNodes = 4)

# Summary
#summary(fit2_var, standardized = TRUE, fit.measures = TRUE, ci=TRUE)

# fitMeasures
print("fit2_var: ")
fitMeasures(fit2_var)[c("chisq","df","pvalue","cfi","tli","rmsea", "srmr")]

```



**Règles pour être un modèle acceptable** : 

- p-valeur du test du chi-2 de 0, très mauvais car un résultat non significatif veut dire que le modèle "fits" mais il ne faut pas faire très attention à cette statistique car elle est très souvent significative quand l'échantillon est grand, c'est-à-dire dans notre cas
- Le CFI doit être supérieur à 0,95.
- Le RMSEA doit être dans l'intervalle [0.05,0.10].
- Le SRMR doit être inférieur à 0.08.

Confirmément à ce à quoi on s'attendait, fit2 a des indicateurs de qualité du modèle bien meilleurs que fit1 : il faut introduire des corrélations entre facteurs (oblique).

```{r, echo=FALSE, eval=FALSE}
 semTools::compareFit(fit1, fit2)@fit %>% 
   dplyr::select(chisq, df, pvalue, cfi, tli, rmsea, srmr) 
```



#### Sans covariates sans dimension subjective

Graphique

```{r, echo=FALSE}
pauv_model3 <- '
m =~ m_quantilenivie_inv + m_locatif_inv + m_financier_inv
i =~ i_rsa + i_chom + i_log + i_handi + i_bourse + i_hlm 
m ~~ s_sentpauvrisque_std
i ~~ s_sentpauvrisque_std
'

fit3_var <- lavaan::cfa(pauv_model3, data = bdd_CFA_rmnasup,
ordered = TRUE, orthogonal=FALSE,std.lv = TRUE) #estimator = "WLSMV"

semPaths(fit3_var, what = "est", edge.label.cex = 0.7,
edge.color = 1, esize = 1, sizeMan = 4.5, asize = 2.5,
intercepts = FALSE, rotation = 4, thresholdColor = "red",
mar = c(1, 5, 1.5, 5), fade = FALSE, nCharNodes = 4)

print("fit2_var : ")
fitMeasures(fit2_var)[c("chisq","df","pvalue","cfi","tli","rmsea", "srmr")]
print("fit3_var : ")
fitMeasures(fit3_var)[c("chisq","df","pvalue","cfi","tli","rmsea", "srmr")]
```


#### CFA avec des covariables (MIMIC)

MIMIC stands for multiple indicators multiple independent causes (Jöreskog and Goldberger, 1975) and is a general structural latent variable concept where CFA is extended in terms of linking covariates with latent variables. MIMIC models can be used to control for sociodemographic or other types of covariates in CFA and more
general SEM specifications.

Remarque : ne marche qu'avec les covariates exogènes de moins de 2 facteurs (c'est pourquoi nous avons transformé toutes les covariate en indicatrices du type : indicatrice d'être un couple sans enfant, etc.)

Remarque : le contrôle "Propriétaire" n'a pas été ajouté en raison de sa colinéarité avec l'indicateur de pauvreté institutionnelle de locataire d'un HLM. L'intégrer ne permettait pas aux modèles de converger. 

```{r, echo=FALSE}
#pauv_model_mimic_inter <- '
# s =~ s_sentpauvrisque + s_infminidecla
# m =~ m_quantilenivie_inv + m_locatif_inv + m_financier_inv
# i =~ i_rsa + i_chom + i_log + i_handi + i_bourse + i_hlm 
# # Controles intermediaires
# i ~  cov_prof_statut_act_agri + cov_prof_statut_act_commer + cov_prof_statut_act_cadre + cov_prof_statut_act_employ + cov_prof_statut_act_ouv + cov_prof_statut_act_chom + 
# cov_prof_statut_act_retr +  cov_prof_statut_act_foyer +
# cov_prof_statut_act_autrinac + cov_diplome_sans + cov_diplome_bacplus2 + cov_diplome_bacplus3 + cov_age_tranche_1829 + cov_age_tranche_4049 + cov_age_tranche_5059 + cov_age_tranche_6069 + cov_age_tranche_70 +
# cov_vie_fam_seul + cov_vie_fam_coupenf + cov_vie_fam_mono +
# cov_vie_fam_enf   + cov_vie_fam_autre +  cov_sexe_homme
# m ~  cov_prof_statut_act_agri + cov_prof_statut_act_commer + cov_prof_statut_act_cadre + cov_prof_statut_act_employ + cov_prof_statut_act_ouv + cov_prof_statut_act_chom + 
# cov_prof_statut_act_retr +  cov_prof_statut_act_foyer +
# cov_prof_statut_act_autrinac + cov_diplome_sans + cov_diplome_bacplus2 + cov_diplome_bacplus3 + cov_age_tranche_1829 + cov_age_tranche_4049 + cov_age_tranche_5059 + cov_age_tranche_6069 + cov_age_tranche_70 +
# cov_vie_fam_seul + cov_vie_fam_coupenf + cov_vie_fam_mono +
# cov_vie_fam_enf   + cov_vie_fam_autre +  cov_sexe_homme
# s ~  cov_prof_statut_act_agri + cov_prof_statut_act_commer + cov_prof_statut_act_cadre + cov_prof_statut_act_employ + cov_prof_statut_act_ouv + cov_prof_statut_act_chom + 
# cov_prof_statut_act_retr +  cov_prof_statut_act_foyer +
# cov_prof_statut_act_autrinac + cov_diplome_sans + cov_diplome_bacplus2 + cov_diplome_bacplus3 + cov_age_tranche_1829 + cov_age_tranche_4049 + cov_age_tranche_5059 + cov_age_tranche_6069 + cov_age_tranche_70 +
# cov_vie_fam_seul + cov_vie_fam_coupenf + cov_vie_fam_mono +
# cov_vie_fam_enf   + cov_vie_fam_autre +  cov_sexe_homme
# '

pauv_model_mimic_inter <- '
m =~ m_quantilenivie_inv + m_locatif_inv + m_financier_inv
i =~ i_rsa + i_chom + i_log + i_handi + i_bourse + i_hlm 
m ~~ s_sentpauvrisque_std
i ~~ s_sentpauvrisque_std
# Controles intermediaires
i ~  cov_prof_statut_act_agri + cov_prof_statut_act_commer + cov_prof_statut_act_cadre + cov_prof_statut_act_employ + cov_prof_statut_act_ouv + cov_prof_statut_act_chom + 
cov_prof_statut_act_retr +  cov_prof_statut_act_foyer +
cov_prof_statut_act_autrinac + cov_diplome_sans + cov_diplome_bacplus2 + cov_diplome_bacplus3 + cov_age_tranche_1829 + cov_age_tranche_4049 + cov_age_tranche_5059 + cov_age_tranche_6069 + cov_age_tranche_70 +
cov_vie_fam_seul + cov_vie_fam_coupenf + cov_vie_fam_mono +
cov_vie_fam_enf   + cov_vie_fam_autre +  cov_sexe_homme
m ~  cov_prof_statut_act_agri + cov_prof_statut_act_commer + cov_prof_statut_act_cadre + cov_prof_statut_act_employ + cov_prof_statut_act_ouv + cov_prof_statut_act_chom + 
cov_prof_statut_act_retr +  cov_prof_statut_act_foyer +
cov_prof_statut_act_autrinac + cov_diplome_sans + cov_diplome_bacplus2 + cov_diplome_bacplus3 + cov_age_tranche_1829 + cov_age_tranche_4049 + cov_age_tranche_5059 + cov_age_tranche_6069 + cov_age_tranche_70 +
cov_vie_fam_seul + cov_vie_fam_coupenf + cov_vie_fam_mono +
cov_vie_fam_enf   + cov_vie_fam_autre +  cov_sexe_homme
s_sentpauvrisque_std ~  cov_prof_statut_act_agri + cov_prof_statut_act_commer + cov_prof_statut_act_cadre + cov_prof_statut_act_employ + cov_prof_statut_act_ouv + cov_prof_statut_act_chom + 
cov_prof_statut_act_retr +  cov_prof_statut_act_foyer +
cov_prof_statut_act_autrinac + cov_diplome_sans + cov_diplome_bacplus2 + cov_diplome_bacplus3 + cov_age_tranche_1829 + cov_age_tranche_4049 + cov_age_tranche_5059 + cov_age_tranche_6069 + cov_age_tranche_70 +
cov_vie_fam_seul + cov_vie_fam_coupenf + cov_vie_fam_mono +
cov_vie_fam_enf   + cov_vie_fam_autre +  cov_sexe_homme
'

fit_mimic_inter <- lavaan::cfa(pauv_model_mimic_inter, data = bdd_CFA_rmnasup,ordered=TRUE, orthogonal=FALSE,std.lv = TRUE)


semPaths(fit_mimic_inter, what = "est", edge.label.cex = 0.7,
edge.color = 1, esize = 1, sizeMan = 4.5, asize = 2.5,
intercepts = FALSE, rotation = 4, thresholdColor = "red",
mar = c(1, 5, 1.5, 5), fade = FALSE, nCharNodes = 4)

sum2 <- summary(fit_mimic_inter, standardized = TRUE, fit.measures = TRUE)

print("fit3_var : ")
fitMeasures(fit2_var)[c("chisq","df","pvalue","cfi","tli","rmsea", "srmr")]

print("fit_mimic_inter : ")
fitMeasures(fit_mimic_inter)[c("chisq","df","pvalue","cfi","tli","rmsea", "srmr")]



```



Effet souvent plus faible du subjectif par rapport aux deux autres dimensions. 

Le sentiment de pauvreté est celui qui a l’effet le moins prononcé. 

**PCS**

- Ouvrier (subjectif très fort). Dans une moindre mesure employés
- Chômeur, au foyer et autres inactifs : monétaire et institutionnel très fort. Subjectif fort également mais bien moindre comparé aux deux autres dimensions. 

**Diplôme**

- RAS

**Âge**

- 18-29 ans : effet proche de la référence mais élément étrange : l’effet du subjectif est légèrement négatif alors que monétaire et institutionnel est légèrement positif
- 70 ans et + : faible pauvreté sur l’ensemble des dimensions mais plus particulièrement sur les dimensions monétaires et institutionnel. Ils peuvent parfois se sentir pauvres

**Situation familiale**

- Couple avec enfant : monétaire et institutionnel relativement fort mais subjectif très proche des couples avec enfants
- Chef famille mono : Effet très fort de toutes les dimensions mais plus particulièrement institutionnelle
- Vie seul, l’effet du subjectif est presque aussi fort que l’effet institutionnel et monétaire qui est de moyenne ampleur. 


<!-- Ci-dessous quelques moyens de voir comment on pourrait améliorer le modèles pour le rendre encore meilleur.  -->

<!-- - Les résidus qui ont une covariance supérieure à 0.1 peuvent être à regarder de plus près : (i_handi, i_rsa), (i_hlm, i_rsa), (i_log, i_bourse), (i_bourse, m_foncier), (i_rsa, m_foncier), (m_foncier, m_locatif), (i_rsa, m_locatif), (i_bourse, s_infminidecla),  -->
<!-- - Il semblerait que d'intégrer le sentiment de pauvreté non pas dans la dimension subjective mais dans les 3 dimensions de la pauvreté améliorerait potentiellement le modèle... Ce qui interroge sur le statut de cette variable. Idem un peu plus bas pour s_infminidecla qui pourrait loadé m et i... -->
<!-- - Il faudrait également éventuellement corréler s_infminidecla avec m_quantilenivie, on a vu dans les stats desc que c'était 2 variables très corrélées ensemble et ce ne serait effectivement pas idiot de le faire !  -->

<!-- Ce nouveau modèle étrange est effectivement meilleur ! -->

```{r, echo=FALSE, eval=FALSE}
#head(parameterEstimates(fit2))
# Quels résidus sont supérieurs à 0.1 ?
residuals(fit2, type = "cor")$cov
# Ou  expected vs. observed counts in each level instead pour variables catégorielles
head(lavTables(fit2)[c(2,3,8,9)])
# modification Indices (mais garder en tête généralisation et non over-fitting)
head(modificationIndices(fit2, sort.=TRUE, minimum.value=3))

```

```{r, echo=FALSE, eval=FALSE}
pauv_model2_mi <- '
s =~ s_sentpauvrisque + s_infminidecla
m =~ m_quantilenivie_inv + m_locatif_inv + m_financier_inv + s_sentpauvrisque + s_infminidecla
i =~ i_rsa +  i_chom + i_log + i_handi + i_bourse + i_hlm + s_sentpauvrisque + s_infminidecla
s_infminidecla ~~ m_quantilenivie_inv
'

fit2_mi <- lavaan::cfa(pauv_model2_mi, data = bdd_CFA_rmnasup,
ordered = TRUE, orthogonal=FALSE) #estimator = "WLSMV"


semPaths(fit2_mi, what = "est", edge.label.cex = 0.7,
edge.color = 1, esize = 1, sizeMan = 4.5, asize = 2.5,
intercepts = FALSE, rotation = 4, thresholdColor = "red",
mar = c(1, 5, 1.5, 5), fade = FALSE, nCharNodes = 4)

# Summary
# summary(fit2_mi, standardized = TRUE, fit.measures = TRUE, ci=TRUE)

print("fit2_mi : ")
fitMeasures(fit2_mi)[c("chisq","df","pvalue","cfi","tli","rmsea", "srmr")]

print("fit2 : ")
fitMeasures(fit2)[c("chisq","df","pvalue","cfi","tli","rmsea", "srmr")]

```


### Modèle avec 2 dimensions de la pauvreté (i,m) et le sentiment de pauvreté (s tronqué) ORTHOGONALES + AVEC hiérarchie

En oblique, il y a un problème avec le modèle, avec des NA pour les standard-error. Comme si le modèle n'était pas bien identifié... Cela semble être dû à l'intégration des corrélations entre s,m et i. Je pense que le fait d'intégrer une hiérarchie intègre de fait une corrélation entre les dimensions s,m et i et que si on les rajoute en plus le modèle n'a plus de sens.

```{r, echo=FALSE, eval=FALSE}
pauv_model_hier2 <- '
s =~ s_sentpauvrisque + s_infminidecla
m =~ m_quantilenivie_inv + m_locatif_inv + m_financier_inv
i =~  i_rsa +  i_chom + i_log + i_handi + i_bourse + i_hlm 
pauvrete =~ m + i + s
# non orthogonal factors
   s ~~ m
   s ~~ i
   m ~~ i
'

fit_hier2 <- lavaan::cfa(pauv_model_hier2, data = bdd_CFA_rmnasup,
ordered = TRUE, orthogonal=FALSE)

```


Du coup on enlève les corrélations entre i,m et s pour voir ce que ça donne... Le modèle est pas mal.  Deux corrections sont effectuées
- On fixe un loading de chaque catégorie à une valeur de référence (celle trouvée dans le précédent modèle)
- Il y a juste une variance négative (Heywood case) de m que nous corrigeons en remplaçant la variance légèrement négative de m par une variance légèrement positive (la variance nulle fait aussi bugger le modèle). Le modèle n'est que légèrement moins bien mais permet d'estimer les scores des facteurs latents (avec la fonction predict)

```{r, echo=FALSE, eval=FALSE}
# Ce modèle est en fait équivalent à fit2 !
pauv_model_hier1 <- '
s =~ s_sentpauvrisque + s_infminidecla
m =~ m_quantilenivie_inv + m_locatif_inv + m_financier_inv
i =~  i_rsa +  i_chom + i_log + i_handi + i_bourse + i_hlm 
pauvrete =~ m + i + s
'
pauv_model_hier1_var <- '
s =~ 0.67*s_sentpauvrisque + s_infminidecla
m =~ 0.85*m_quantilenivie_inv + m_locatif_inv + m_financier_inv
i =~  0.75*i_rsa +  i_chom + i_log + i_handi + i_bourse + i_hlm 
pauvrete =~ NA*m + i + s
# Correction de la variance négative
m ~~ 0.01*m
pauvrete ~~ 1 * pauvrete
'

fit_hier1_var <- lavaan::cfa(pauv_model_hier1_var, data = bdd_CFA_rmnasup,
ordered = TRUE, orthogonal=TRUE, std.lv=FALSE)

semPaths(fit_hier1_var, what = "est", edge.label.cex = 0.7,
edge.color = 1, esize = 1, sizeMan = 4.5, asize = 2.5,
intercepts = FALSE, rotation = 4, thresholdColor = "red",
mar = c(1, 5, 1.5, 5), fade = FALSE, nCharNodes = 4)

summary(fit_hier1_var, standardized = TRUE, fit.measures = TRUE)

```


```{r, echo=FALSE, eval=FALSE}
 semTools::compareFit(fit_hier1_var, fit2)@fit %>% 
   dplyr::select(chisq, df, pvalue, cfi, tli, rmsea, srmr) 
```

Mais on veut rester dans le cadre précédent et ne garder que le sentiment de pauvreté dans la dimension subjective de la pauvreté. 

```{r, echo=FALSE}
# pauv_model_hier3_var <- '
# m =~ 0.85*m_quantilenivie_inv + m_locatif_inv + m_financier_inv
# i =~  0.75*i_rsa +  i_chom + i_log + i_handi + i_bourse + i_hlm 
# pauvrete =~ NA*m + i + s_sentpauvrisque_std
# # Correction de la variance négative
# m ~~ 0.01*m
# pauvrete ~~ 1 * pauvrete
# '

pauv_model_hier3_var <- '
m =~ 0.83*m_quantilenivie_inv + m_locatif_inv + m_financier_inv
i =~ 0.74*i_rsa +  i_chom + i_log + i_handi + i_bourse + i_hlm
pauvrete =~ NA*m + i + s_sentpauvrisque_std
# Correction de la variance négative
m ~~ 0.04*m
pauvrete ~~ 1 * pauvrete
'

fit_hier3_var <- lavaan::cfa(pauv_model_hier3_var, data = bdd_CFA_rmnasup,
ordered = TRUE, orthogonal=TRUE, std.lv=FALSE)

semPaths(fit_hier3_var, what = "est", edge.label.cex = 0.7,
edge.color = 1, esize = 1, sizeMan = 4.5, asize = 2.5,
intercepts = FALSE, rotation = 4, thresholdColor = "red",
mar = c(1, 5, 1.5, 5), fade = FALSE, nCharNodes = 4)

# Pour m
#sqrt(0.830^2*0.284+0.597^2*0.629+0.597^2*0.629+0.04)
# Pour pvrt
#sqrt(0.93^2*?+1^2*?+0.65^2*0.58)


```



```{r, echo=FALSE, eval=FALSE}
predictions <- predict(fit_hier3_var)
predictions <- cbind(predictions,bdd_CFA_rmnasup$s_sentpauvrisque_std) 
colnames(predictions) <- c("m","i","pauvrete","s_sentpauvrisque_std")
saveRDS(predictions,"../data/predictions.rds")
```

```{r, echo=FALSE}
predictions <- readRDS("../data/predictions.rds")
```


Graphiques des résultats où on projette les scores latents de tous les individus. On a bien une corrélation très directe entre s et m, et légèrement plus floue entre i et m (et donc i et s). 

J'affiche aussi les anciennes classes latentes pour montrer que les résultats sont conformes à l'intuition.

```{r, echo=FALSE}
 scatterplot3d(predictions[,c("m","i","s_sentpauvrisque_std")],
               pch=16,
               color="steelblue")
 scatterplot3d(predictions[,c("m","i","s_sentpauvrisque_std")],
               pch=16,
               color="steelblue")

library(ggplot2)
df_troisgraphes <- data.frame(predictions) %>% mutate(typo=result$predclass)
palette <- c("#2166ac","#67a9cf","#9970ab","#762a83","#e9a3c9","#c51b7d")
noms_classes <- c("A","B","C.1","C.2","D.1","D.2")

gg_m_s <- ggplot(df_troisgraphes, aes(x=m, y=s_sentpauvrisque_std)) +
 # stat_ellipse(aes(fill=factor(typo)),type = "t", color="black", cex=0.5, geom="polygon", alpha=0.6) +
  #scale_fill_manual(name="Classe", values=palette, labels=noms_classes) +
  geom_point(aes(color=pauvrete),size=1) +
  scale_colour_gradientn(name= "Score de\npauvreté",colours = rev(brewer.pal(11,"RdYlGn")))+
  #ggnewscale::new_scale("color") +
#  stat_ellipse(aes(color=factor(typo)),type = "t",  cex=1, geom="polygon",fill=NA) +
#  scale_color_manual(name="Classe", values=palette, labels=noms_classes, guide="none") +
  xlab("Score de pauvreté monétaire") +
  ylab("Sentiment de pauvreté (3 modalités)") + 
  theme_minimal()
gg_m_s

gg_m_i <- ggplot(df_troisgraphes, aes(x=m, y=i)) +
  # stat_ellipse(aes(fill=factor(typo)),type = "t", color="black", cex=0.5, geom="polygon", alpha=0.6) +
  # scale_fill_manual(name="Classe", values=palette, labels=noms_classes) +
   geom_point(aes(color=pauvrete),size=1) +
  scale_colour_gradientn(name= "Score de\npauvreté",colours = rev(brewer.pal(11,"RdYlGn")))+
  # ggnewscale::new_scale("color") +
  # stat_ellipse(aes(color=factor(typo)),type = "t",  cex=1, geom="polygon",fill=NA) +
  # scale_color_manual(name="Classe", values=palette, labels=noms_classes, guide="none") +
  xlab("Score de pauvreté monétaire") +
  ylab("Score de pauvreté institutionnelle") + 
  theme_minimal()

gg_m_i

gg_i_s <- ggplot(df_troisgraphes, aes(x=i, y=s_sentpauvrisque_std)) +
#  stat_ellipse(aes(fill=factor(typo)),type = "t", color="black", cex=0.5, geom="polygon", alpha=0.6) +
#  scale_fill_manual(name="Classe", values=palette, labels=noms_classes) +
  geom_point(aes(color=pauvrete),size=2) +
  scale_colour_gradientn(name= "Score de\npauvreté",colours = rev(brewer.pal(11,"RdYlGn")))+
#  ggnewscale::new_scale("color") +
#  stat_ellipse(aes(color=factor(typo)),type = "t",  cex=1, geom="polygon",fill=NA) +
 # scale_color_manual(name="Classe", values=palette, labels=noms_classes, guide="none") +
   ylab("Sentiment de pauvreté (3 modalités)") + 
   xlab("Score de pauvreté institionnelle") +
  theme_minimal()

gg_i_s

```

#### Ajout des contrôles uniquement sur l'indicateur global de pauvreté

```{r, echo=FALSE}
pauv_model_mimic_global <- '
m =~ 0.83*m_quantilenivie_inv + m_locatif_inv + m_financier_inv
i =~ 0.74*i_rsa +  i_chom + i_log + i_handi + i_bourse + i_hlm
pauvrete =~ NA*m + i + s_sentpauvrisque_std
# Correction de la variance négative
m ~~ 0.04*m
pauvrete ~~ 1 * pauvrete
# Controles globaux
pauvrete ~  cov_prof_statut_act_agri + cov_prof_statut_act_commer + cov_prof_statut_act_cadre + cov_prof_statut_act_employ + cov_prof_statut_act_ouv + cov_prof_statut_act_chom + 
cov_prof_statut_act_retr +  cov_prof_statut_act_foyer +
cov_prof_statut_act_autrinac + cov_diplome_sans + cov_diplome_bacplus2 + cov_diplome_bacplus3 + cov_age_tranche_1829 + cov_age_tranche_4049 + cov_age_tranche_5059 + cov_age_tranche_6069 + cov_age_tranche_70 +
cov_vie_fam_seul + cov_vie_fam_coupenf + cov_vie_fam_mono +
cov_vie_fam_enf   + cov_vie_fam_autre +  cov_sexe_homme
'

fit_mimic_global <- lavaan::cfa(pauv_model_mimic_global, data = bdd_CFA_rmnasup,ordered=TRUE)


semPaths(fit_mimic_global, what = "est", edge.label.cex = 0.7,
edge.color = 1, esize = 1, sizeMan = 4.5, asize = 2.5,
intercepts = FALSE, rotation = 4, thresholdColor = "red",
mar = c(1, 5, 1.5, 5), fade = FALSE, nCharNodes = 4)

sum <- summary(fit_mimic_global, standardized = TRUE, fit.measures = TRUE)

print("fit_mimic_global : ")
fitMeasures(fit_mimic_global)[c("chisq","df","pvalue","cfi","tli","rmsea", "srmr")]

print("fit_mimic_inter : ")
fitMeasures(fit_mimic_inter)[c("chisq","df","pvalue","cfi","tli","rmsea", "srmr")]

```

Le modèle avec contrôles devient moins bien que le précédent.



##  Structural equation models (SEM) [pas utilisé dans le mémoire]

Structural equation models (SEM) integrate confirmatory factor analysis (CFA) into a larger path analytic framework. Formally, we extend the basic CFA expression (measurement model) by an additional linear specification reflecting dependencies among the latent variables (structural model). 


Remarque : ne marche pas pour les facteurs non ordonnés (en gros, considère les facteurs comme des variables numériques)

Remarque : estimator ML for ordered data is not supported yet. Use WLSMV instead.

```{r, echo=FALSE}
pauv_model_sem <- '
s =~ s_sentpauvrisque + s_infminidecla
m =~ m_quantilenivie_inv + m_locatif_inv + m_financier_inv
i =~ i_rsa +  i_chom + i_log + i_handi + i_bourse + i_hlm 
pauvrete ~ m + i + s
pauvrete =~ cov_sexe_homme
'

fit_sem <- lavaan::sem(pauv_model_sem,
                       data = bdd_CFA_rmnasup,
                       estimator = "WLSMV")

semPaths(fit_sem, what = "est", edge.label.cex = 0.7,
edge.color = 1, esize = 1, sizeMan = 4.5, asize = 2.5,
intercepts = FALSE, rotation = 4, thresholdColor = "red",
mar = c(1, 5, 1.5, 5), fade = FALSE, nCharNodes = 4)

```


## Figures rapport

```{r, echo=FALSE}
mat = cor(bdd_poLCA_small %>% na.omit(), method = "spearman")
ordre = c("m_quantilenivie_inv","m_locatif_inv","m_financier_inv","s_sentpauvrisque", "s_infminidecla", "i_rsa", "i_log","i_hlm","i_chom","i_bourse","i_handi")
seuilcroix = 0.3

mat <- mat[ordre,ordre]
#mat[lower.tri(mat)] <- NA
gg_corrplot <- cbind(
  data.frame(mat)  %>%
    rownames_to_column(var="mesure1") %>%
    pivot_longer(-mesure1, "mesure2") %>%
    mutate(mesure1 = factor(mesure1,levels = unique(mesure1)),
           mesure2 = factor(mesure2,levels = levels(mesure1)),
           mesure1 = factor(mesure1, labels=c("(-) Niveau\nde vie", "(-) Revenus\nlocatifs", "(-) Revenus\nfinanciers", "Sentiment de\npauvreté", "Difficultés\n financières\nperçues", "RSA", "APL", "HLM", "Chômage", "Bourse d'étude", "Handicap/\nDépendance")),
           mesure2 = factor(mesure2,labels=levels(mesure1))
    ),
  data.frame(ggcorrplot::cor_pmat(mat))  %>%
    rownames_to_column(var="mesure1") %>%
    pivot_longer(-mesure1, "mesure2") %>% 
    mutate(value=ifelse(value>0.05,1,2)) %>% 
    dplyr::select(value) %>% 
    setNames("signi")
)  %>% 
  mutate(label = round(value,2)) %>% 
  mutate(highval = ifelse(abs(value)>seuilcroix,2,1)) %>% 
  ggplot() + ## to get the rect filled
  geom_tile(aes(x=mesure1, y=mesure2), color="white", fill="white") +
  geom_point(aes(x=mesure1, y=mesure2, fill=value, stroke= highval),size = 5, shape=21) +
 # geom_point(aes(x=mesure1, y=mesure2, shape = highval),size = 2,color = "black")+
  labs(x = NULL, y = NULL, fill = "Corrélation Spearman") +
  theme_classic()+
  #scale_shape_manual(name=paste0("Corrélation > ",seuilcroix),values=c(4,NA), breaks=c("1","0"),labels=c("Oui","Non"))+
    continuous_scale("stroke", "stroke", name= paste0("Corrélation (val.\nabs.) > ",seuilcroix),
                   palette = function(x){scales::rescale(x, c(1, 2))},
                   breaks = c(2, 1), labels=c("Oui","Non")) +
  scale_fill_gradient(low="#FBFEF9",high="#E46726",
                        limits=c(0,1), na.value="#FFFFFF")  +
  scale_x_discrete(expand=c(0.05,0.05)) +
  scale_y_discrete(expand=c(0.05,0.05)) +
  scale_size(range=c(4,10), guide=NULL) +
  geom_rect(data=data.frame(x1=c(0.5,3.5,5.5), x2=c(3.5,5.5,11.5), y1=c(0.5,3.5,5.5), y2=c(3.5,5.5,11.5), t=c('Monétaire','Subjective','Institutionnelle')), mapping=aes(xmin=x1, xmax=x2, ymin=y1, ymax=y2, linetype=t), color="black", size=1, fill=NA) +
  scale_linetype_manual(name="Dimension de la pauvreté", breaks=c("Monétaire","Subjective","Institutionnelle"), values=c("dotted","dashed", "solid")) +
 theme(axis.text.x = element_text(angle = 45, hjust=1))  
   
saveRDS(gg_corrplot,"../rapport/figures/gg_corrplot.RDS")

gg_corrplot
 
```



```{r, echo=FALSE}
gg_loadings <- ggplot(data.frame(pauvFA2$loadings[,1:2]) %>%
                        mutate(Variable=c("Sentiment de pauvreté","Difficultés\nfinancières\nperçues","(-) Niveau de vie", "(-) Revenus locatifs", "(-) Revenus financiers", "APL", "RSA","Chômage","Handicap/Dépendance","Bourse d'étude","HLM")) %>% 
                        mutate(dimension = c(rep("Subjective",2),rep("Monétaire",3),rep("Institutionnelle",6))) %>% 
                        mutate(groupe = c(rep("Monétaire et Subjective",5),rep("Institutionnelle",6)))
                        ,aes(x=ML2,y=ML1)) +
  geom_vline(xintercept = 0, color = "black", linetype = "dotted") +
  geom_hline(yintercept = 0, color = "black", linetype = "dotted") +
  stat_ellipse(aes(fill=factor(groupe)),type = "t", linetype = 1, cex=1, geom="polygon", alpha=0.5, level=0.8) +
 geom_abline(intercept = 0, slope = 1, color="black", linetype="solid") +
  geom_point(aes(shape=factor(dimension)), color="black", cex=3) +
  ggrepel::geom_text_repel(aes(label=Variable),size=3,nudge_y=0.00)+
  ggrepel::geom_label_repel(data = data.frame(x=c(0.0719,0.673),
           y=c(0.533,0.0396)),aes(x=x,y=y), label = c("Pauvreté\ninstitutionnelle","Pauvretés monétaire\net subjective"),
           min.segment.length = 0, size=4, fontface="bold",
           nudge_x=c(0.3,0), nudge_y=c(0.3,0.4), seed=1) + 
   xlab("Saturation sur le premier facteur (20,9 %)") +
  ylab("Saturation sur le second facteur (19,2 %)") + 
  scale_fill_manual(values=c("pink","pink")) +
  scale_shape_manual(name="Dimension de la pauvreté", values=c(16,17,18))+
  guides(fill="none") +
  theme_minimal()

saveRDS(gg_loadings,"../rapport/figures/gg_loadings.RDS")

gg_loadings

# toto %>%    group_by(groupe) %>%  summarise(x=mean(ML2),y=mean(ML1))
```


```{r, echo=FALSE}
data_acm <- readRDS("../rapport/figures/data_acm.RDS")

noms_classes <- c("A","B","C.1","C.2","D.1","D.2")
palette <- c("#2166ac","#67a9cf","#9970ab","#762a83","#e9a3c9","#c51b7d")
gg_latentclass <- ggplot(
  data.frame(res.mca$ind$coord[,c(1,2)] %>% cbind(factor(result$predclass,labels=noms_classes))) %>% 
    setNames(c("Dim.1","Dim.2","typo")),
                 aes(x=Dim.1,y=Dim.2)) +
  geom_vline(xintercept = 0, color = "black", linetype = "dotted") +
  geom_hline(yintercept = 0, color = "black", linetype = "dotted") +
  stat_smooth(data=data_acm %>% filter(Type=="Active"),
              aes(x = Coord.x, y = Coord.y), method = "lm", formula = y ~ poly(x, 2), size = 1, se = FALSE, color = "grey") +
  stat_ellipse(aes(color=factor(typo),fill=factor(typo)),type = "norm", linetype = 1, cex=1, geom="polygon", alpha=0.5) +
  geom_point(aes(color=factor(typo)), cex=0.5) +
  ggrepel::geom_label_repel(data = data.frame(x=c(-0.761,-0.372,0.0629,0.198, 0.479,0.850),
           y=c(0.631,-0.0875,-0.271,0.153,-0.189,0.347)),
           aes(x=x,y=y), label = paste0('Classe ',noms_classes),
           min.segment.length = 0, size=4, fontface="bold",
           nudge_x=0,nudge_y = c(1,-0.75,-0.75,1,-0.75,1), seed=1) +
   # ggrepel::geom_text_repel(data = data.frame(x=c(-0.761,-0.372-0.2,0.0629,0.198, 0.479,0.850),
   #         y=c(0.631,-0.0875,-0.271,0.153,-0.189,0.347)),
   #          aes(x=x,y=y),
   #          label = c("Richesse","\n\nRichesse et classes\nmoyennes supérieures", "Classes moyennes 1", "Classes moyennes 2","Pauvreté 1", "Pauvreté 2"), 
   #          min.segment.length = 1000, size=3, fontface="italic",
   #          nudge_x=0, nudge_y = c(1,-0.75,-0.75,1,-0.75,1)+c(0.2,-0.2,-0.2,0.2,-0.2,0.2), seed=1) +
  # geom_segment(aes(x = 0, y = 2.5, xend = 0, yend = 3), cex=1.5,arrow = arrow(length = unit(0.5, "cm"))) + 
    # ggrepel::geom_text_repel(data = data.frame(x=c(0),
    #        y=c(2.5)), size = 3, fontface="bold",aes(x=x,y=y),
    #        angle=-90,hjust=-1,vjust=0, nudge_y = -0.1,min.segment.length = 1000,color="darkgrey",
    #        label = c("Diff. fin.\nperçues"))+
  geom_segment(aes(x = 0, y = 2, xend = 0.5, yend = 2), cex=1.5,arrow = arrow(length = unit(0.5, "cm"))) +
  ggrepel::geom_text_repel(data = data.frame(x=c(0),
           y=c(2)), size = 3, fontface="bold",aes(x=x,y=y),
           angle=0,hjust=-1,vjust=0,nudge_y=0.1,nudge_x=0,min.segment.length = 1000,
           label = c("Niveau Pauvreté"))+
  geom_segment(aes(x = 0, y = 2, xend = 0, yend = 2.5), cex=1.5,arrow = arrow(length = unit(0.5, "cm"))) + #1.5
    ggrepel::geom_text_repel(data = data.frame(x=c(0),
           y=c(2)), size = 3, fontface="bold",aes(x=x,y=y),
           angle=-90,hjust=1, vjust=0, nudge_y = 0.1,min.segment.length = 1000,color="black",
           label = c("Pauvreté\ninstitutio."))+
      # ggrepel::geom_text_repel(data = data.frame(x=c(0),
      #      y=c(2)), size = 3, fontface="bold",aes(x=x,y=y),
      #      angle=90,hjust=-1, vjust=1, nudge_y = 0,min.segment.length = 1000,color="black",
      #      label = c("Structure Pauvreté"))+
   xlab("Axe 1 de l'ACM (19,8 %)") +
  ylab("Axe 2 de l'ACM (9,6 %)") + 
  scale_color_manual(values=palette) +
  scale_fill_manual(values=palette) +
  guides(colour="none",fill="none") +
  scale_y_discrete(expand=c(0,0.75)) +
  theme_minimal()


saveRDS(gg_latentclass,"../rapport/figures/gg_latentclass.RDS")

gg_latentclass

# toto %>%    group_by(typo) %>%  summarise(x=mean(Dim.1),y=mean(Dim.2))

```


```{r, echo=FALSE, fig.width=6, fig.height=7}
x <- result
#typo <- result$predclass
gg_latentclass_bar <- do.call("rbind", 
                 lapply(1:length(x$probs), function(i){
                   df <- x$probs[[i]]
                   df <- as.table(df) #NEW
                   df <- data.frame(df)
                   df$var <- names(x$probs)[i]
                   df$typologie=noms_classes
                   return(df)
                   })
  )  %>%
  mutate(label_signe=NA) %>% 
  mutate(label_signe=ifelse(typologie%in%c("C.1","D.2") & var=="s_infminidecla","+",label_signe),
         label_signe=ifelse(typologie%in%c("C.2","D.1") & var=="s_infminidecla","–",label_signe),
       label_signe=ifelse(typologie%in%c("C.1","D.1") & substr(var,1,1)=="i","–",label_signe),
       label_signe=ifelse(typologie%in%c("C.2","D.2") & substr(var,1,1)=="i","+",label_signe),
       label_signe=ifelse(typologie=="D.1" & var=="m_quantilenivie_inv","–",label_signe),
       label_signe=ifelse(typologie=="D.2" & var=="m_quantilenivie_inv","+",label_signe)
         ) %>% 
    mutate(Var2=as.numeric(Var2)) %>%
  mutate(Var2=ifelse(var=="m_quantilenivie_inv",6-Var2,Var2)) %>% 
  mutate(Var2=ifelse(!var%in%c("s_sentpauvrisque","m_quantilenivie_inv") & Var2==1,100,Var2)) %>% 
  mutate(Var2=ifelse(!var%in%c("s_sentpauvrisque","m_quantilenivie_inv") & Var2==2,1,Var2)) %>% 
  mutate(Var2=ifelse(!var%in%c("s_sentpauvrisque","m_quantilenivie_inv") & Var2==100,5,Var2)) %>% 
  mutate(Var2=ifelse(var=="s_sentpauvrisque" & Var2==1,100,ifelse(var=="s_sentpauvrisque" & Var2==3,1,Var2))) %>% 
   mutate(Var2=ifelse(var=="s_sentpauvrisque" & Var2==100,5,Var2)) %>% 
   mutate(Var2=ifelse(var=="s_sentpauvrisque" & Var2==2,3,Var2)) %>%
   filter(var=="m_quantilenivie_inv" | Var2!=5) %>% #NEW filtre 
   mutate(Var2=factor(Var2)) %>% 
    mutate(var=factor(var,
    levels=c("m_quantilenivie_inv","m_locatif_inv","m_financier_inv","s_sentpauvrisque", "s_infminidecla", "i_rsa", "i_log", "i_hlm","i_chom","i_bourse","i_handi") ,
                      labels=c("Quintile de niveau\nde vie du ménage de\n1 (noir) à 5 (gris clair)", "Ménage recevant\ndes revenus locatifs", "Ménage recevant\ndes revenus financiers",
"Sentiment actuel (noir)\n ou de risque (gris)\nde pauvreté","Difficultés financières\nperçues",
"Ménage bénéficiaire\ndu RSA", "Ménage bénéficiaire\nd'APL","Ménage locataire\nd'un logement social","Ménage bénéficiaire\nd'allocation chômage","Ménage bénéficiaire\nde bourse d'étude", "Ménage bénéficiaire\nd'une allocation\nhandicap / dépendance")
    )) %>% mutate(typologie=factor(paste0("Classe ", typologie,                         "\n(",gsub("\\.",",",round(100*x$P,1))," %)"))) %>% 
  ggplot(aes(x=var, y=100*Freq)) +
   geom_rect(aes(fill = typologie),xmin = -Inf,xmax = Inf,ymin = -Inf,ymax = Inf) +
   annotate("rect", xmin = -Inf,xmax = Inf,ymin = -Inf,ymax = Inf, alpha=0.7, fill="white") +
 scale_fill_manual(values=palette,guide="none") +
ggnewscale::new_scale("fill") +
geom_bar(aes(fill=Var2), 
         stat="identity", color="black", width=1,
         position = position_dodge2(width = 1, preserve = "single"))+
  geom_text(aes(fill=Var2, label=round(100*Freq)), vjust=-0.2, color="black",
            position = position_dodge2(width = 1, preserve = "single"), size=3)+
    scale_fill_brewer(palette="Greys", direction=-1, guide="none") +
  theme_minimal() + 
  scale_y_continuous(breaks=c(0,20,40,60,80,100), expand = c(0, 20)) +
    labs(x = NULL, y = "Part de la population (%)") +
    facet_grid(typologie ~ .) +
    theme(axis.text.x = element_text(angle = 90,vjust = 0.5, hjust=1), 
          strip.text = element_text(face="bold")
          )+
    geom_label(aes(y=100, label=label_signe), size=4,hjust=-1, nudge_x=0.1, fill="white",color="black", label.padding=unit(0,"lines"),
               label.r=unit(0,"lines"),label.size=0)

saveRDS(gg_latentclass_bar,"../rapport/figures/gg_latentclass_bar.RDS")

gg_latentclass_bar


# questionr::cprop(table(bdd_poLCA_rmnasup$s_infminidecla,bdd_poLCA_rmnasup$m_quantilenivie_inv))

```



```{r, echo=FALSE}
tab_modfit_afc <- data.frame(rbind(
round(fitMeasures(fit1_var)[c("chisq","df","cfi","rmsea", "srmr")],3),
round(fitMeasures(fit2_var)[c("chisq","df","cfi","rmsea", "srmr")],3),
round(fitMeasures(fit3_var)[c("chisq","df","cfi","rmsea", "srmr")],3),
round(fitMeasures(fit_hier3_var)[c("chisq","df","cfi","rmsea", "srmr")],3)
)) %>% 
  mutate(chisq=round(chisq)) %>% 
  mutate(modele = paste0("Modèle ",1:4)) %>% 
  dplyr::select(c("modele","chisq","df","cfi","rmsea", "srmr")) %>%
  mutate(cfi = gsub("\\.",",",cfi)) %>% 
  mutate(rmsea = gsub("\\.",",",rmsea)) %>% 
  mutate(srmr = gsub("\\.",",",srmr)) %>% 
  setNames(c("Modèle","Chi2","Degrés de liberté","CFI","RMSEA","SRMR")) 

saveRDS(tab_modfit_afc,"../rapport/figures/tab_modfit_afc.RDS")
  
tab_modfit_afc %>%
  kable(caption="Indices d'ajustement des 4 modèles d'AFC")

```



```{r, echo=FALSE}
grviz1 <- grViz("
digraph boxes_and_circles {
  
  # a 'graph' statement
  graph [overlap = true, fontsize = 20,rankdir = LR,
  bgcolor=transparent, splines=true]
  
   node [shape = circle, width=1.5,
        fontcolor=black, fixedsize=true, fontsize=25]
   subgraph {
    rank = same;
    I [label='Institutio.'];
    M [label='Monétaire'];
    S [label='Subjectif'];
   }
   
   # liens entre facteurs
  #edge [shape = circle, alpha=1 color=black style=filled penwidth=1 arrowsize=.75 minlen=2]
  #subgraph {
    #rank = same;
  #S -> M [label = 1.03 penwidth=1.15  dir=both];
  #M -> I [label = 0.92 penwidth=1.15  dir=both];
  #S -> I [label = 0.78 penwidth=1.15  dir=both];
  #}
  
  node [shape = box, fixedsize = true,width = 3, fontsize=20]
   subgraph {
    #rank = same;
  1 [label='Sentiment de pauvreté'];
  2 [label='Diff. fin. perçues'];
  3 [label='(-) Quintile niveau de vie'];
  4 [label='(-) Revenus locatifs'];
  5 [label='(-) Revenus financiers'];
  6 [label='RSA'];
  7 [label='Chômage'];
  8 [label='APL'];
  9 [label='Hand./Dépend.'];
  10 [label='Bourse étude'];
  11 [label='HLM'];
   }
  
  # loadings
  I->6 [ label = 0.60 penwidth=1.15];
  I->7 [ label = 0.31 penwidth=1.15];
  I->8 [ label = 1.09 penwidth=1.15 color=red];
  I->9 [ label = 0.34 penwidth=1.15];
  I->10 [ label = 0.44 penwidth=1.15];
  I->11 [ label = 0.56 penwidth=1.15];
  M->3 [ label = 0.63 penwidth=1.15];
  M->4 [ label = 0.73 penwidth=1.15];
  M->5 [ label = 0.77 penwidth=1.15];
  S->1 [ label = 1.00 penwidth=1.15];
  S->2 [ label = 0.51 penwidth=1.15];
  
  # variances
  edge [shape = circle, alpha=.5 color=gray50 style=dashed penwidth=1.15 arrowsize=.75 minlen=2 dir=both]
  1:e -> 1:e [label = 1.00];
  2:e -> 2:e [label = 0.74];
  3:e -> 3:e [label = 0.60];
  4:e -> 4:e [label = 0.47];
  5:e -> 5:e [label = 0.41];
  6:e -> 6:e [label = 0.63];
  7:e -> 7:e [label = 0.90];
  8:e -> 8:e [label = -0.18  color=red];
  9:e -> 9:e [label = 0.89];
  10:e -> 10:e [label = 0.81];
  11:e -> 11:e [label = 0.68];
  S -> S [label = 1.00];
  M -> M [label = 1.00];
  I -> I [label = 1.00];

  }
", height=600, width=600)

saveRDS(grviz1,"../rapport/figures/grviz1.RDS")

grviz1
```

```{r, echo=FALSE}
grviz2 <- grViz("
digraph boxes_and_circles {
  
  # a 'graph' statement
  graph [overlap = true, fontsize = 20,rankdir = LR,
  bgcolor=transparent, splines=true]
  
   node [shape = circle, width=1.5,
        fontcolor=black, fixedsize=true, fontsize=25]
   subgraph {
    rank = same;
    I [label='Institutio.'];
    M [label='Monétaire'];
    S [label='Subjectif'];
   }
   
   # liens entre facteurs
  edge [shape = circle, alpha=1 color=black style=filled penwidth=1 arrowsize=.75 minlen=2]
  subgraph {
    #rank = same;
  S -> M [label = 1.03 penwidth=1.15  dir=both color=red];
  M -> I [label = 0.92 penwidth=1.15  dir=both];
  S -> I [label = 0.78 penwidth=1.15  dir=both];
  }
  
  node [shape = box, fixedsize = true,width = 3, fontsize=20]
   subgraph {
    #rank = same;
  2 [label='Diff. fin. perçues'];
  1 [label='Sentiment de pauvreté'];
  3 [label='(-) Quintile niveau de vie'];
  4 [label='(-) Revenus locatifs'];
  5 [label='(-) Revenus financiers'];
  6 [label='RSA'];
  7 [label='Chômage'];
  8 [label='APL'];
  9 [label='Hand./Dépend.'];
  10 [label='Bourse étude'];
  11 [label='HLM'];
   }
  
  # loadings
  I->6 [ label = 0.75 penwidth=1.15];
  I->7 [ label = 0.35 penwidth=1.15];
  I->8 [ label = 0.88 penwidth=1.15 color=red];
  I->9 [ label = 0.35 penwidth=1.15];
  I->10 [ label = 0.44 penwidth=1.15];
  I->11 [ label = 0.66 penwidth=1.15];
  M->3 [ label = 0.85 penwidth=1.15 color=red];
  M->4 [ label = 0.59 penwidth=1.15];
  M->5 [ label = 0.60 penwidth=1.15];
  S->1 [ label = 0.67 penwidth=1.15];
  S->2 [ label = 0.76 penwidth=1.15 color=red];
  
  # variances
  edge [shape = circle, alpha=.5 color=gray50 style=dashed penwidth=1.15 arrowsize=.75 minlen=2 dir=both]
1:e -> 1:e [label = 0.55];
  2:e -> 2:e [label = 0.42];
  3:e -> 3:e [label = 0.28];
  4:e -> 4:e [label = 0.65];
  5:e -> 5:e [label = 0.63];
  6:e -> 6:e [label = 0.44];
  7:e -> 7:e [label = 0.88];
  8:e -> 8:e [label = 0.23];
  9:e -> 9:e [label = 0.87];
  10:e -> 10:e [label = 0.81];
  11:e -> 11:e [label = 0.57];
  S -> S [label = 1.00];
  M -> M [label = 1.00];
  I -> I [label = 1.00];

  }
", height=600, width=600)

saveRDS(grviz2,"../rapport/figures/grviz2.RDS")

grviz2
```

```{r, echo=FALSE}
grviz3 <- grViz("
digraph boxes_and_circles {
  
  # a 'graph' statement
  graph [overlap = true, fontsize = 20,rankdir = LR,
  bgcolor=transparent, splines=true]
  
   node [shape = circle, width=1.5,
        fontcolor=black, fixedsize=true, fontsize=25]
   subgraph {
    rank = same;
    I [label='Institutio.'];
    M [label='Monétaire'];
    S [label='Sentiment\nde\npauvreté' shape = square];
   }
   
   # liens entre facteurs
  edge [shape = circle, alpha=1 color=black style=filled penwidth=1 arrowsize=.75 minlen=2]
  subgraph {
    #rank = same;
  S -> M [label = 0.66 penwidth=1.15  dir=both];
  M -> I [label = 0.93 penwidth=1.15  dir=both];
  S -> I [label = 0.59 penwidth=1.15  dir=both];
  }
  
  node [shape = box, fixedsize = true,width = 3, fontsize=20]
   subgraph {
    #rank = same;
  #2 [label='Diff. fin. perçues'];
  #1 [label='Sentiment de pauvreté'];
  3 [label='(-) Quintile niveau de vie'];
  4 [label='(-) Revenus locatifs'];
  5 [label='(-) Revenus financiers'];
  6 [label='RSA'];
  7 [label='Chômage'];
  8 [label='APL'];
  9 [label='Hand./Dépend.'];
  10 [label='Bourse étude'];
  11 [label='HLM'];
   }
  
  # loadings
  I->6 [ label = 0.74 penwidth=1.15];
  I->7 [ label = 0.35 penwidth=1.15];
  I->8 [ label = 0.89 penwidth=1.15];
  I->9 [ label = 0.35 penwidth=1.15];
  I->10 [ label = 0.44 penwidth=1.15];
  I->11 [ label = 0.65 penwidth=1.15];
  M->3 [ label = 0.83 penwidth=1.15];
  M->4 [ label = 0.61 penwidth=1.15];
  M->5 [ label = 0.61 penwidth=1.15];
  #S->1 [ label = 0.67 penwidth=1.15];
  #S->2 [ label = 0.76 penwidth=1.15];
  
  # variances
  edge [shape = circle, alpha=.5 color=gray50 style=dashed penwidth=1.15 arrowsize=.75 minlen=2 dir=both]
  #1:e -> 1:e [label = 0.55];
  #2:e -> 2:e [label = 0.42];
  3:e -> 3:e [label = 0.31];
  4:e -> 4:e [label = 0.63];
  5:e -> 5:e [label = 0.63];
  6:e -> 6:e [label = 0.45];
  7:e -> 7:e [label = 0.88];
  8:e -> 8:e [label = 0.22];
  9:e -> 9:e [label = 0.87];
  10:e -> 10:e [label = 0.80];
  11:e -> 11:e [label = 0.58];
  S -> S [label = 1.00];
  M -> M [label = 1.00];
  I -> I [label = 1.00];

  }
", width=600,height=600)

saveRDS(grviz3,"../rapport/figures/grviz3.RDS")

grviz3
```


```{r, echo=FALSE}
tab_covariates_inter_cfa <- sum2$PE %>% 
  filter(op=="~" & substr(rhs,1,3)=="cov") %>% 
  mutate(variable=gsub("cov_","",rhs),
         pvaleur=cut(pvalue, breaks = c(0, 0.001, 0.01, 0.05, 1),
                                      include.lowest = TRUE,
                                      labels = c('***', '**', '*', '')),
         estimateur=paste0(round(est,2),pvaleur) 
         ) %>% 
  dplyr::select(lhs,variable,estimateur) %>%
  pivot_wider(
    names_from = lhs,
    values_from = estimateur
  ) %>% dplyr::right_join(
    data.frame(variable = c("prof_statut_act_agri", "prof_statut_act_commer", "prof_statut_act_cadre", "prof_statut_act_inter", "prof_statut_act_employ", "prof_statut_act_ouv", "prof_statut_act_chom",
"prof_statut_act_retr", "prof_statut_act_foyer", "prof_statut_act_autrinac", "diplome_sans","diplome_bac", "diplome_bacplus2", "diplome_bacplus3", "age_tranche_1829","age_tranche_3039",
 "age_tranche_4049", "age_tranche_5059", "age_tranche_6069", "age_tranche_70", "vie_fam_seul", "vie_fam_coupsansenf", "vie_fam_coupenf",
 "vie_fam_mono", "vie_fam_enf", "vie_fam_autre","sexe_femme", "sexe_homme"),
	   libelle_mod = c("Agriculteur", "Artisan commerçant", "Cadre supérieur, profession libérale", "Profession intermédiaire", "Employé", "Ouvrier", "Chômeur", "Retraité",
"Au foyer", "Autre inactif", "CAP, BEP ou moins", "Baccalauréat", "Bac + 2", "Bac + 3 ou plus", "18 à 29 ans", "30 à 39 ans", "40 à 49 ans", "50 à 59 ans",
 "60 à 69 ans", "70 ans et plus", "Vit seul", "Membre du couple (pas d’enfants à charge)", "Membre du couple (enfants à charge)",
 "Chef famille monoparentale", "Enfant", "Autre situation familiale", "Femme", "Homme"),
           libelle_var=c("Situation professionnelle",rep("",9),"Niveau de diplôme le plus élevé",rep("",3), "Classe d'âge",rep("",5),"Situation familiale",rep("",5),"Sexe",rep("",1))
) ,
    by="variable") %>% 
     arrange(match(variable,c("prof_statut_act_agri", "prof_statut_act_commer", "prof_statut_act_cadre", "prof_statut_act_inter", "prof_statut_act_employ", "prof_statut_act_ouv", "prof_statut_act_chom",
"prof_statut_act_retr", "prof_statut_act_foyer", "prof_statut_act_autrinac", "diplome_sans","diplome_bac", "diplome_bacplus2", "diplome_bacplus3", "age_tranche_1829","age_tranche_3039",
 "age_tranche_4049", "age_tranche_5059", "age_tranche_6069", "age_tranche_70", "vie_fam_seul", "vie_fam_coupsansenf", "vie_fam_coupenf",
 "vie_fam_mono", "vie_fam_enf", "vie_fam_autre","sexe_femme", "sexe_homme"))) %>% 
  #dplyr::select(libelle_var,libelle_mod,m,i,s) %>%
  dplyr::select(libelle_var,libelle_mod,m,i,s_sentpauvrisque_std) %>%
  replace(is.na(.), "Réf.") %>% 
#  setNames(c("","Pauvreté...","Monétaire","Institutionnelle","Subjective"))
  setNames(c("","Pauvreté...","Monétaire","Institutionnelle","Sentiment de pauvreté"))


saveRDS(tab_covariates_inter_cfa,"../rapport/figures/tab_covariates_inter_cfa.RDS")

tab_covariates_inter_cfa %>% 
  kable(caption="Effets des covariables sur les différentes dimensions de la pauvreté", booktabs = TRUE, longtable = TRUE) %>%
   kableExtra::column_spec(1, width = "4cm") %>%
   kableExtra::column_spec(2, width = "5cm") %>%
   kableExtra::column_spec(3:5, width = "2cm") %>%
  kableExtra::kable_styling(
  latex_options = c("hold_position", "repeat_header"),
  repeat_header_text = "\\textit{(suite)}",
  repeat_header_continued = "\\textit{(suite en page suivante...)}"
  ) %>%
  kableExtra::footnote("* : significatif au seuil de 5 % ; ** : 1 % ; *** : 0,1 %.")



```

```{r, echo=FALSE}
tab_radar <- sum2$PE %>% 
  filter(op=="~" & substr(rhs,1,3)=="cov") %>% 
  mutate(variable=gsub("cov_","",rhs),
         pvaleur=cut(pvalue, breaks = c(0, 0.001, 0.01, 0.05, 1),
                     include.lowest = TRUE,
                     labels = c('***', '**', '*', '')),
         estimateur=paste0(round(est,2),pvaleur) 
  ) %>%  dplyr::select(lhs,variable,est) %>%
  rbind(subset(., lhs == "i")) %>% 
  mutate(lhs=toupper(lhs)) %>% 
  mutate(lhs=ifelse(lhs=="S_SENTPAUVRISQUE_STD","SP",lhs)) #NEW

coord_radar <- 
  function(theta='x', start=0, direction=1){
    match.arg(theta, c('x','y'))
    ggproto(
      NULL, CoordPolar, 
      theta=theta, r=ifelse(theta=='x','y','x'),
      start=start, direction=sign(direction),
      is_linear=function() TRUE)
  }

variables_gardees <- c("vie_fam_coupsansenf","vie_fam_coupenf",
                       "vie_fam_seul", "vie_fam_mono",
                  "prof_statut_act_inter", "prof_statut_act_ouv",
                  "prof_statut_act_chom","prof_statut_act_foyer",
                  "age_tranche_3039","age_tranche_1829","age_tranche_70")
variable.labs <-  c("Couple sans enf. (Réf.)","Couple avec enf.","Vit seul","Famille monop.","Prof. inter (Réf.)", "Ouvier","Chômeur","Au foyer","30-39 ans (Réf.)","18-29 ans","70 ans et + ")
names(variable.labs) <- variables_gardees
  
gg_radar <- ggplot(data=tab_radar %>% 
         filter(variable%in%variables_gardees) %>% 
           add_row(lhs=rep(c("I","SP","M"),3),
                   variable=c(rep("vie_fam_coupsansenf",3),rep("prof_statut_act_inter",3),rep("age_tranche_3039",3)),
                   est=rep(0,3*3)) %>% 
           mutate(variable=factor(variable,levels=variables_gardees,
                                  labels=variable.labs)),
       aes(x=lhs, y=est, group=variable)) +  # colour=variable
  #geom_path(data=data.frame(lhs=c("I","S","M","S","I","M"),
  geom_path(data=data.frame(lhs=c("I","SP","M","SP","I","M"),
                            est=rep(0,6)), group=NA,colour="black",size=1,linetype="solid")  +
  geom_point(size=1) + 
  geom_path(color="red") +
  coord_radar() +
  theme_bw() +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.x = element_blank()) + 
  facet_wrap(~ variable, nrow=3)  #,labeller = labeller(variable = variable.labs)

gg_radar

saveRDS(gg_radar,"../rapport/figures/gg_radar.RDS")

```

```{r, echo=FALSE}
grviz4 <- grViz("
digraph boxes_and_circles {
  
  # a 'graph' statement
  graph [overlap = true, fontsize = 20,rankdir = LR,
  bgcolor=transparent, splines=true]
  
   node [shape = circle, width=1.5,
        fontcolor=black, fixedsize=true, fontsize=25]
   subgraph {
    rank = same;
    P [label='Pauvreté'];
    }
   subgraph {
    rank = same;
    S [label='Sentiment\nde\npauvreté' shape = square];
    M [label='Monétaire'];
    I [label='Institutio.'];
   }
   
  
  node [shape = box, fixedsize = true,width = 3, fontsize=20]
   subgraph {
  3 [label='(-) Quintile niveau de vie'];
  4 [label='(-) Revenus locatifs'];
  5 [label='(-) Revenus financiers'];
  6 [label='RSA'];
  7 [label='Chômage'];
  8 [label='APL'];
  9 [label='Hand./Dépend.'];
  10 [label='Bourse étude'];
  11 [label='HLM'];
   }
  
  # loadings
  I->6 [ label = 0.74 penwidth=1.15];
  I->7 [ label = 0.35 penwidth=1.15];
  I->8 [ label = 0.88 penwidth=1.15];
  I->9 [ label = 0.35 penwidth=1.15];
  I->10 [ label = 0.44 penwidth=1.15];
  I->11 [ label = 0.65 penwidth=1.15];
  M->3 [ label = 0.83 penwidth=1.15];
  M->4 [ label = 0.60 penwidth=1.15];
  M->5 [ label = 0.60 penwidth=1.15];
  P -> S [label = 0.65 penwidth=2.5];
  P -> I [label = 0.93 penwidth=2.5];
  P -> M [label = 1.00 penwidth=2.5];
  
  # variances
  edge [shape = circle, alpha=.5 color=gray50 style=dashed penwidth=1.15 arrowsize=.75 minlen=2 dir=both]
  3:e -> 3:e [label = 0.28];
  4:e -> 4:e [label = 0.63];
  5:e -> 5:e [label = 0.63];
  6:e -> 6:e [label = 0.45];
  7:e -> 7:e [label = 0.88];
  8:e -> 8:e [label = 0.22];
  9:e -> 9:e [label = 0.87];
  10:e -> 10:e [label = 0.80];
  11:e -> 11:e [label = 0.58];
  S -> S [label = 0.58];
  M -> M [label = 0.03];
  I -> I [label = 0.15];
  P -> P [label = 1.00];


  }
", width=600,height=600)

saveRDS(grviz4,"../rapport/figures/grviz4.RDS")

grviz4
```


```{r, echo=FALSE}
tab_covariates_global_cfa <- sum$PE %>% 
  filter(op=="~" & substr(rhs,1,3)=="cov") %>% 
  mutate(variable=gsub("cov_","",rhs),
         pvaleur=cut(pvalue, breaks = c(0, 0.001, 0.01, 0.05, 1),
                                      include.lowest = TRUE,
                                      labels = c('***', '**', '*', '')),
         estimateur=paste0(round(est,2),pvaleur) 
         ) %>% arrange(desc(abs(est))) %>% 
  dplyr::select(lhs,variable,estimateur) %>%
  pivot_wider(
    names_from = lhs,
    values_from = estimateur
  ) %>% dplyr::left_join(
    data.frame(variable = c("prof_statut_act_agri", "prof_statut_act_commer", "prof_statut_act_cadre", "prof_statut_act_inter", "prof_statut_act_employ", "prof_statut_act_ouv", "prof_statut_act_chom",
"prof_statut_act_retr", "prof_statut_act_foyer", "prof_statut_act_autrinac", "diplome_sans","diplome_bac", "diplome_bacplus2", "diplome_bacplus3", "age_tranche_1829","age_tranche_3039",
 "age_tranche_4049", "age_tranche_5059", "age_tranche_6069", "age_tranche_70", "vie_fam_seul", "vie_fam_coupsansenf", "vie_fam_coupenf",
 "vie_fam_mono", "vie_fam_enf", "vie_fam_autre","sexe_femme", "sexe_homme"),
	   libelle_mod = c("Agriculteur", "Artisan commerçant", "Cadre supérieur, profession libérale", "Profession intermédiaire", "Employé", "Ouvrier", "Chômeur", "Retraité",
"Au foyer", "Autre inactif", "CAP, BEP ou moins", "Baccalauréat", "Bac + 2", "Bac + 3 ou plus", "18 à 29 ans", "30 à 39 ans", "40 à 49 ans", "50 à 59 ans",
 "60 à 69 ans", "70 ans et plus", "Vit seul", "Membre du couple (pas d’enfants à charge)", "Membre du couple (enfants à charge)",
 "Chef famille monoparentale", "Enfant", "Autre situation familiale", "Femme", "Homme"),
           libelle_var=c("Situation professionnelle",rep("",9),"Niveau de diplôme le plus élevé",rep("",3), "Classe d'âge",rep("",5),"Situation familiale",rep("",5),"Sexe",rep("",1))
) ,
    by="variable")  %>% 
  dplyr::select(libelle_mod,pauvrete) %>%
  setNames(c("","Effet sur l'indice global de pauvreté"))


saveRDS(tab_covariates_global_cfa,"../rapport/figures/tab_covariates_global_cfa.RDS")

tab_covariates_global_cfa %>% 
  kable(caption="Effets des covariables sur l'indice global de pauvreté", booktabs = TRUE, longtable = TRUE) %>%
   kableExtra::column_spec(1, width = "5cm") %>%
   kableExtra::column_spec(2, width = "5cm") %>%
  kableExtra::kable_styling(
  latex_options = c("hold_position", "repeat_header"),
  repeat_header_text = "\\textit{(suite)}",
  repeat_header_continued = "\\textit{(suite en page suivante...)}"
  ) %>%
  kableExtra::footnote("* : significatif au seuil de 5 % ; ** : 1 % ; *** : 0,1 %.")


```


 


# Notes méthodologiques

Pour ces modèles cinq vagues du Baromètre ont été empilées : 2015, 2016, 2017, 2018 et 2019 (15 137 observations). Le nombre d'observations utilisées est différent dans chaque modèle, il s'agit uniquement des individus où toutes les variables utilisées dans les modèles sont renseignées (voir notes en bas des tableaux).

# Bibliographie {.unnumbered}

- https://stats.idre.ucla.edu/spss/seminars/efa-spss/  https://support.sas.com/resources/papers/proceedings/proceedings/sugi30/203-30.pdf https://community.jmp.com/t5/JMP-Blog/Principal-components-or-factor-analysis/ba-p/38347 bases de l'EFA
- En bouquins : https://books.google.es/books?hl=fr&lr=&id=qKrumJ4CsboC&oi=fnd&pg=PT180&ots=TDmmzvQP5X&sig=7gFjzxbPC49Tz7IkGT-4gXMzx8U&redir_esc=y#v=onepage&q&f=false et slides https://slideplayer.com/slide/5080/
- https://m-clark.github.io/posts/2020-04-10-psych-explained/
- https://cran.r-project.org/web/packages/psychTools/vignettes/factor.pdf
- https://rstudio-pubs-static.s3.amazonaws.com/363499_73a1c1a94da148b6ad81e6eb8dc1b771.html
- https://en.wikipedia.org/wiki/Factor_analysis
- Analyse en facteurs communs et spécifiques docs en Français. https://www.rocq.inria.fr/axis/modulad/archives/numero-37/Chaventetal-37/Chaventetal-37.pdf  http://grumlidesforets.free.fr/cours%20psycho/M1%20psycho/chapitre2/chapitre2.pdf http://jeanalain.monfort.free.fr/Dicostat2005/A/Analyse_en_facteurs_communs_etc.pdf https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=&ved=2ahUKEwjX-NWssbbxAhUNxoUKHXMzBxEQFnoECAkQAA&url=http%3A%2F%2Fwww.normalesup.org%2F~carpenti%2FNotes%2FAnalyse-factorielle%2FAnalyse-Factorielle-2011.doc&usg=AOvVaw04RFWMowmry0JRVMNZqR7h  http://jeanalain.monfort.free.fr/Dicostat2005/A/Analyse_en_facteurs_communs_etc.pdf https://www.psychometrie.jlroulin.fr/cours/aide_quizz.html?H.html  https://www.persee.fr/doc/hism_0982-1783_1997_num_12_3_1544 http://psychologie.psyblogs.net/2012/01/cours-theories-de-lintelligence-en.html
- 23/07 : https://s3.amazonaws.com/assets.datacamp.com/production/course_6419/slides/chapter3.pdf https://stats.stackexchange.com/questions/448204/sem-model-in-lavaan-cant-compute-standard-errors https://www.researchgate.net/post/Is_it_possible_to_extract_a_score_for_all_observations_of_a_latent_variable_after_confirmatory_factor_analysis_If_yes_how